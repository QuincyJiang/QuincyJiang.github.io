<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    
    <title>QuincyJiang</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="website">
<meta property="og:title" content="QuincyJiang">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="QuincyJiang">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="QuincyJiang">
    

    

    
        <link rel="icon" href="/css/images/avatar.png" />
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">QuincyJiang</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/avatar.png" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile" class="profile-fixed">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/avatar.png" />
            <h2 id="name">QuincyJiang</h2>
            <h3 id="title">Coder &amp; FilmPlayer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Guangzhou, China</span>
            <a id="follow" target="_blank" href="https://github.com/QuincyJiang">FOLLOW</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                15
                <span>posts</span>
            </div>
            <div class="article-info-block">
                21
                <span>tags</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="https://github.com/QuincyJiang" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://weibo.com/2425393311/" target="_blank" title="weibo" class=tooltip>
                            <i class="fa fa-weibo"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="http://aquencyua11.lofter.com/" target="_blank" title="photo" class=tooltip>
                            <i class="fa fa-photo"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-AnimatedVectorDrawable 总结" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/05/10/AnimatedVectorDrawable 总结/">AnimatedVectorDrawable总结</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/05/10/AnimatedVectorDrawable 总结/">
            <time datetime="2018-05-09T16:51:50.000Z" itemprop="datePublished">2018-05-10</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/CoolUI/">CoolUI</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/AnimatedVectorDrawable/">AnimatedVectorDrawable</a>, <a class="tag-link" href="/tags/句柄animation/">句柄animation</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>我们在更新Android N之后 可能会注意到状态栏上的快捷方式 当我们点击的时候，从开启到关闭状态，会有一个顺滑自然的过渡动画，在学习完AnimatinVectorDrawable的api用法之后，你就会知道该怎么实现这些类似的效果了。</p>
<h2 id="Vector"><a href="#Vector" class="headerlink" title="Vector"></a>Vector</h2><p>在开始之前，想先说明一下安卓中的矢量图标文件<strong>Vector</strong><br>，我们经常会用到矢量图，将一张SVG的图片通过AS自动生成一个以vector为根节点的xml文件，可以直接通过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">R.drawable.xx</span><br></pre></td></tr></table></figure></p>
<p>的格式引用它。矢量图形不管我们如何拉伸都不会模糊，因此广受开发者青睐。<br>看一下一个典型的<strong>vector</strong>文件结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;vector android:height=&quot;24dp&quot; </span><br><span class="line">android:viewportHeight=&quot;24dp&quot;</span><br><span class="line">    android:viewportWidth=&quot;24&quot; </span><br><span class="line">    android:width=&quot;24&quot; </span><br><span class="line">    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;</span><br><span class="line">    &lt;path </span><br><span class="line">        android:fillColor=&quot;#36ab60&quot; </span><br><span class="line">        android:pathData=&quot;M6.4,6.4 L17.6,17.6 M6.4,17.6 L17.6 ,6.4&quot;</span><br><span class="line">        android:strokeWidth=&quot;2&quot;</span><br><span class="line">        android:strokeColor=&quot;#999&quot;</span><br><span class="line">        android:trimPathStart=&quot;0.1&quot;</span><br><span class="line">        android:trimPathEnd=&quot;0.9&quot;/&gt;</span><br><span class="line">&lt;/vector&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>heigit/width: 图片的宽高</li>
<li>viewportWidth/viewportHeight: 画布宽高，也是必填的，定义Path路径的时候就必须在这个画布大小里去绘制，超出画布就显示不出来了。</li>
<li>path 绘制路径 主要理解几个字母代表的意思</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">M：MOVE 将画笔移动到该点</span><br><span class="line">L: LINE 直线连接到该点</span><br><span class="line">C: CURVE  曲线连接到该点</span><br><span class="line">Z: CLOSE  闭合曲线</span><br></pre></td></tr></table></figure>
<ul>
<li>strokeWidth: 线的粗细</li>
<li>trimPathStart: 绘制线段起始点偏移的百分比 </li>
<li>这么说起来其实有点抽象，用一张图来解释会更加直观一些<br><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/A201CE3001F34F0E93FA08F8F18FB8D9/3433" alt="image"></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android:trimPathStart=&quot;0&quot;</span><br><span class="line">android:trimPathEnd=&quot;1&quot;/&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/437E587CB9704EDF953BFE1F60CDD79F/3436" alt="image"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android:trimPathStart=&quot;0&quot;</span><br><span class="line">android:trimPathEnd=&quot;0.75&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/073C2DBFC90C4B959DE5BB2CA7343E7F/3434" alt="image"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android:trimPathStart=&quot;0.5&quot;</span><br><span class="line">android:trimPathEnd=&quot;0.75&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/FA0FF500CEAD4F5EA9B19DFC8430BF14/3435" alt="image"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">android:trimPathStart=&quot;0.25&quot;</span><br><span class="line">android:trimPathEnd=&quot;0.75&quot;</span><br><span class="line">android:trimPathOffset=&quot;0.25&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/58466D2A0A82463C8BB0AA3C7FCF715C/3438" alt="image"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">android:trimPathStart=&quot;0.25&quot;</span><br><span class="line">android:trimPathEnd=&quot;0.75&quot;</span><br><span class="line">android:trimPathOffset=&quot;0.375&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p>其实这几张图片连在一起看，你会发现只要将这几个数值重复循环，这就成了一个进度条动画了。<br>下面正式讲解文章主角 </p>
<h2 id="AnimatedVectorDrawable"><a href="#AnimatedVectorDrawable" class="headerlink" title="AnimatedVectorDrawable"></a>AnimatedVectorDrawable</h2><p>听名字其实可以猜到，它主要是靠两个东西来实现的</p>
<ul>
<li>ObjectAnimation<blockquote>
<p>属性动画：<br>不用于补间动画，属性动画是直接对view的属性值进行动态、更改，不再只是一种视觉上的动画效果了。它实际上是一种不断地对值进行操作的机制，并将值赋值到指定对象的指定属性上，可以是任意对象的任意属性。关于属性动画的具体介绍不在本文重点，可以参考郭林的博客，<a href="https://blog.csdn.net/guolin_blog/article/details/43536355" target="_blank" rel="noopener">属性动画完全解析</a></p>
</blockquote>
</li>
<li>VectorDrawable<blockquote>
<p>矢量图型，上文已经介绍过，不再详述</p>
</blockquote>
</li>
</ul>
<h4 id="创建一个AnimatedVectorDrawable"><a href="#创建一个AnimatedVectorDrawable" class="headerlink" title="创建一个AnimatedVectorDrawable"></a>创建一个AnimatedVectorDrawable</h4><h5 id="定义一个vectorDrawable"><a href="#定义一个vectorDrawable" class="headerlink" title="定义一个vectorDrawable"></a>定义一个vectorDrawable</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:drawable=&quot;@drawable/foo&quot;</span><br></pre></td></tr></table></figure>
<h4 id="创建一个animation"><a href="#创建一个animation" class="headerlink" title="创建一个animation"></a>创建一个animation</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;ObjectAnimator</span><br><span class="line">    android:propertyName=&quot;rotation&quot;</span><br><span class="line">    android:valueFrom=&quot;0&quot;</span><br><span class="line">    android:valueTo=&quot;180&quot;</span><br><span class="line">    android:duration=&quot;200&quot;</span><br><span class="line">    android:interpolator=&quot;@interpolator/...&quot;</span><br><span class="line">    android:valueType=&quot;floatVaule&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>valueFrom</li>
<li>valueTo </li>
<li>propertyName: 要进行变换的属性值<br>该值有以以下几种取值 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Paths:(support-library 25.3以上 支持变换path数据)</span><br><span class="line">Color:</span><br><span class="line">Opacity:</span><br><span class="line">Trim start /end /offset</span><br><span class="line">Path:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Groups:</span><br><span class="line">Translate:</span><br><span class="line">Scale:</span><br><span class="line">Rotate:</span><br></pre></td></tr></table></figure>
<h3 id="paths分组下"><a href="#paths分组下" class="headerlink" title="paths分组下"></a>paths分组下</h3><p>我们可以对颜色 不透明度 起始点偏移量 还有path元数据进行变换</p>
<h4 id="动画1"><a href="#动画1" class="headerlink" title="动画1"></a>动画1</h4><p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/36520B59B24E40309D3F34AA4925F3A1/3505" alt="image"></p>
<p>这是通过动态变换paths分组下的start end的偏移位置，做到x变为对号，同时通过groups分组下的<br>translate 来动态改变位置图像在变化前后还保持中心位置</p>
<p>其实通过trim属性，我们可以做到更多炫酷的动画效果，可以先看下面这个动画</p>
<p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/1AD156AC9EFE4D7BAA9CB4E3EF8D04E4/3520" alt="image"></p>
<p>它的完整路径其实是这样的</p>
<p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/D1E2710E1D8146ECBBE830E7A12B6FF1/3523" alt="image"></p>
<p>只是通过变换trim的值，让其部分不可见便实现了上述效果</p>
<h3 id="动画2"><a href="#动画2" class="headerlink" title="动画2"></a>动画2</h3><p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/AA8F9653DD2E477EAA021A2FCC4098A9/3577" alt="image"></p>
<p>本质是将碎裂的心分为两组图片，心的填充颜色默认为白色，点击填充是更改了透明度opacity，裂开的动画是使用groups中的rotation动画</p>
<h2 id="Path-Morphing"><a href="#Path-Morphing" class="headerlink" title="Path Morphing"></a>Path Morphing</h2><p>我们还可以直接对path元数据进行变换 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;ObjectAnimator</span><br><span class="line">    android:propertyName=&quot;pathData&quot;</span><br><span class="line">    android:valueFrom=&quot;M6.4,6.4 L17.6,17.6 M6.4,17.6 L17.6 ,6.4&quot;</span><br><span class="line">    android:valueTo=&quot;M6,10 L4,10 ...&quot;</span><br><span class="line">    android:duration=&quot;200&quot;</span><br><span class="line">    android:valueType=&quot;pathType&quot;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p><strong>但进行path变换的前提是</strong><br><strong>前后两条path路径 他们的绘制点数量和绘制命令必须是相同的<br>就比如上面代码中 变换前是4个点 变换后也必须是四个点 而且 m l m l 的顺序不可以改变</strong></p>
<p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/BFFB93AAA87E44B8A9B4A5CA7208BBA6/3579" alt="image"></p>
<p>上面这种 两个正方形 大小变了 形状没变，我们可以选定点的四个点作为变换参考点，只需要改变下四个点的前后坐标就可以了，绘制流程是不变的，符合要求，但如果变换前后是这样的呢？<br><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/61824E98C71D434E922CF7AEE414E4C1/3581" alt="image"></p>
<p>圆是没有顶点的，这时候只能变通一下，这样来选择四个点，同时要将连接点与点之间的命令由L （直线）改为C（曲线），这样可以通过控制贝塞尔曲线的控制点坐标，达到绘制圆弧和直线的效果。<br>你可以通过设置更多的控制点 来达到更顺滑的变换效果</p>
<p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/A2A9FA92731B4B9CA42B965207475945/3583" alt="image"></p>
<p>进行path变换 因为要操作控制点坐标，也带来了下面几个问题</p>
<h4 id="1-无法精确获取点的坐标"><a href="#1-无法精确获取点的坐标" class="headerlink" title="1.无法精确获取点的坐标"></a>1.无法精确获取点的坐标</h4><p>我们绘制的矢量图 一般用的是sketch之类的软件，<br>它并不能让我们直接选择变换的点，比如上面的圆，只能得到一个半径和圆心坐标，无法精准的获取四个或者更多控制点的坐标</p>
<h4 id="2-点与点之间无法重叠"><a href="#2-点与点之间无法重叠" class="headerlink" title="2.点与点之间无法重叠"></a>2.点与点之间无法重叠</h4><h4 id="3-不能直观的看到动画中间状态的样子"><a href="#3-不能直观的看到动画中间状态的样子" class="headerlink" title="3.不能直观的看到动画中间状态的样子"></a>3.不能直观的看到动画中间状态的样子</h4><p>有时候点选择的不合理，会导致变换中间产生一些非常奇怪的形状，类似sketch之类的设计工具并不能直观看到变化中间态的样子</p>
<p>幸运的是 有个工具可以很好解决上述的三个问题</p>
<p>是一个在线预览工具，<a href="https://shapeshifter.design/" target="_blank" rel="noopener">shapeshafter</a></p>
<p>官方的详细介绍 <a href="http://www.androiddesignpatterns.com/2016/11/introduction-to-icon-animation-techniques.html" target="_blank" rel="noopener">在这里</a><br>我这边以创建一个-号到+号的变换动画为例，简单介绍下用法</p>
<h5 id="1-上传两张svg图片"><a href="#1-上传两张svg图片" class="headerlink" title="1. 上传两张svg图片"></a>1. 上传两张svg图片</h5><p>分别表示的是变换前，变换后<br><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/WEBRESOURCE3158c893d5e0815abb83b97b2b4def10/3588" alt="image"></p>
<h4 id="2-复制第二个涂层的pathdata后，删除该图层"><a href="#2-复制第二个涂层的pathdata后，删除该图层" class="headerlink" title="2.复制第二个涂层的pathdata后，删除该图层"></a>2.复制第二个涂层的pathdata后，删除该图层</h4><p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/WEBRESOURCE060f9ae7adf7ce1c99f4c524c29d86fd/3589" alt="image"></p>
<p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/WEBRESOURCE61d5eb6a60bea13e3c6a8aef6bc538e2/3590" alt="image"></p>
<h4 id="3-调整第一张图，选择要变换的数据是pathdata，并将变化后-也即第二张图的pathdata-粘贴进去"><a href="#3-调整第一张图，选择要变换的数据是pathdata，并将变化后-也即第二张图的pathdata-粘贴进去" class="headerlink" title="3. 调整第一张图，选择要变换的数据是pathdata，并将变化后 也即第二张图的pathdata 粘贴进去"></a>3. 调整第一张图，选择要变换的数据是pathdata，并将变化后 也即第二张图的pathdata 粘贴进去</h4><p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/WEBRESOURCEb4fda6557ac02bfd5d6ac837eb1fe426/3593" alt="image"></p>
<p>这时候因为“+”和“-”的节点数不一致，会报错提示，可以点击修改pathdata 按钮去手动删减增加一些节点数据</p>
<p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/WEBRESOURCE72cbd215442bfa5a09c6f4dedffa16d8/3596" alt="image"></p>
<h4 id="4-妥善选择好前后的节点位置，就可以点击下方播放按钮直观查看变化效果了，不满意可以修改节点，知道达到预期目标。"><a href="#4-妥善选择好前后的节点位置，就可以点击下方播放按钮直观查看变化效果了，不满意可以修改节点，知道达到预期目标。" class="headerlink" title="4.妥善选择好前后的节点位置，就可以点击下方播放按钮直观查看变化效果了，不满意可以修改节点，知道达到预期目标。"></a>4.妥善选择好前后的节点位置，就可以点击下方播放按钮直观查看变化效果了，不满意可以修改节点，知道达到预期目标。</h4><hr>
<blockquote>
<p>待续</p>
<p>—————–18.5.9</p>
</blockquote>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2018/05/10/AnimatedVectorDrawable 总结/" data-id="cjgzcn7pl00016x0c9y0b5mvs" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2018/05/10/AnimatedVectorDrawable 总结/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2018/05/10/AnimatedVectorDrawable 总结/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Rxjava2操作符" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/04/12/Rxjava2操作符/">Rxjava2操作符</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/04/12/Rxjava2操作符/">
            <time datetime="2018-04-12T12:20:50.000Z" itemprop="datePublished">2018-04-12</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/android/">android</a>, <a class="tag-link" href="/tags/rxjava2/">rxjava2</a>, <a class="tag-link" href="/tags/开源框架/">开源框架</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="Rxjava2-操作符"><a href="#Rxjava2-操作符" class="headerlink" title="Rxjava2 操作符"></a>Rxjava2 操作符</h2><ul>
<li><h3 id="Create"><a href="#Create" class="headerlink" title="Create"></a>Create</h3><strong>create</strong>操作符，主要用于产生一个 <strong>Obserable</strong> 被观察者对象，因为<strong>Observable</strong>主要用于发射事件，<strong>Observer</strong>主要用于消费时间，所以以后统一把被观察者 <strong>Observable</strong> 称为发射器（上游事件），观察者 <strong>Observer</strong> 称为接收器（下游事件）。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">Observable.create(<span class="keyword">new</span> ObservableOnSubscribe&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(@NonNull ObservableEmitter&lt;Integer&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                mRxOperatorsText.append(<span class="string">"Observable emit 1"</span> + <span class="string">"\n"</span>);</span><br><span class="line">                Log.e(TAG, <span class="string">"Observable emit 1"</span> + <span class="string">"\n"</span>);</span><br><span class="line">                e.onNext(<span class="number">1</span>);</span><br><span class="line">                mRxOperatorsText.append(<span class="string">"Observable emit 2"</span> + <span class="string">"\n"</span>);</span><br><span class="line">                Log.e(TAG, <span class="string">"Observable emit 2"</span> + <span class="string">"\n"</span>);</span><br><span class="line">                e.onNext(<span class="number">2</span>);</span><br><span class="line">                mRxOperatorsText.append(<span class="string">"Observable emit 3"</span> + <span class="string">"\n"</span>);</span><br><span class="line">                Log.e(TAG, <span class="string">"Observable emit 3"</span> + <span class="string">"\n"</span>);</span><br><span class="line">                e.onNext(<span class="number">3</span>);</span><br><span class="line">                e.onComplete();</span><br><span class="line">                mRxOperatorsText.append(<span class="string">"Observable emit 4"</span> + <span class="string">"\n"</span>);</span><br><span class="line">                Log.e(TAG, <span class="string">"Observable emit 4"</span> + <span class="string">"\n"</span> );</span><br><span class="line">                e.onNext(<span class="number">4</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).subscribe(<span class="keyword">new</span> Observer&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">int</span> i;</span><br><span class="line">            <span class="keyword">private</span> Disposable mDisposable;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(@NonNull Disposable d)</span> </span>&#123;</span><br><span class="line">                mRxOperatorsText.append(<span class="string">"onSubscribe : "</span> + d.isDisposed() + <span class="string">"\n"</span>);</span><br><span class="line">                Log.e(TAG, <span class="string">"onSubscribe : "</span> + d.isDisposed() + <span class="string">"\n"</span> );</span><br><span class="line">                mDisposable = d;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(@NonNull Integer integer)</span> </span>&#123;</span><br><span class="line">                mRxOperatorsText.append(<span class="string">"onNext : value : "</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">                Log.e(TAG, <span class="string">"onNext : value : "</span> + integer + <span class="string">"\n"</span> );</span><br><span class="line">                i++;</span><br><span class="line">                <span class="keyword">if</span> (i == <span class="number">2</span>) &#123;</span><br><span class="line">                    <span class="comment">// 在RxJava 2.x 中，新增的Disposable可以做到切断的操作，让Observer观察者不再接收上游事件</span></span><br><span class="line">                    mDisposable.dispose();</span><br><span class="line">                    mRxOperatorsText.append(<span class="string">"onNext : isDisposable : "</span> + mDisposable.isDisposed() + <span class="string">"\n"</span>);</span><br><span class="line">                    Log.e(TAG, <span class="string">"onNext : isDisposable : "</span> + mDisposable.isDisposed() + <span class="string">"\n"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(@NonNull Throwable e)</span> </span>&#123;</span><br><span class="line">                mRxOperatorsText.append(<span class="string">"onError : value : "</span> + e.getMessage() + <span class="string">"\n"</span>);</span><br><span class="line">                Log.e(TAG, <span class="string">"onError : value : "</span> + e.getMessage() + <span class="string">"\n"</span> );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                mRxOperatorsText.append(<span class="string">"onComplete"</span> + <span class="string">"\n"</span>);</span><br><span class="line">                Log.e(TAG, <span class="string">"onComplete"</span> + <span class="string">"\n"</span> );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><strong>Map</strong> 基本算是 RxJava 中一个最简单的操作符了，熟悉 RxJava 1.x 的知道，它的作用是对发射时间发送的每一个事件应用一个函数，是的每一个事件都按照指定的函数去变化，而在 2.x 中它的作用几乎一致。<strong>map</strong> 基本作用就是将一个 <strong>Observable</strong> 通过某种函数关系，转换为另一种 <strong>Observable</strong>，下面例子中就是把我们的 Integer 数据变成了 String 类型。从Log日志显而易见。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Observable.create(<span class="keyword">new</span> ObservableOnSubscribe&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(@NonNull ObservableEmitter&lt;Integer&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                e.onNext(<span class="number">1</span>);</span><br><span class="line">                e.onNext(<span class="number">2</span>);</span><br><span class="line">                e.onNext(<span class="number">3</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).map(<span class="keyword">new</span> Function&lt;Integer, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(@NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"This is result "</span> + integer;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).subscribe(<span class="keyword">new</span> Consumer&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                mRxOperatorsText.append(<span class="string">"accept : "</span> + s +<span class="string">"\n"</span>);</span><br><span class="line">                Log.e(TAG, <span class="string">"accept : "</span> + s +<span class="string">"\n"</span> );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><h3 id="Zip"><a href="#Zip" class="headerlink" title="Zip"></a>Zip</h3></li>
</ul>
<p>zip 专用于合并事件，该合并不是连接（连接操作符后面会说），而是两两配对，也就意味着，最终配对出的 <strong>Observable</strong> 发射事件数目只和少的那个相同。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Observable.zip(getStringObservable(), getIntegerObservable(), <span class="keyword">new</span> BiFunction&lt;String, Integer, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(@NonNull String s, @NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> s + integer;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).subscribe(<span class="keyword">new</span> Consumer&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                mRxOperatorsText.append(<span class="string">"zip : accept : "</span> + s + <span class="string">"\n"</span>);</span><br><span class="line">                Log.e(TAG, <span class="string">"zip : accept : "</span> + s + <span class="string">"\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*注： getStringObservable 返回A B C ，getIntegerObservable返回的是1 2 3 4 5 </span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/628B12999CCE43C8A9FD5994B01C24CF/2176" alt="image"><br><strong>zip</strong> 组合事件的过程就是分别从发射器 A 和发射器 B 各取出一个事件来组合，并且一个事件只能被使用一次，组合的顺序是严格按照事件发送的顺序来进行的，所以上面截图中，可以看到，1 永远是和 A 结合的，2 永远是和 B 结合的。</p>
<p><strong>最终接收器收到的事件数量是和发送器发送事件最少的那个发送器的发送事件数目相同</strong><br>上面的例子就可以看出 结合后的事件数量是3 </p>
<hr>
<ul>
<li><h4 id="Concat"><a href="#Concat" class="headerlink" title="Concat"></a>Concat</h4></li>
</ul>
<p>因为<strong>zip</strong>连接事件有上述两个特点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 分别从两个发射器取一个事件组合成新事件，且事件组合顺序与发射顺序严格相同 </span><br><span class="line">2. 最终接受事件数量与原始发射器数量最小的那个相同</span><br></pre></td></tr></table></figure>
<p>对于单一的把两个发射器连接成一个发射器，可以尝试<strong>Contact</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Observable.concat(Observable.just(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>), Observable.just(<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>))</span><br><span class="line">                .subscribe(<span class="keyword">new</span> Consumer&lt;Integer&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        mRxOperatorsText.append(<span class="string">"concat : "</span>+ integer + <span class="string">"\n"</span>);</span><br><span class="line">                        Log.e(TAG, <span class="string">"concat : "</span>+ integer + <span class="string">"\n"</span> );</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure>
<p>**输出结果</p>
<h2 id="123456"><a href="#123456" class="headerlink" title="123456**"></a>123456**</h2><ul>
<li><h4 id="FlatMap"><a href="#FlatMap" class="headerlink" title="FlatMap"></a>FlatMap</h4></li>
</ul>
<p><strong>FlatMap</strong> ，它可以把一个发射器  <strong>Observable</strong> 通过某种方法转换为多个 <strong>Observables</strong>，然后再把这些分散的 <strong>Observables</strong>装进一个单一的发射器 <strong>Observable</strong>。但有个需要注意的是，<strong>flatMap</strong> ==并不能保证事件的顺序==，如果需要保证，需要用到我们下面要讲的 <strong>ConcatMap</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Observable.create(<span class="keyword">new</span> ObservableOnSubscribe&lt;Integer&gt;() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(@NonNull ObservableEmitter&lt;Integer&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">               e.onNext(<span class="number">1</span>);</span><br><span class="line">               e.onNext(<span class="number">2</span>);</span><br><span class="line">               e.onNext(<span class="number">3</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;).flatMap(<span class="keyword">new</span> Function&lt;Integer, ObservableSource&lt;String&gt;&gt;() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> ObservableSource&lt;String&gt; <span class="title">apply</span><span class="params">(@NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">               List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">                   list.add(<span class="string">"I am value "</span> + integer);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">int</span> delayTime = (<span class="keyword">int</span>) (<span class="number">1</span> + Math.random() * <span class="number">10</span>);</span><br><span class="line">               <span class="keyword">return</span> Observable.fromIterable(list).delay(delayTime, TimeUnit.MILLISECONDS);</span><br><span class="line">               <span class="comment">// 使用delay操作符，做一个小延时操作，而查看 Log 日志也表明，FlatMap是无序的。</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;).subscribeOn(Schedulers.newThread())</span><br><span class="line">               .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">               .subscribe(<span class="keyword">new</span> Consumer&lt;String&gt;() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                       Log.e(TAG, <span class="string">"flatMap : accept : "</span> + s + <span class="string">"\n"</span>);</span><br><span class="line">                       mRxOperatorsText.append(<span class="string">"flatMap : accept : "</span> + s + <span class="string">"\n"</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br></pre></td></tr></table></figure>
<p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/5C40758F7CD94BEAA7D939C4663F4FA0/2212" alt="image"><br> 输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2,3,3,3,2,2,1,1</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><h3 id="concatMap"><a href="#concatMap" class="headerlink" title="concatMap"></a>concatMap</h3></li>
</ul>
<p>上面其实就说了，<strong>concatMap</strong> 与 <strong>FlatMap</strong> 的唯一区别就是 <strong>concatMap</strong> 保证了顺序，所以，我们就直接把 <strong>flatMap</strong> 替换为 <strong>concatMap</strong> 验证。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Observable.create(<span class="keyword">new</span> ObservableOnSubscribe&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(@NonNull ObservableEmitter&lt;Integer&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                e.onNext(<span class="number">1</span>);</span><br><span class="line">                e.onNext(<span class="number">2</span>);</span><br><span class="line">                e.onNext(<span class="number">3</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).concatMap(<span class="keyword">new</span> Function&lt;Integer, ObservableSource&lt;String&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> ObservableSource&lt;String&gt; <span class="title">apply</span><span class="params">(@NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">                    list.add(<span class="string">"I am value "</span> + integer);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">int</span> delayTime = (<span class="keyword">int</span>) (<span class="number">1</span> + Math.random() * <span class="number">10</span>);</span><br><span class="line">                <span class="keyword">return</span> Observable.fromIterable(list).delay(delayTime, TimeUnit.MILLISECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).subscribeOn(Schedulers.newThread())</span><br><span class="line">                .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                .subscribe(<span class="keyword">new</span> Consumer&lt;String&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        Log.e(TAG, <span class="string">"flatMap : accept : "</span> + s + <span class="string">"\n"</span>);</span><br><span class="line">                        mRxOperatorsText.append(<span class="string">"flatMap : accept : "</span> + s + <span class="string">"\n"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 1 1 2 2 2 3 3 3</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><h3 id="distinct"><a href="#distinct" class="headerlink" title="distinct"></a>distinct</h3>作用是去重，输入<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 1 2 2 3 4 5</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 2 3 4 5</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Observable.just(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">                .distinct()</span><br><span class="line">                .subscribe(<span class="keyword">new</span> Consumer&lt;Integer&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        mRxOperatorsText.append(<span class="string">"distinct : "</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">                        Log.e(TAG, <span class="string">"distinct : "</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><strong>Filter</strong> 过滤器，可以接受一个参数，让其过滤掉不符合我们条件的值</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">20</span>, <span class="number">65</span>, -<span class="number">5</span>, <span class="number">7</span>, <span class="number">19</span>)</span><br><span class="line">                .filter(<span class="keyword">new</span> Predicate&lt;Integer&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(@NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> integer &gt;= <span class="number">10</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).subscribe(<span class="keyword">new</span> Consumer&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                mRxOperatorsText.append(<span class="string">"filter : "</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">                Log.e(TAG, <span class="string">"filter : "</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p>输出<br>大于10的事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">20 65 19</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><h3 id="buffer"><a href="#buffer" class="headerlink" title="buffer"></a>buffer</h3></li>
</ul>
<p><strong>buffer</strong> 操作符接受两个参数，buffer(count,skip)作用是将 <strong>Observable</strong> 中的数据按 <strong>skip</strong> (步长) 分成最大不超过 <strong>count</strong> 的 <strong>buffer</strong> ，然后生成一个  <strong>Observable</strong> 。也就是说 ==按照步长，将原始事件 分成一组一组  重新发射出去==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">                .buffer(<span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line">                .subscribe(<span class="keyword">new</span> Consumer&lt;List&lt;Integer&gt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull List&lt;Integer&gt; integers)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        mRxOperatorsText.append(<span class="string">"buffer size : "</span> + integers.size() + <span class="string">"\n"</span>);</span><br><span class="line">                        Log.e(TAG, <span class="string">"buffer size : "</span> + integers.size() + <span class="string">"\n"</span>);</span><br><span class="line">                        mRxOperatorsText.append(<span class="string">"buffer value : "</span>);</span><br><span class="line">                        Log.e(TAG, <span class="string">"buffer value : "</span> );</span><br><span class="line">                        <span class="keyword">for</span> (Integer i : integers) &#123;</span><br><span class="line">                            mRxOperatorsText.append(i + <span class="string">""</span>);</span><br><span class="line">                            Log.e(TAG, i + <span class="string">""</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        mRxOperatorsText.append(<span class="string">"\n"</span>);</span><br><span class="line">                        Log.e(TAG, <span class="string">"\n"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">size 3</span><br><span class="line">value 1 2 3 </span><br><span class="line">size 3</span><br><span class="line">value 3 4 5 </span><br><span class="line">size 1 </span><br><span class="line">value 5</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><h3 id="timer"><a href="#timer" class="headerlink" title="timer"></a>timer</h3></li>
</ul>
<p><strong>timer</strong>，相当于一个定时任务。在 1.x 中它还可以执行间隔逻辑，但在 2.x 中此功能被交给了 <strong>interval</strong>。但需要注意的是，<strong>timer</strong> 和 <strong>interval</strong> 均==默认在新线程==。<br>==执行timer方法，将使得接受延时==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mRxOperatorsText.append(<span class="string">"timer start : "</span> + TimeUtil.getNowStrTime() + <span class="string">"\n"</span>);</span><br><span class="line">        Log.e(TAG, <span class="string">"timer start : "</span> + TimeUtil.getNowStrTime() + <span class="string">"\n"</span>);</span><br><span class="line">        Observable.timer(<span class="number">2</span>, TimeUnit.SECONDS)</span><br><span class="line">                .subscribeOn(Schedulers.io())</span><br><span class="line">                .observeOn(AndroidSchedulers.mainThread()) <span class="comment">// timer 默认在新线程，所以需要切换回主线程</span></span><br><span class="line">                .subscribe(<span class="keyword">new</span> Consumer&lt;Long&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Long aLong)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        mRxOperatorsText.append(<span class="string">"timer :"</span> + aLong + <span class="string">" at "</span> + TimeUtil.getNowStrTime() + <span class="string">"\n"</span>);</span><br><span class="line">                        Log.e(TAG, <span class="string">"timer :"</span> + aLong + <span class="string">" at "</span> + TimeUtil.getNowStrTime() + <span class="string">"\n"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="当我们两次点击按钮触发这个事件的时候，接收被延迟了-2-秒。"><a href="#当我们两次点击按钮触发这个事件的时候，接收被延迟了-2-秒。" class="headerlink" title="当我们两次点击按钮触发这个事件的时候，接收被延迟了 2 秒。"></a>当我们两次点击按钮触发这个事件的时候，接收被延迟了 2 秒。</h2><ul>
<li><h3 id="interval"><a href="#interval" class="headerlink" title="interval"></a>interval</h3></li>
</ul>
<p>如同我们上面可说，<strong>interval</strong> 操作符用于间隔时间执行某个操作，其接受三个参数，分别是<strong>第一次发送延迟</strong>，<strong>间隔时间</strong>，<strong>时间单位</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mRxOperatorsText.append(<span class="string">"interval start : "</span> + TimeUtil.getNowStrTime() + <span class="string">"\n"</span>);</span><br><span class="line">       Log.e(TAG, <span class="string">"interval start : "</span> + TimeUtil.getNowStrTime() + <span class="string">"\n"</span>);</span><br><span class="line">       Observable.interval(<span class="number">3</span>,<span class="number">2</span>, TimeUnit.SECONDS)</span><br><span class="line">               .subscribeOn(Schedulers.io())</span><br><span class="line">               .observeOn(AndroidSchedulers.mainThread()) <span class="comment">// 由于interval默认在新线程，所以我们应该切回主线程</span></span><br><span class="line">               .subscribe(<span class="keyword">new</span> Consumer&lt;Long&gt;() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Long aLong)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                       mRxOperatorsText.append(<span class="string">"interval :"</span> + aLong + <span class="string">" at "</span> + TimeUtil.getNowStrTime() + <span class="string">"\n"</span>);</span><br><span class="line">                       Log.e(TAG, <span class="string">"interval :"</span> + aLong + <span class="string">" at "</span> + TimeUtil.getNowStrTime() + <span class="string">"\n"</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br></pre></td></tr></table></figure>
<p>执行结果是第一次延迟了 3 秒后接收到，后面每次间隔了 2 秒。<br>然而，由于我们这个是间隔执行，所以当我们的Activity 都销毁的时候，==实际上这个操作还依然在进行==，查看源码发现，我们<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subscribe(Cousumer&lt;? super T&gt; onNext)</span><br></pre></td></tr></table></figure></p>
<p>返回的是<strong>Disposable</strong>，<strong>Disposable</strong> 可以用来解除绑定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       mRxOperatorsText.append(<span class="string">"interval start : "</span> + TimeUtil.getNowStrTime() + <span class="string">"\n"</span>);</span><br><span class="line">       Log.e(TAG, <span class="string">"interval start : "</span> + TimeUtil.getNowStrTime() + <span class="string">"\n"</span>);</span><br><span class="line">       mDisposable = Observable.interval(<span class="number">3</span>, <span class="number">2</span>, TimeUnit.SECONDS)</span><br><span class="line">               .subscribeOn(Schedulers.io())</span><br><span class="line">               .observeOn(AndroidSchedulers.mainThread()) <span class="comment">// 由于interval默认在新线程，所以我们应该切回主线程</span></span><br><span class="line">               .subscribe(<span class="keyword">new</span> Consumer&lt;Long&gt;() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Long aLong)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                       mRxOperatorsText.append(<span class="string">"interval :"</span> + aLong + <span class="string">" at "</span> + TimeUtil.getNowStrTime() + <span class="string">"\n"</span>);</span><br><span class="line">                       Log.e(TAG, <span class="string">"interval :"</span> + aLong + <span class="string">" at "</span> + TimeUtil.getNowStrTime() + <span class="string">"\n"</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.onDestroy();</span><br><span class="line">       <span class="keyword">if</span> (mDisposable != <span class="keyword">null</span> &amp;&amp; !mDisposable.isDisposed()) &#123;</span><br><span class="line">           mDisposable.dispose();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><h3 id="doOnNext"><a href="#doOnNext" class="headerlink" title="doOnNext"></a>doOnNext</h3></li>
</ul>
<p><strong>doOnNext</strong> 它的作用是让订阅者在接收到数据之前做一些其他操作。假如我们在获取到数据之前想先保存一下它，无疑我们可以这样实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">                .doOnNext(<span class="keyword">new</span> Consumer&lt;Integer&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        mRxOperatorsText.append(<span class="string">"doOnNext 保存 "</span> + integer + <span class="string">"成功"</span> + <span class="string">"\n"</span>);</span><br><span class="line">                        Log.e(TAG, <span class="string">"doOnNext 保存 "</span> + integer + <span class="string">"成功"</span> + <span class="string">"\n"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).subscribe(<span class="keyword">new</span> Consumer&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                mRxOperatorsText.append(<span class="string">"doOnNext :"</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">                Log.e(TAG, <span class="string">"doOnNext :"</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><h3 id="skip"><a href="#skip" class="headerlink" title="skip"></a>skip</h3></li>
</ul>
<p><strong>skip</strong> ，接受一个 <strong>long</strong> 型参数 <strong>count</strong> ，代表跳过 <strong>count</strong> 个数目开始接收。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">                .skip(<span class="number">2</span>)</span><br><span class="line">                .subscribe(<span class="keyword">new</span> Consumer&lt;Integer&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        mRxOperatorsText.append(<span class="string">"skip : "</span>+integer + <span class="string">"\n"</span>);</span><br><span class="line">                        Log.e(TAG, <span class="string">"skip : "</span>+integer + <span class="string">"\n"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3 4 5</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><h3 id="take"><a href="#take" class="headerlink" title="take"></a>take</h3></li>
</ul>
<p><strong>take</strong>，接受一个 <strong>long</strong> 型参数 <strong>count</strong> ，代表至多接收 <strong>count</strong> 个数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Flowable.fromArray(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">                .take(<span class="number">2</span>)</span><br><span class="line">                .subscribe(<span class="keyword">new</span> Consumer&lt;Integer&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        mRxOperatorsText.append(<span class="string">"take : "</span>+integer + <span class="string">"\n"</span>);</span><br><span class="line">                        Log.e(TAG, <span class="string">"accept: take : "</span>+integer + <span class="string">"\n"</span> );</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 2</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><h3 id="just"><a href="#just" class="headerlink" title="just"></a>just</h3></li>
</ul>
<p><strong>just</strong>一个简单的发射器依次调用 onNext() 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="string">"1"</span>, <span class="string">"2"</span>, <span class="string">"3"</span>)</span><br><span class="line">                .subscribeOn(Schedulers.io())</span><br><span class="line">                .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                .subscribe(<span class="keyword">new</span> Consumer&lt;String&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        mRxOperatorsText.append(<span class="string">"accept : onNext : "</span> + s + <span class="string">"\n"</span>);</span><br><span class="line">                        Log.e(TAG,<span class="string">"accept : onNext : "</span> + s + <span class="string">"\n"</span> );</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 2 3</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><h3 id="Single"><a href="#Single" class="headerlink" title="Single"></a>Single</h3></li>
</ul>
<p>顾名思义，Single 只会接收一个参数，也就是只发射一次事件，他的而 SingleObserver 只会调用 <strong>onError()</strong> 或者 <strong>onSuccess()</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Single.just(<span class="keyword">new</span> Random().nextInt())</span><br><span class="line">                .subscribe(<span class="keyword">new</span> SingleObserver&lt;Integer&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(@NonNull Disposable d)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(@NonNull Integer integer)</span> </span>&#123;</span><br><span class="line">                        mRxOperatorsText.append(<span class="string">"single : onSuccess : "</span>+integer+<span class="string">"\n"</span>);</span><br><span class="line">                        Log.e(TAG, <span class="string">"single : onSuccess : "</span>+integer+<span class="string">"\n"</span> );</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(@NonNull Throwable e)</span> </span>&#123;</span><br><span class="line">                        mRxOperatorsText.append(<span class="string">"single : onError : "</span>+e.getMessage()+<span class="string">"\n"</span>);</span><br><span class="line">                        Log.e(TAG, <span class="string">"single : onError : "</span>+e.getMessage()+<span class="string">"\n"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onSuccess</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><h3 id="distinct-1"><a href="#distinct-1" class="headerlink" title="distinct"></a>distinct</h3></li>
</ul>
<p>去重操作符，简单的作用就是去重。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">                .distinct()</span><br><span class="line">                .subscribe(<span class="keyword">new</span> Consumer&lt;Integer&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        mRxOperatorsText.append(<span class="string">"distinct : "</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">                        Log.e(TAG, <span class="string">"distinct : "</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 2 3 4 5</span><br></pre></td></tr></table></figure>
<p>发射器发送的事件，在接收的时候被去重了。</p>
<hr>
<ul>
<li><h3 id="debounce"><a href="#debounce" class="headerlink" title="debounce"></a>debounce</h3></li>
</ul>
<p>去除发送频率过快的项，可以用来过滤点击过快的点击事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Observable.create(<span class="keyword">new</span> ObservableOnSubscribe&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(@NonNull ObservableEmitter&lt;Integer&gt; emitter)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">// send events with simulated time wait</span></span><br><span class="line">                emitter.onNext(<span class="number">1</span>); <span class="comment">// skip</span></span><br><span class="line">                Thread.sleep(<span class="number">400</span>);</span><br><span class="line">                emitter.onNext(<span class="number">2</span>); <span class="comment">// deliver</span></span><br><span class="line">                Thread.sleep(<span class="number">505</span>);</span><br><span class="line">                emitter.onNext(<span class="number">3</span>); <span class="comment">// skip</span></span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                emitter.onNext(<span class="number">4</span>); <span class="comment">// deliver</span></span><br><span class="line">                Thread.sleep(<span class="number">605</span>);</span><br><span class="line">                emitter.onNext(<span class="number">5</span>); <span class="comment">// deliver</span></span><br><span class="line">                Thread.sleep(<span class="number">510</span>);</span><br><span class="line">                emitter.onComplete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).debounce(<span class="number">500</span>, TimeUnit.MILLISECONDS)</span><br><span class="line">                .subscribeOn(Schedulers.io())</span><br><span class="line">                .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                .subscribe(<span class="keyword">new</span> Consumer&lt;Integer&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        mRxOperatorsText.append(<span class="string">"debounce :"</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">                        Log.e(TAG,<span class="string">"debounce :"</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2 4 5</span><br></pre></td></tr></table></figure>
<p>代码很清晰，去除发送间隔时间小于 500 毫秒的发射事件，所以 1 和 3 被去掉了。</p>
<hr>
<ul>
<li><h3 id="defer"><a href="#defer" class="headerlink" title="defer"></a>defer</h3></li>
</ul>
<p>==直到有订阅，才会创建Observable==<br>具有延时的效果。</p>
<p>代码对比如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">10</span>;</span><br><span class="line">Observable&lt;String&gt; o1 = Observable.just(<span class="string">"just result: "</span> + a);</span><br><span class="line">a = <span class="number">12</span>;</span><br><span class="line">o1.subscribe(<span class="keyword">new</span> Action1&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String t)</span> </span>&#123;</span><br><span class="line">        System.out.println(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>输出： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">just result: 10</span><br></pre></td></tr></table></figure>
<p>可见：<br>在使用<strong>just</strong>的时候，便创建了<strong>Observable</strong>对象，随后改变a的值，并不会改变<strong>Observable</strong>对象中的值。</p>
<p><strong>使用defer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">12</span>;</span><br><span class="line">Observable&lt;String&gt; o2 = </span><br><span class="line">    Observable.defer(<span class="keyword">new</span> Func0&lt;Observable&lt;String&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;String&gt; <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Observable.just(<span class="string">"defer result: "</span> + a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">a = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">o2.subscribe(<span class="keyword">new</span> Action1&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String t)</span> </span>&#123;</span><br><span class="line">        System.out.println(t);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>输出： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defer result: 20</span><br></pre></td></tr></table></figure>
<p>可见：<br><strong>在a=12时，虽然定义了一个Observable，但是并没有创建这个示例，当a=20时，这时候订阅这个Observable，则开始创建，所以对象中的a为20.</strong></p>
<hr>
<ul>
<li><h3 id="last"><a href="#last" class="headerlink" title="last"></a>last</h3></li>
</ul>
<p><strong>last</strong> 操作符仅取出可观察到的最后一个值，或者是满足某些条件的最后一项。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">                .last()</span><br><span class="line">                .subscribe(<span class="keyword">new</span> Consumer&lt;Integer&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        mRxOperatorsText.append(<span class="string">"last : "</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">                        Log.e(TAG, <span class="string">"last : "</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure>
<p>输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3</span><br></pre></td></tr></table></figure></p>
<hr>
<ul>
<li><h3 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h3></li>
</ul>
<p><strong>merge</strong> 顾名思义 在 Rx 操作符中，<strong>merge</strong> 的作用是把多个 <strong>Observable</strong> 结合起来，接受可变参数，也支持迭代器集合。注意它和 <strong>concat</strong> 的区别在于，==不用等到 发射器 A 发送完所有的事件再进行发射器 B 的发送==。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Observable.merge(Observable.just(<span class="number">1</span>, <span class="number">2</span>), Observable.just(<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line">                .subscribe(<span class="keyword">new</span> Consumer&lt;Integer&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        mRxOperatorsText.append(<span class="string">"merge :"</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">                        Log.e(TAG, <span class="string">"accept: merge :"</span> + integer + <span class="string">"\n"</span> );</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 2 3 4 5</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><h3 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h3></li>
</ul>
<p><strong>reduce</strong> 操作符每次用一个方法处理一个值，可以有一个 <strong>seed</strong> 作为初始值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">               .reduce(<span class="keyword">new</span> BiFunction&lt;Integer, Integer, Integer&gt;() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="function"><span class="keyword">public</span> Integer <span class="title">apply</span><span class="params">(@NonNull Integer integer, @NonNull Integer integer2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                       <span class="keyword">return</span> integer + integer2;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;).subscribe(<span class="keyword">new</span> Consumer&lt;Integer&gt;() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">               mRxOperatorsText.append(<span class="string">"reduce : "</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">               Log.e(TAG, <span class="string">"accept: reduce : "</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure>
<p>输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">6</span><br></pre></td></tr></table></figure></p>
<p>可以看到，代码中，我们中间采用 reduce ，支持一个 function 为两数值相加，所以应该最后的值是：1 + 2 = 3 + 3 = 6 ，</p>
<hr>
<ul>
<li><h3 id="scan"><a href="#scan" class="headerlink" title="scan"></a>scan</h3></li>
</ul>
<p><strong>scan</strong> 操作符作用和上面的 <strong>reduce</strong> 一致，唯一区别是 <strong>reduce</strong> 是个只追求结果的坏人，而  <strong>scan</strong> 会始终如一地把每一个步骤都输出。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">                .scan(<span class="keyword">new</span> BiFunction&lt;Integer, Integer, Integer&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Integer <span class="title">apply</span><span class="params">(@NonNull Integer integer, @NonNull Integer integer2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> integer + integer2;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).subscribe(<span class="keyword">new</span> Consumer&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                mRxOperatorsText.append(<span class="string">"scan "</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">                Log.e(TAG, <span class="string">"accept: scan "</span> + integer + <span class="string">"\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 3 6</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><h3 id="window"><a href="#window" class="headerlink" title="window"></a>window</h3></li>
</ul>
<p>按照实际划分窗口，将数据发送给不同的 <strong>Observable</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mRxOperatorsText.append(<span class="string">"window\n"</span>);</span><br><span class="line">       Log.e(TAG, <span class="string">"window\n"</span>);</span><br><span class="line">       Observable.interval(<span class="number">1</span>, TimeUnit.SECONDS) <span class="comment">// 间隔一秒发一次</span></span><br><span class="line">               .take(<span class="number">15</span>) <span class="comment">// 最多接收15个</span></span><br><span class="line">               .window(<span class="number">3</span>, TimeUnit.SECONDS)</span><br><span class="line">               .subscribeOn(Schedulers.io())</span><br><span class="line">               .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">               .subscribe(<span class="keyword">new</span> Consumer&lt;Observable&lt;Long&gt;&gt;() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Observable&lt;Long&gt; longObservable)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                       mRxOperatorsText.append(<span class="string">"Sub Divide begin...\n"</span>);</span><br><span class="line">                       Log.e(TAG, <span class="string">"Sub Divide begin...\n"</span>);</span><br><span class="line">                       longObservable.subscribeOn(Schedulers.io())</span><br><span class="line">                               .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                               .subscribe(<span class="keyword">new</span> Consumer&lt;Long&gt;() &#123;</span><br><span class="line">                                   <span class="meta">@Override</span></span><br><span class="line">                                   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(@NonNull Long aLong)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                                       mRxOperatorsText.append(<span class="string">"Next:"</span> + aLong + <span class="string">"\n"</span>);</span><br><span class="line">                                       Log.e(TAG, <span class="string">"Next:"</span> + aLong + <span class="string">"\n"</span>);</span><br><span class="line">                                   &#125;</span><br><span class="line">                               &#125;);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/4D0E7ABEF33943A9AC0BBC68A8E1B608/2320" alt="image"></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2018/04/12/Rxjava2操作符/" data-id="cjgzcn7q1000f6x0ch1uf46fk" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2018/04/12/Rxjava2操作符/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2018/04/12/Rxjava2操作符/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Socket未释放导致的句柄泄露" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/03/16/Socket未释放导致的句柄泄露/">socket未释放导致句柄泄露</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/03/16/Socket未释放导致的句柄泄露/">
            <time datetime="2018-03-16T11:40:50.000Z" itemprop="datePublished">2018-03-16</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/bug记录/">bug记录</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/bugs/">bugs</a>, <a class="tag-link" href="/tags/句柄泄露/">句柄泄露</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>问题描述<br>客户反馈话机的voipsdk demo在运行起来之后 放置不动，几小时过后，应用进行任何操作都会崩溃。<br>通过logcat 报错信息 发现出现了句柄泄露。通过ls -l /proc/<pid>/fd<br>可以查看到在demo进程下，持有的socket数量会规律性上升。</pid></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lrwx------ system   system            2018-03-08 14:11 60 -&gt; socket:[4027431]</span><br><span class="line">lrwx------ system   system            2018-03-08 14:11 61 -&gt; socket:[4025517]</span><br><span class="line">lrwx------ system   system            2018-03-08 14:11 62 -&gt; socket:[4028038]</span><br><span class="line">lrwx------ system   system            2018-03-08 14:11 63 -&gt; socket:[4028322]</span><br><span class="line">lrwx------ system   system            2018-03-08 14:11 64 -&gt; socket:[4026799]</span><br></pre></td></tr></table></figure>
<p>大概十秒增加一个，一直到超出安卓规定的数量，此时由于已无可用fd句柄，在进行任何操作都会因无可用句柄直接导致崩溃。</p>
<p>可以看到新增socket的inode号码之后，通过查找/proc/net/tcp(udp对应/proc/net/udp)文件，其中也列出了相应socket的inode号，通过比对此字段，我在/proc/net/tcp下获得此套接口的其他信息，对应的&lt;本地地址：端口号，远端地址：端口号&gt;对，窗口大小，状态等信息。具体字段含义详见net/ipv4/tcp_ipv4.c 中的 tcp4_seq_show 函数。cat /proc/net/tcp 如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@TOS_IP:/proc/net # cat tcp6</span><br><span class="line">  sl  local_address                         remote_address                        st tx_queue rx_queue tr tm-&gt;when retrnsmt   uid  timeout inode</span><br><span class="line">   0: 0000000000000000FFFF00007665A8C0:D483 0000000000000000FFFF00009F173379:0050 08 00000000:00000001 00:00000000 00000000 10077        0 3660979 1 00000000 25 4 30 10 -1</span><br><span class="line">   1: 0000000000000000FFFF00007665A8C0:E595 0000000000000000FFFF0000DCD5B276:0050 08 00000000:00000001 00:00000000 00000000 10077        0 3661419 1 00000000 24 4 28 10 -1</span><br><span class="line">   2: 0000000000000000FFFF00007665A8C0:81EC 0000000000000000FFFF00009F173379:0050 08 00000000:00000001 00:00000000 00000000  1000        0 4019721 1 00000000 23 4 30 10 -1</span><br><span class="line">   3: 0000000000000000FFFF00007665A8C0:B885 0000000000000000FFFF0000F28D0D6F:0050 08 00000000:00000001 00:00000000 00000000  1000        0 3659952 1 00000000 26 4 30 10 -1</span><br><span class="line">   4: 0000000000000000FFFF00007665A8C0:8AD0 0000000000000000FFFF00009F173379:0050 08 00000000:00000001 00:00000000 00000000  1000        0 4018811 1 00000000 24 4 30 10 -1</span><br><span class="line">   5: 0000000000000000FFFF00007665A8C0:E83C 0000000000000000FFFF00009F173379:0050 08 00000000:00000001 00:00000000 00000000  1000        0 4018828 1 00000000 23 4 30 10 -1</span><br></pre></td></tr></table></figure>
<p>将本端16进制端口号转化为10进制可以看到<br>是一个与8080端口在通信的socket。</p>
<p>目前初步猜测是端口争夺导致demo没有获取到端口，就会隔段时间重试去申请该端口。</p>
<ol>
<li>首先去java端排除，全局搜索发现并没有找到对应的8080端口申请情况</li>
<li>那就只有可能是linphone库里或者webrtc库里做了8080相关的操作了。</li>
<li>请linphone端的李工排查，发现在一段前离职同事的代码里，有一段申请8080端口的相关操作。查看了一下，发现和猜测的一致，因为要和底层通讯，同事使用了socket并通过8080端口，但是在申请资源后并未释放改socket，当系统自带的拨号服务起来之后，因为系统自带拨号和sdk的demo使用的linphone库是相同的，导致两个进程都在抢占8080，那个进程服务先拿到，另一个进程就拿不到该端口，会隔10s重新发起申请，但是之前创建的socket又没有释放，就会导致句柄泄露。</li>
</ol>
<p>我将系统自带的拨号进程彻底杀死，同事运行起demo，然后再将系统拨号运行起来，发现这时候 系统自带拨号也出现了句柄泄露。而demo就没有出现过了。</p>
<p>应征我之前的猜测。解决这个问题就很简单了，在linphone的代码里将改socket释放。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2018/03/16/Socket未释放导致的句柄泄露/" data-id="cjgzcn7pz000b6x0c343w8vkx" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2018/03/16/Socket未释放导致的句柄泄露/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2018/03/16/Socket未释放导致的句柄泄露/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-线程阻塞和中断的四种方式" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/03/13/线程阻塞和中断的四种方式/">线程阻塞和中断的四种方式</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/03/13/线程阻塞和中断的四种方式/">
            <time datetime="2018-03-13T12:46:25.000Z" itemprop="datePublished">2018-03-13</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/java基础/">java基础</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/java/">java</a>, <a class="tag-link" href="/tags/多线程/">多线程</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="1、线程阻塞"><a href="#1、线程阻塞" class="headerlink" title="1、线程阻塞"></a>1、线程阻塞</h2><p>一个线程进入阻塞状态可能的原因：</p>
<h4 id="通过调用sleep-millseconds-使任务进入休眠状态；"><a href="#通过调用sleep-millseconds-使任务进入休眠状态；" class="headerlink" title="通过调用sleep(millseconds)使任务进入休眠状态；"></a>通过调用sleep(millseconds)使任务进入休眠状态；</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo1</span> <span class="keyword">implements</span> <span class="title">Runnable</span> <span class="title">throws</span> <span class="title">InterruptedException</span></span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123; </span><br><span class="line">          Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line">②通过调用wait（）使线程挂起，直到线程获取notify（）/notifyAll（）消息，（或者在Java SE5中java.util.concurrent类库中等价的signal（）/signalAll（）消息），线程才会进入就绪状态；</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo2</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">          Thread.await();</span><br><span class="line">          Thread.notify();</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="任务在等待某个输入-输出流的完成；"><a href="#任务在等待某个输入-输出流的完成；" class="headerlink" title="任务在等待某个输入 / 输出流的完成；"></a>任务在等待某个输入 / 输出流的完成；</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo3</span> <span class="keyword">implements</span> <span class="title">Runnable</span> <span class="title">throws</span> <span class="title">InterruptedException</span></span>&#123;</span><br><span class="line">     <span class="keyword">private</span> InputStream in;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">          in.read();</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="任务试图在某个对象上调用其同步控制方法，但是对象锁不可用，因为另一个任务已经获取了该锁；"><a href="#任务试图在某个对象上调用其同步控制方法，但是对象锁不可用，因为另一个任务已经获取了该锁；" class="headerlink" title="任务试图在某个对象上调用其同步控制方法，但是对象锁不可用，因为另一个任务已经获取了该锁；"></a>任务试图在某个对象上调用其同步控制方法，但是对象锁不可用，因为另一个任务已经获取了该锁；</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo4</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span></span>&#123;     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span></span>&#123;     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">          method1();</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2、线程中断的方法"><a href="#2、线程中断的方法" class="headerlink" title="2、线程中断的方法"></a>2、线程中断的方法</h2><p>Thread类包含interrupt（）方法，用于终止阻塞任务；</p>
<h4 id="1）中断①②类线程休眠，挂起阻塞的方法"><a href="#1）中断①②类线程休眠，挂起阻塞的方法" class="headerlink" title="1）中断①②类线程休眠，挂起阻塞的方法"></a>1）中断①②类线程休眠，挂起阻塞的方法</h4><h5 id="1-直接使用Thread-interrupt"><a href="#1-直接使用Thread-interrupt" class="headerlink" title="1.直接使用Thread.interrupt();"></a>1.直接使用Thread.interrupt();</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">main()&#123;</span><br><span class="line">     Thread t = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Demo1());</span><br><span class="line">     t.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-使用Executor线程池，中断线程池中的所有线程；"><a href="#2-使用Executor线程池，中断线程池中的所有线程；" class="headerlink" title="2.使用Executor线程池，中断线程池中的所有线程；"></a>2.使用Executor线程池，中断线程池中的所有线程；</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">main()&#123;</span><br><span class="line">     ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line">     <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">          exec.execute(<span class="keyword">new</span> Demo1())</span><br><span class="line">     exec.shutdownNow();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-使用Executor线程池，中断线程池中单个阻塞的线程；"><a href="#3-使用Executor线程池，中断线程池中单个阻塞的线程；" class="headerlink" title="3.使用Executor线程池，中断线程池中单个阻塞的线程；"></a>3.使用Executor线程池，中断线程池中单个阻塞的线程；</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">main()&#123;</span><br><span class="line">     ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line">     Futrue&lt;?&gt; f = exec.submit(<span class="keyword">new</span> Demo1());</span><br><span class="line">     f.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>//中断后的清除代码放置在InterruptedException异常的catch捕获的代码块中</p>
<h4 id="2）中断③类I-O阻塞的方法"><a href="#2）中断③类I-O阻塞的方法" class="headerlink" title="2）中断③类I/O阻塞的方法"></a>2）中断③类I/O阻塞的方法</h4><p>使用Thread.iterrupt方法无法中断I/O阻塞，这对于基于Web的程序是很不利的；</p>
<h5 id="有一种解决方法：关闭任务在其上发生阻塞的底层资源；"><a href="#有一种解决方法：关闭任务在其上发生阻塞的底层资源；" class="headerlink" title="有一种解决方法：关闭任务在其上发生阻塞的底层资源；"></a>有一种解决方法：关闭任务在其上发生阻塞的底层资源；</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">main()&#123;</span><br><span class="line">     ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line">     ServerSocket server = <span class="keyword">new</span> ServerSocket(<span class="number">8080</span>);</span><br><span class="line">     InputStream socketInput = <span class="keyword">new</span> Socket(<span class="string">"localhost"</span>,<span class="number">8080</span>)</span><br><span class="line">     exec.execute(socketInput);</span><br><span class="line">     exec.execute(Sytsem.in);</span><br><span class="line">     <span class="comment">//exec.shutdownNow(); 无法中断2个线程；</span></span><br><span class="line"></span><br><span class="line">     socketInput.close();</span><br><span class="line">     in.close();</span><br><span class="line">     exec.shutdownNow();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="java-nio类库提供了更加人性化的I-O中断，被阻塞的nio通道会自动地响应中断；"><a href="#java-nio类库提供了更加人性化的I-O中断，被阻塞的nio通道会自动地响应中断；" class="headerlink" title="java.nio类库提供了更加人性化的I/O中断，被阻塞的nio通道会自动地响应中断；"></a>java.nio类库提供了更加人性化的I/O中断，被阻塞的nio通道会自动地响应中断；</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> <span class="title">impelenets</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">final</span> SocketChannel sc;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">Demo</span><span class="params">(SocketChannel sc)</span></span>&#123; <span class="keyword">this</span>.sc = sc;&#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">          <span class="keyword">try</span>&#123;</span><br><span class="line">               sc.read(ByteBuffer.allocate(<span class="number">1</span>));</span><br><span class="line">          &#125;<span class="keyword">catch</span>(CloseByInteruptedException e1)&#123;</span><br><span class="line">          &#125;<span class="keyword">catch</span>(AsyncronousCloseException e2)&#123;</span><br><span class="line">          &#125;<span class="keyword">catch</span>(IOException e3)&#123;</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Test &#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">          ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line">          ServerSocket server = <span class="keyword">new</span> ServerSocket(<span class="number">8080</span>);</span><br><span class="line">          InetSocketAddress isa = <span class="keyword">new</span> InetSocketAddress(<span class="string">"localhost"</span>,<span class="number">8080</span>);</span><br><span class="line">          SocketChannel sc1 = <span class="keyword">new</span> SocketChannel.open(isa);</span><br><span class="line">          SocketChannel sc2 = <span class="keyword">new</span> SocketChannel.open(isa);</span><br><span class="line">          </span><br><span class="line">          exec.execute(<span class="keyword">new</span> Demo(sc1));</span><br><span class="line">          Future&lt;?&gt; f = exec.submit(<span class="keyword">new</span> Demo(sc2));</span><br><span class="line">          f.cancel(<span class="keyword">true</span>);  <span class="comment">//可以终止sc1通道所在的线程；</span></span><br><span class="line">          exec.shutdownNow();  <span class="comment">//可以终止exec线程池内所有的线程；</span></span><br><span class="line">          sc1.close();</span><br><span class="line">          sc2.close();</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3）中断④类被互斥阻塞的线程"><a href="#3）中断④类被互斥阻塞的线程" class="headerlink" title="3）中断④类被互斥阻塞的线程"></a>3）中断④类被互斥阻塞的线程</h4><p>使用Thread.iterrupt方法无法中断互斥类线程，</p>
<h5 id="解决方式1：可以使用ReentrantLock显式加锁，在JavaSE5中引入的新特性，ReentrantLock上阻塞的任务可以被中断；"><a href="#解决方式1：可以使用ReentrantLock显式加锁，在JavaSE5中引入的新特性，ReentrantLock上阻塞的任务可以被中断；" class="headerlink" title="解决方式1：可以使用ReentrantLock显式加锁，在JavaSE5中引入的新特性，ReentrantLock上阻塞的任务可以被中断；"></a>解决方式1：可以使用ReentrantLock显式加锁，在JavaSE5中引入的新特性，ReentrantLock上阻塞的任务可以被中断；</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span> <span class="title">imlements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">     <span class="keyword">private</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">          lock.lock();</span><br><span class="line">          <span class="keyword">try</span>&#123;</span><br><span class="line">               <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">          &#125;<span class="keyword">catch</span>(InterruptedExcpetion e)&#123;</span><br><span class="line">               System.out.println(<span class="string">"The Task is interrupted!"</span>);</span><br><span class="line">          &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">               lock.unlock();</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">          Thread t = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Task());</span><br><span class="line">          t.start();</span><br><span class="line">          t.interrupt();</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="解决方式2：使用一个while（！Thread-interrupted（））包裹同步的代码块"><a href="#解决方式2：使用一个while（！Thread-interrupted（））包裹同步的代码块" class="headerlink" title="解决方式2：使用一个while（！Thread.interrupted（））包裹同步的代码块"></a>解决方式2：使用一个while（！Thread.interrupted（））包裹同步的代码块</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span> <span class="title">impelments</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span></span>&#123;     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">          <span class="keyword">try</span>&#123;</span><br><span class="line">               whlie(!Thread.interrupted())</span><br><span class="line">                    method1();</span><br><span class="line">           &#125;<span class="keyword">catch</span>(InteruptedException e)&#123;  </span><br><span class="line">           &#125;             </span><br><span class="line">     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">          ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line">          exec.execute(<span class="keyword">new</span> Task());</span><br><span class="line">          exec.shutdownNow();  <span class="comment">//线程被打断</span></span><br><span class="line">          <span class="comment">/*或 Thread t = new Thread(new Task());</span></span><br><span class="line"><span class="comment">               t.start();</span></span><br><span class="line"><span class="comment">               t.interrupt(); */</span></span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2018/03/13/线程阻塞和中断的四种方式/" data-id="cjgzcn7qg000z6x0cor890u4r" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2018/03/13/线程阻塞和中断的四种方式/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2018/03/13/线程阻塞和中断的四种方式/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-mac搭建PyQt5环境" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/12/11/mac搭建PyQt5环境/">mac搭建Pyqt5环境</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/12/11/mac搭建PyQt5环境/">
            <time datetime="2017-12-11T12:30:50.000Z" itemprop="datePublished">2017-12-11</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/python/">python</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/python/">python</a>, <a class="tag-link" href="/tags/qt/">qt</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h3 id="1-首先基于virtualenv-搭建一个python3的运行环境"><a href="#1-首先基于virtualenv-搭建一个python3的运行环境" class="headerlink" title="1.首先基于virtualenv 搭建一个python3的运行环境"></a>1.首先基于virtualenv 搭建一个python3的运行环境</h3><p>virtualenv是一个十分好用的python工具，可以为不同的软件创建独立的“隔离”的Python运行环境。</p>
<h5 id="1-首先，我们用pip安装virtualenv："><a href="#1-首先，我们用pip安装virtualenv：" class="headerlink" title="1. 首先，我们用pip安装virtualenv："></a>1. 首先，我们用pip安装virtualenv：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip3 install virtualenv</span><br></pre></td></tr></table></figure>
<h5 id="2-创建一个pyhton3的运行环境"><a href="#2-创建一个pyhton3的运行环境" class="headerlink" title="2.创建一个pyhton3的运行环境"></a>2.创建一个pyhton3的运行环境</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jiangxqdeMBP:~ jiangxq$ virtualenv py3 --python=python3</span><br></pre></td></tr></table></figure>
<p>可以通过<strong>python=python3</strong>来指定要安装的python版本，python3是mac的写法，其他linux系统需要制定为python2.7 或者python3.6</p>
<h4 id="3-激活该运行环境"><a href="#3-激活该运行环境" class="headerlink" title="3. 激活该运行环境"></a>3. 激活该运行环境</h4><p>执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jiangxqdeMBP:~ jiangxq$ source ~/py3/bin/activate</span><br><span class="line">(py3) jiangxqdeMBP:~ jiangxq$</span><br></pre></td></tr></table></figure>
<p>当用户名前出现该运行环境的名称时，表示环境已经激活了</p>
<h3 id="2-检查pip工具的版本-目前最新的为9-0-2-需要更新请-执行"><a href="#2-检查pip工具的版本-目前最新的为9-0-2-需要更新请-执行" class="headerlink" title="2. 检查pip工具的版本 目前最新的为9.0.2 需要更新请 执行"></a>2. 检查pip工具的版本 目前最新的为9.0.2 需要更新请 执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install --upgrade pip</span><br></pre></td></tr></table></figure>
<p>这里有个窍门是如果mac的默认python运行环境为python2.7，但是不想修改注册文件，可以直接打<strong>pip3</strong>，<strong>pip3</strong>是<br>是python3的pip工具，<strong>pip</strong>是python2的pip工具。</p>
<h3 id="3-使用pip工具安装PyQt5"><a href="#3-使用pip工具安装PyQt5" class="headerlink" title="3. 使用pip工具安装PyQt5"></a>3. 使用pip工具安装PyQt5</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install PyQt5</span><br></pre></td></tr></table></figure>
<p>当PyQt5安装完成之后，其实Qt的组件此时已经可用了，如果要测试是否安装成功，可以新建一个Python项目，然后倒入PyQt5的包看看。<br><img src="https://note.youdao.com/yws/api/personal/file/WEBa771a15d091f47d6ebb57e09a1c5eff4?method=download&amp;shareKey=c7c7e8069597b7ab8e8f58d4df01e4af" alt="image"></p>
<h3 id="4-在pycharm上安装QtDesign工具包"><a href="#4-在pycharm上安装QtDesign工具包" class="headerlink" title="4.在pycharm上安装QtDesign工具包"></a>4.在pycharm上安装QtDesign工具包</h3><p>QtDesign是Pycharm上的可视化uI设计工具，可以拖动控件来达到实现设计界面的功能<br>安装Qtdesign 需要先安装QT</p>
<h4 id="1-下载QT安装包"><a href="#1-下载QT安装包" class="headerlink" title="1. 下载QT安装包"></a>1. 下载QT安装包</h4><p>下载地址：<a href="http://iso.mirrors.ustc.edu.cn/qtproject/archive/qt/5.10/5.10.1/qt-opensource-mac-x64-5.10.1.dmg" target="_blank" rel="noopener">http://iso.mirrors.ustc.edu.cn/qtproject/archive/qt/5.10/5.10.1/qt-opensource-mac-x64-5.10.1.dmg</a><br>下载完成后直接安装</p>
<h4 id="2-打开pycharm-点击preference-点击Tools-新建一个插件"><a href="#2-打开pycharm-点击preference-点击Tools-新建一个插件" class="headerlink" title="2.打开pycharm 点击preference 点击Tools 新建一个插件"></a>2.打开pycharm 点击preference 点击Tools 新建一个插件</h4><p><img src="https://note.youdao.com/yws/public/resource/fa0a00bd4972d5802d8ad504e9e623fc/xmlnote/WEBRESOURCE9bf5498a9bb100d2b67bf988c494f1be/1941" alt="image"><br> 注意插件地址不要写错了，是qt5的安装路径</p>
<h4 id="3-创建PyUIC-插件（将pydesigner的布局自动转化为python代码）"><a href="#3-创建PyUIC-插件（将pydesigner的布局自动转化为python代码）" class="headerlink" title="3. 创建PyUIC 插件（将pydesigner的布局自动转化为python代码）"></a>3. 创建PyUIC 插件（将pydesigner的布局自动转化为python代码）</h4>
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2017/12/11/mac搭建PyQt5环境/" data-id="cjgzcn7q4000h6x0ct9zfsv0n" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2017/12/11/mac搭建PyQt5环境/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2017/12/11/mac搭建PyQt5环境/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-MQTT相关" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/12/11/MQTT相关/">MQTT相关总结</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/12/11/MQTT相关/">
            <time datetime="2017-12-11T12:30:50.000Z" itemprop="datePublished">2017-12-11</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/MQTT/">MQTT</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/mqtt/">mqtt</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="MQTT相关"><a href="#MQTT相关" class="headerlink" title="MQTT相关"></a>MQTT相关</h1><p>MQTT官网：<a href="http://mqtt.org/" target="_blank" rel="noopener">http://mqtt.org/</a></p>
<p>MQTT介绍：<a href="http://www.ibm.com" target="_blank" rel="noopener">http://www.ibm.com</a></p>
<p>MQTT Android github：<a href="https://github.com/eclipse/paho.mqtt.android" target="_blank" rel="noopener">https://github.com/eclipse/paho.mqtt.android</a></p>
<p>MQTT API：<a href="http://www.eclipse.org/paho/files/javadoc/index.html" target="_blank" rel="noopener">http://www.eclipse.org/paho/files/javadoc/index.html</a></p>
<p>MQTT Android API： <a href="http://www.eclipse.org/paho/files/android-javadoc/index.html" target="_blank" rel="noopener">http://www.eclipse.org/paho/files/android-javadoc/index.html</a></p>
<hr>
<h2 id="MQTT服务器搭建"><a href="#MQTT服务器搭建" class="headerlink" title="MQTT服务器搭建"></a>MQTT服务器搭建</h2><ul>
<li>环境：windows7 64位</li>
<li>JAVA环境:jdk 1.8.0</li>
<li>下载：<a href="http://activemq.apache.org/apollo/download.html" target="_blank" rel="noopener">Apollo服务器</a></li>
</ul>
<p>以下为步骤：</p>
<ol>
<li>下载Apollo服务器后，解压安装；</li>
<li>用命令行进入到安装目录bin目录下</li>
<li>输入 apollo create xxx (xxx为服务器实例名，eg.apollo create xmaihh)<blockquote>
<p>执行之后会在bin目录下创建名称为xxx的文件夹，比如我生成的文件夹是 xmaihh<br>xxx文件夹下etc\apollo.xml文件是 配置服务器文件信息<br>etc\users.properties文件包含连接MQTT服务器时用到的用户名和密码，默认为admin=password，即账号为admin，密码为password，可自行更改。</p>
</blockquote>
</li>
<li>用命令行进入到刚创建的xxx\bin目录下，输入apollo-broker.cmd run开启服务器</li>
<li>在浏览器输入<a href="http://127.0.0.1:61680/，查看是否安装成功" target="_blank" rel="noopener">http://127.0.0.1:61680/，查看是否安装成功</a><br><img src="https://i.imgur.com/qyuQDHy.png" alt=""><br><img src="https://i.imgur.com/SAh5lfp.png" alt=""><br><img src="https://i.imgur.com/5KZpNcP.png" alt=""><h2 id="MQTT-Android客户端"><a href="#MQTT-Android客户端" class="headerlink" title="MQTT Android客户端"></a>MQTT Android客户端</h2></li>
</ol>
<ul>
<li>环境：AndroidStudio 3.0.1</li>
<li>topic：中文意思是“话题”。在MQTT中订阅了(subscribe)同一话题（topic）的客户端会同时收到消息推送。</li>
<li>clientId：客户身份唯一标识。</li>
<li>qos：服务质量。</li>
<li>retained：要保留最后的断开连接信息。</li>
<li>MqttAndroidClient#subscribe()：订阅某个话题。</li>
<li>MqttAndroidClient#publish()： 向某个话题发送消息，之后服务器会推送给所有订阅了此话题的客户。</li>
<li>userName：连接到MQTT服务器的用户名。</li>
<li>passWord ：连接到MQTT服务器的密码</li>
</ul>
<p>以下为步骤：</p>
<ol>
<li><p>添加依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">    maven &#123;</span><br><span class="line">        url &quot;https://repo.eclipse.org/content/repositories/paho-snapshots/&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile &apos;org.eclipse.paho:org.eclipse.paho.client.mqttv3:1.1.0&apos;</span><br><span class="line">    compile &apos;org.eclipse.paho:org.eclipse.paho.android.service:1.1.1&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot; /&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.WAKE_LOCK&quot; /&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>注册Service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Mqtt Service --&gt;</span><br><span class="line">&lt;service android:name=&quot;org.eclipse.paho.android.service.MqttService&quot; /&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>具体实现</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * MQTT长连接服务</span><br><span class="line"> */</span><br><span class="line">public class MQTTService extends Service &#123;</span><br><span class="line">    public static final String TAG = MQTTService.class.getSimpleName();</span><br><span class="line"></span><br><span class="line">    public static MqttAndroidClient client;</span><br><span class="line">    private MqttConnectOptions connectOptions;</span><br><span class="line">        private String host = &quot;tcp://192.168.102.216:61613&quot;;</span><br><span class="line">//        private String host = &quot;tcp://192.168.8.241:61613&quot;;</span><br><span class="line">//        private String host = &quot;tcp://10.0.2.2:61613&quot;;</span><br><span class="line">//    private String host = &quot;tcp://192.168.26.144:1883&quot;;</span><br><span class="line"></span><br><span class="line">    private String username = &quot;admin&quot;;</span><br><span class="line">    private String password = &quot;password&quot;;</span><br><span class="line">    private static String myTopic = &quot;topic&quot;;</span><br><span class="line">    private String clientId = &quot;test123&quot;;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int onStartCommand(Intent intent, int flags, int startId) &#123;</span><br><span class="line">        init();</span><br><span class="line">        return super.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line">    @Nullable</span><br><span class="line">    @Override</span><br><span class="line">    public IBinder onBind(Intent intent) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void publish(String msg) &#123;</span><br><span class="line">        String topic = myTopic;</span><br><span class="line">        Integer qos = 0;</span><br><span class="line">        Boolean retained = false;</span><br><span class="line">        try &#123;</span><br><span class="line">            client.publish(topic, msg.getBytes(), qos.intValue(), retained.booleanValue());</span><br><span class="line">        &#125; catch (MqttException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * 初始化方法</span><br><span class="line">     */</span><br><span class="line">    private void init() &#123;</span><br><span class="line">        // 服务器地址 (协议+地址+端口号)</span><br><span class="line">        String url = host;</span><br><span class="line">        client = new MqttAndroidClient(this, url, clientId);</span><br><span class="line">        client.setCallback(mqttCallback);</span><br><span class="line">        connectOptions = new MqttConnectOptions();</span><br><span class="line">        // 清除缓存</span><br><span class="line">        connectOptions.setCleanSession(true);</span><br><span class="line">        // 设置超时时间,单位:秒</span><br><span class="line">        connectOptions.setConnectionTimeout(10);</span><br><span class="line">        // 心跳包发送时间间隔,单位:秒</span><br><span class="line">        connectOptions.setKeepAliveInterval(20);</span><br><span class="line">        // 用户名</span><br><span class="line">        connectOptions.setUserName(username);</span><br><span class="line">        // 密码</span><br><span class="line">        connectOptions.setPassword(password.toCharArray());</span><br><span class="line">        // last will message</span><br><span class="line">        boolean doConnect = true;</span><br><span class="line">        String message = &quot;&#123;\&quot;terminal_uid\&quot;:\&quot;&quot; + clientId + &quot;\&quot;&#125;&quot;;</span><br><span class="line">        String topic = myTopic;</span><br><span class="line">        Integer qos = 0;</span><br><span class="line">        Boolean retained = false;</span><br><span class="line">        if ((!message.equals(&quot;&quot;)) || (!topic.equals(&quot;&quot;))) &#123;</span><br><span class="line">            //最后的遗嘱</span><br><span class="line">            try &#123;</span><br><span class="line">                connectOptions.setWill(topic, message.getBytes(), qos.intValue(), retained.booleanValue());</span><br><span class="line">            &#125; catch (Exception ex) &#123;</span><br><span class="line">                Log.d(TAG, &quot;Exception Occured&quot;, ex);</span><br><span class="line">                doConnect = false;</span><br><span class="line">                iMqttActionListener.onFailure(null, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (doConnect) &#123;</span><br><span class="line">            //连接MQTT服务器</span><br><span class="line">            doClientConnection();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 连接MQTT服务器</span><br><span class="line">     */</span><br><span class="line">    private void doClientConnection() &#123;</span><br><span class="line">        if (!client.isConnected() &amp;&amp; isConnectIsNomarl()) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                client.connect(connectOptions, null, iMqttActionListener);</span><br><span class="line">            &#125; catch (MqttException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 判断网络是否连接</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private boolean isConnectIsNomarl() &#123;</span><br><span class="line">        ConnectivityManager connectivityManager = (ConnectivityManager)</span><br><span class="line">                this.getApplicationContext().getSystemService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">        NetworkInfo info = connectivityManager.getActiveNetworkInfo();</span><br><span class="line">        if (info != null &amp;&amp; info.isAvailable()) &#123;</span><br><span class="line">            String name = info.getTypeName();</span><br><span class="line">            Log.i(TAG, &quot;MQTT当前网络名称：&quot; + name);</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            Log.i(TAG, &quot;MQTT 没有可用网络&quot;);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * MQTT监听并且接收消息</span><br><span class="line">     */</span><br><span class="line">    private MqttCallback mqttCallback = new MqttCallback() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void connectionLost(Throwable cause) &#123;</span><br><span class="line">            //失去连接，重连</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void messageArrived(String topic, MqttMessage message) throws Exception &#123;</span><br><span class="line">            EventBus.getDefault().post(message);</span><br><span class="line">            String str2 = topic + &quot;;qos :&quot; + message.getQos() + &quot;;retained:&quot; + message.isRetained();</span><br><span class="line">            Log.d(TAG, &quot;messageArrived: str2&quot; + str2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void deliveryComplete(IMqttDeliveryToken token) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    /**</span><br><span class="line">     * MQTT是否连接成功</span><br><span class="line">     */</span><br><span class="line">    private IMqttActionListener iMqttActionListener = new IMqttActionListener() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void onSuccess(IMqttToken asyncActionToken) &#123;</span><br><span class="line">            Log.d(TAG, &quot;onSuccess: MQTT连接成功&quot;);</span><br><span class="line">            try &#123;</span><br><span class="line">                //订阅myTopic话题</span><br><span class="line">                client.subscribe(myTopic, 1);</span><br><span class="line">            &#125; catch (MqttException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void onFailure(IMqttToken asyncActionToken, Throwable exception) &#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">            //连接失败，重连</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>初始化各个参数，之后连接服务器。连接成功之后在<a href="http://127.0.0.1:61680/" target="_blank" rel="noopener">http://127.0.0.1:61680/</a> 看到自动创建了名称为”topic”的topic。这里我使用两台真机。<a href="http://127.0.0.1:61680/" target="_blank" rel="noopener">http://127.0.0.1:61680/</a> 服务端看到的是这个样子<br><img src="https://i.imgur.com/9eB33fT.png" alt=""></p>
<ol>
<li>模拟器运行的时候host = “tcp://10.0.2.2:61613”，因为10.0.2.2 是模拟器设置的特定ip，是你电脑的别名。真机运行的时候host = “tcp://192.168.102.216:61613”。192.168.102.216是我主机的IPv4地址，查看本机IP的cmd命令为ipconfig/all。 </li>
<li>两次运行时的clientId不能一样（为了保证客户标识的唯一性）</li>
</ol>
</blockquote>
<hr>
<h3 id="访问管理界面"><a href="#访问管理界面" class="headerlink" title="访问管理界面"></a>访问管理界面</h3><p>要修改前面创建的xxx文件夹下etc\apollo.xml文件，添加你的host就可以通过host访问管理界面，否则只能通过 <a href="http://127.0.0.1:61680" target="_blank" rel="noopener">http://127.0.0.1:61680</a> 和 <a href="https://127.0.0.1:61681" target="_blank" rel="noopener">https://127.0.0.1:61681</a> 访问<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">... ...</span><br><span class="line"> &lt;virtual_host id=&quot;xmaihh&quot;&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">      You should add all the host names that this virtual host is known as</span><br><span class="line">      to properly support the STOMP 1.1 virtual host feature.</span><br><span class="line">      --&gt;</span><br><span class="line">    &lt;host_name&gt;xmaihh&lt;/host_name&gt;</span><br><span class="line">    &lt;host_name&gt;localhost&lt;/host_name&gt;</span><br><span class="line">    &lt;host_name&gt;127.0.0.1&lt;/host_name&gt;</span><br><span class="line">	&lt;!--以下为添加内容--&gt;</span><br><span class="line">    &lt;host_name&gt;192.168.102.216&lt;/host_name&gt;</span><br><span class="line">	&lt;!--以上为添加内容--&gt;</span><br><span class="line">    &lt;!-- Uncomment to disable security for the virtual host --&gt;</span><br><span class="line">    &lt;!-- &lt;authentication enabled=&quot;false&quot;/&gt; --&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- Uncomment to disable security for the virtual host --&gt;</span><br><span class="line">    &lt;!-- &lt;authentication enabled=&quot;false&quot;/&gt; --&gt;</span><br><span class="line">    &lt;access_rule allow=&quot;users&quot; action=&quot;connect create destroy send receive consume&quot;/&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;!-- You can delete this element if you want to disable persistence for this virtual host --&gt;</span><br><span class="line">    &lt;leveldb_store directory=&quot;$&#123;apollo.base&#125;/data&quot;/&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &lt;/virtual_host&gt;</span><br><span class="line"></span><br><span class="line">  &lt;web_admin bind=&quot;http://127.0.0.1:61680&quot;/&gt;</span><br><span class="line">  &lt;web_admin bind=&quot;https://127.0.0.1:61681&quot;/&gt;</span><br><span class="line">  &lt;!--以下为添加内容--&gt;</span><br><span class="line">  &lt;web_admin bind=&quot;http://192.168.102.216:61680&quot;/&gt;</span><br><span class="line">  &lt;web_admin bind=&quot;https://192.168.102.216:61681&quot;/&gt;</span><br><span class="line">  &lt;!--以上为添加内容--&gt;</span><br><span class="line"></span><br><span class="line">  &lt;connector id=&quot;tcp&quot; bind=&quot;tcp://0.0.0.0:61613&quot; connection_limit=&quot;2000&quot;/&gt;</span><br><span class="line">  &lt;connector id=&quot;tls&quot; bind=&quot;tls://0.0.0.0:61614&quot; connection_limit=&quot;2000&quot;/&gt;</span><br><span class="line">  &lt;connector id=&quot;ws&quot;  bind=&quot;ws://0.0.0.0:61623&quot;  connection_limit=&quot;2000&quot;/&gt;</span><br><span class="line">  &lt;connector id=&quot;wss&quot; bind=&quot;wss://0.0.0.0:61624&quot; connection_limit=&quot;2000&quot;/&gt;</span><br><span class="line"></span><br><span class="line">  &lt;key_storage file=&quot;$&#123;apollo.base&#125;/etc/keystore&quot; password=&quot;password&quot; key_password=&quot;password&quot;/&gt;</span><br></pre></td></tr></table></figure></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2017/12/11/MQTT相关/" data-id="cjgzcn7py000a6x0cn3x63scc" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2017/12/11/MQTT相关/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2017/12/11/MQTT相关/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-view 绘制机制" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/12/view 绘制机制/">view 绘制机制</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/12/view 绘制机制/">
            <time datetime="2017-10-12T11:30:50.000Z" itemprop="datePublished">2017-10-12</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/android/">android</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>View的绘制和事件处理是两个重要的主题，上一篇《图解 Android事件分发机制》已经把事件的分发机制讲得比较详细了，这一篇是针对View的绘制，View的绘制如果你有所了解，基本分为measure、layout、draw 过程，其中比较难理解就是measure过程，所以本篇文章大幅笔地分析measure过程，相对讲得比较详细，文章也比较长，如果你对View的绘制还不是很懂，对measure过程掌握得不是很深刻，那么耐心点，看完这篇文章，相信你会有所收获的。</p>
<h1 id="Measure过程"><a href="#Measure过程" class="headerlink" title="Measure过程"></a>Measure过程</h1><p>对于测量我们来说几个知识点,了解这几个知识点，之后的实例分析你才看得懂。</p>
<h2 id="1、MeasureSpec-的理解"><a href="#1、MeasureSpec-的理解" class="headerlink" title="1、MeasureSpec 的理解"></a>1、MeasureSpec 的理解</h2><p>对于View的测量，肯定会和<strong>MeasureSpec</strong>接触，<strong>MeasureSpec</strong>是两个单词组成，翻译过来“测量规格”或者“测量参数”，很多博客包括官方文档对他的说明基本都是“一个MeasureSpec封装了从父容器传递给子容器的布局要求”,这个MeasureSpec 封装的是父容器传递给子容器的布局要求，而不是父容器对子容器的布局要求，“传递” 两个字很重要，更精确的说法应该这个MeasureSpec是由父View的MeasureSpec和子View的LayoutParams通过简单的计算得出一个针对子View的测量要求，这个测量要求就是MeasureSpec。</p>
<p>大家都知道一个MeasureSpec是一个大小跟模式的组合值,MeasureSpec中的值是一个整型（32位）将size和mode打包成一个Int型，其中高两位是mode，后面30位存的是size，是为了减少对象的分配开支。MeasureSpec 类似于下图，只不过这边用的是十进制的数，而MeasureSpec 是二进制存储的。<br><img src="https://upload-images.jianshu.io/upload_images/966283-c330852c971b02a8.png" alt="image"></p>
<h6 id="注：-1-代表的是EXACTLY，-2-是AT-MOST"><a href="#注：-1-代表的是EXACTLY，-2-是AT-MOST" class="headerlink" title="注：-1 代表的是EXACTLY，-2 是AT_MOST"></a>注：-1 代表的是EXACTLY，-2 是AT_MOST</h6><p>MeasureSpec一共有三种模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPSPECIFIED : 父容器对于子容器没有任何限制,子容器想要多大就多大</span><br><span class="line">EXACTLY: 父容器已经为子容器设置了尺寸,子容器应当服从这些边界,不论子容器想要多大的空间。</span><br><span class="line">AT_MOST：子容器可以是声明大小内的任意大小</span><br></pre></td></tr></table></figure>
<p>很多文章都会把这三个模式说成这样，当然其实包括官方文档也是这样表达的，但是这样并不好理解。特别是如果把这三种模式又和<strong>MATCH_PARENT</strong>和<strong>WRAP_CONTENT</strong> 联系到一起，很多人就懵逼了。如果从代码上来看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view.measure(int widthMeasureSpec, int heightMeasureSpec)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p> 的两个MeasureSpec是父类传递过来的，但并不是完全是父View的要求，而是父View的MeasureSpec和子View自己的LayoutParams共同决定的，而子View的LayoutParams其实就是我们在xml写的时候设置的layout_width和layout_height 转化而来的。我们先来看代码会清晰一些：</p>
<p>父View的measure的过程会先测量子View，等子View测量结果出来后，再来测量自己，上面的measureChildWithMargins就是用来测量某个子View的，我们来分析是怎样测量的，具体看注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildWithMargins</span><span class="params">(View child, <span class="keyword">int</span> parentWidthMeasureSpec, <span class="keyword">int</span> widthUsed, <span class="keyword">int</span> parentHeightMeasureSpec, <span class="keyword">int</span> heightUsed)</span> </span>&#123; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 子View的LayoutParams，你在xml的layout_width和layout_height,</span></span><br><span class="line"><span class="comment">// layout_xxx的值最后都会封装到这个个LayoutParams。</span></span><br><span class="line"><span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();   </span><br><span class="line"></span><br><span class="line"><span class="comment">//根据父View的测量规格和父View自己的Padding，</span></span><br><span class="line"><span class="comment">//还有子View的Margin和已经用掉的空间大小（widthUsed），就能算出子View的MeasureSpec,具体计算过程看getChildMeasureSpec方法。</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,            </span><br><span class="line">mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin + widthUsed, lp.width);    </span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,           </span><br><span class="line">mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin  + heightUsed, lp.height);  </span><br><span class="line"></span><br><span class="line"><span class="comment">//通过父View的MeasureSpec和子View的自己LayoutParams的计算，算出子View的MeasureSpec，然后父容器传递给子容器的</span></span><br><span class="line"><span class="comment">// 然后让子View用这个MeasureSpec（一个测量要求，比如不能超过多大）去测量自己，如果子View是ViewGroup 那还会递归往下测量。</span></span><br><span class="line">child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// spec参数   表示父View的MeasureSpec </span></span><br><span class="line"><span class="comment">// padding参数    父View的Padding+子View的Margin，父View的大小减去这些边距，才能精确算出</span></span><br><span class="line"><span class="comment">//               子View的MeasureSpec的size</span></span><br><span class="line"><span class="comment">// childDimension参数  表示该子View内部LayoutParams属性的值（lp.width或者lp.height）</span></span><br><span class="line"><span class="comment">//                    可以是wrap_content、match_parent、一个精确指(an exactly size),  </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getChildMeasureSpec</span><span class="params">(<span class="keyword">int</span> spec, <span class="keyword">int</span> padding, <span class="keyword">int</span> childDimension)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(spec);  <span class="comment">//获得父View的mode  </span></span><br><span class="line">    <span class="keyword">int</span> specSize = MeasureSpec.getSize(spec);  <span class="comment">//获得父View的大小  </span></span><br><span class="line"></span><br><span class="line">   <span class="comment">//父View的大小-自己的Padding+子View的Margin，得到值才是子View的大小。</span></span><br><span class="line">    <span class="keyword">int</span> size = Math.max(<span class="number">0</span>, specSize - padding);   </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">int</span> resultSize = <span class="number">0</span>;    <span class="comment">//初始化值，最后通过这个两个值生成子View的MeasureSpec</span></span><br><span class="line">    <span class="keyword">int</span> resultMode = <span class="number">0</span>;    <span class="comment">//初始化值，最后通过这个两个值生成子View的MeasureSpec</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">switch</span> (specMode) &#123;  </span><br><span class="line">    <span class="comment">// Parent has imposed an exact size on us  </span></span><br><span class="line">    <span class="comment">//1、父View是EXACTLY的 ！  </span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.EXACTLY:   </span><br><span class="line">        <span class="comment">//1.1、子View的width或height是个精确值 (an exactly size)  </span></span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;            </span><br><span class="line">            resultSize = childDimension;         <span class="comment">//size为精确值  </span></span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;    <span class="comment">//mode为 EXACTLY 。  </span></span><br><span class="line">        &#125;   </span><br><span class="line">        <span class="comment">//1.2、子View的width或height为 MATCH_PARENT/FILL_PARENT   </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;  </span><br><span class="line">            <span class="comment">// Child wants to be our size. So be it.  </span></span><br><span class="line">            resultSize = size;                   <span class="comment">//size为父视图大小  </span></span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;    <span class="comment">//mode为 EXACTLY 。  </span></span><br><span class="line">        &#125;   </span><br><span class="line">        <span class="comment">//1.3、子View的width或height为 WRAP_CONTENT  </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;  </span><br><span class="line">            <span class="comment">// Child wants to determine its own size. It can't be  </span></span><br><span class="line">            <span class="comment">// bigger than us.  </span></span><br><span class="line">            resultSize = size;                   <span class="comment">//size为父视图大小  </span></span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;    <span class="comment">//mode为AT_MOST 。  </span></span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Parent has imposed a maximum size on us  </span></span><br><span class="line">    <span class="comment">//2、父View是AT_MOST的 ！      </span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.AT_MOST:  </span><br><span class="line">        <span class="comment">//2.1、子View的width或height是个精确值 (an exactly size)  </span></span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;  </span><br><span class="line">            <span class="comment">// Child wants a specific size... so be it  </span></span><br><span class="line">            resultSize = childDimension;        <span class="comment">//size为精确值  </span></span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;   <span class="comment">//mode为 EXACTLY 。  </span></span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//2.2、子View的width或height为 MATCH_PARENT/FILL_PARENT  </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;  </span><br><span class="line">            <span class="comment">// Child wants to be our size, but our size is not fixed.  </span></span><br><span class="line">            <span class="comment">// Constrain child to not be bigger than us.  </span></span><br><span class="line">            resultSize = size;                  <span class="comment">//size为父视图大小  </span></span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;   <span class="comment">//mode为AT_MOST  </span></span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//2.3、子View的width或height为 WRAP_CONTENT  </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;  </span><br><span class="line">            <span class="comment">// Child wants to determine its own size. It can't be  </span></span><br><span class="line">            <span class="comment">// bigger than us.  </span></span><br><span class="line">            resultSize = size;                  <span class="comment">//size为父视图大小  </span></span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;   <span class="comment">//mode为AT_MOST  </span></span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Parent asked to see how big we want to be  </span></span><br><span class="line">    <span class="comment">//3、父View是UNSPECIFIED的 ！  </span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:  </span><br><span class="line">        <span class="comment">//3.1、子View的width或height是个精确值 (an exactly size)  </span></span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;  </span><br><span class="line">            <span class="comment">// Child wants a specific size... let him have it  </span></span><br><span class="line">            resultSize = childDimension;        <span class="comment">//size为精确值  </span></span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;   <span class="comment">//mode为 EXACTLY  </span></span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//3.2、子View的width或height为 MATCH_PARENT/FILL_PARENT  </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;  </span><br><span class="line">            <span class="comment">// Child wants to be our size... find out how big it should  </span></span><br><span class="line">            <span class="comment">// be  </span></span><br><span class="line">            resultSize = <span class="number">0</span>;                        <span class="comment">//size为0！ ,其值未定  </span></span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;  <span class="comment">//mode为 UNSPECIFIED  </span></span><br><span class="line">        &#125;   </span><br><span class="line">        <span class="comment">//3.3、子View的width或height为 WRAP_CONTENT  </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;  </span><br><span class="line">            <span class="comment">// Child wants to determine its own size.... find out how  </span></span><br><span class="line">            <span class="comment">// big it should be  </span></span><br><span class="line">            resultSize = <span class="number">0</span>;                        <span class="comment">//size为0! ，其值未定  </span></span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;  <span class="comment">//mode为 UNSPECIFIED  </span></span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">break</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//根据上面逻辑条件获取的mode和size构建MeasureSpec对象。  </span></span><br><span class="line">    <span class="keyword">return</span> MeasureSpec.makeMeasureSpec(resultSize, resultMode);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码有点多，希望你仔细看一些注释，代码写得很多，其实计算原理很简单：</p>
<ol>
<li>如果我们在xml 的layout_width或者layout_height 把值都写死，那么上述的测量完全就不需要了，之所以要上面的这步测量，是因为 match_parent 就是充满父容器，wrap_content 就是自己多大就多大， 我们写代码的时候特别爽，我们编码方便的时候，google就要帮我们计算你match_parent的时候是多大，wrap_content的是多大，这个计算过程，就是计算出来的父View的MeasureSpec不断往子View传递，结合子View的LayoutParams 一起再算出子View的MeasureSpec，然后继续传给子View，不断计算每个View的MeasureSpec，子View有了MeasureSpec才能更测量自己和自己的子View。</li>
</ol>
<ol start="2">
<li>上述代码如果这么来理解就简单了<blockquote>
<p>如果父View的MeasureSpec 是EXACTLY，说明父View的大小是确切的，（确切的意思很好理解，如果一个View的MeasureSpec 是EXACTLY，那么它的size 是多大，最后展示到屏幕就一定是那么大）。</p>
</blockquote>
</li>
</ol>
<ul>
<li><p>1.如果子View 的layout_xxxx是MATCH_PARENT，父View的大小是确切，子View的大小又MATCH_PARENT（充满整个父View），那么子View的大小肯定是确切的，而且大小值就是父View的size。所以子View的size=父View的size，mode=EXACTLY</p>
<ul>
<li>2.如果子View 的layout_xxxx是WRAP_CONTENT，也就是子View的大小是根据自己的content 来决定的，但是子View的毕竟是子View，大小不能超过父View的大小，但是子View的是WRAP_CONTENT，我们还不知道具体子View的大小是多少，要等到child.measure(childWidthMeasureSpec, childHeightMeasureSpec) 调用的时候才去真正测量子View 自己content的大小（比如TextView wrap_content 的时候你要测量TextView content 的大小，也就是字符占用的大小，这个测量就是在child.measure(childWidthMeasureSpec, childHeightMeasureSpec)的时候，才能测出字符的大小，MeasureSpec 的意思就是假设你字符100px，但是MeasureSpec 要求最大的只能50px，这时候就要截掉了）。通过上述描述，子View MeasureSpec mode的应该是AT_MOST，而size 暂定父View的 size，表示的意思就是子View的大小没有不确切的值，子View的大小最大为父View的大小，不能超过父View的大小（这就是AT_MOST 的意思），然后这个MeasureSpec 做为子View measure方法 的参数，做为子View的大小的约束或者说是要求，有了这个MeasureSpec子View再实现自己的测量。</li>
</ul>
</li>
</ul>
<p>3、如果如果子View 的layout_xxxx是确定的值（200dp），那么就更简单了，不管你父View的mode和size是什么，我都写死了就是200dp，那么控件最后展示就是就是200dp，不管我的父View有多大，也不管我自己的content 有多大，反正我就是这么大，所以这种情况MeasureSpec 的mode = EXACTLY 大小size=你在layout_xxxx 填的那个值。</p>
<blockquote>
<p>如果父View的MeasureSpec 是AT_MOST，说明父View的大小是不确定，最大的大小是MeasureSpec 的size值，不能超过这个值。</p>
</blockquote>
<ul>
<li><p>1、如果子View 的layout_xxxx是MATCH_PARENT，父View的大小是不确定（只知道最大只能多大），子View的大小MATCH_PARENT（充满整个父View），那么子View你即使充满父容器，你的大小也是不确定的，父View自己都确定不了自己的大小，你MATCH_PARENT你的大小肯定也不能确定的，所以子View的mode=AT_MOST，size=父View的size，也就是你在布局虽然写的是MATCH_PARENT，但是由于你的父容器自己的大小不确定，导致子View的大小也不确定，只知道最大就是父View的大小。</p>
</li>
<li><p>2、如果子View 的layout_xxxx是WRAP_CONTENT，父View的大小是不确定（只知道最大只能多大），子View又是WRAP_CONTENT，那么在子View的Content没算出大小之前，子View的大小最大就是父View的大小，所以子View MeasureSpec mode的就是AT_MOST，而size 暂定父View的 size。</p>
</li>
<li><p>3、如果如果子View 的layout_xxxx是确定的值（200dp），同上，写多少就是多少，改变不了的。</p>
</li>
</ul>
<blockquote>
<p>如果父View的MeasureSpec 是UNSPECIFIED(未指定),表示没有任何束缚和约束，不像AT_MOST表示最大只能多大，不也像EXACTLY表示父View确定的大小，子View可以得到任意想要的大小，不受约束</p>
<ul>
<li>1、如果子View 的layout_xxxx是MATCH_PARENT，因为父View的MeasureSpec是UNSPECIFIED，父View自己的大小并没有任何约束和要求，<br>那么对于子View来说无论是WRAP_CONTENT还是MATCH_PARENT，子View也是没有任何束缚的，想多大就多大，没有不能超过多少的要求，一旦没有任何要求和约束，size的值就没有任何意义了，所以一般都直接设置成0</li>
</ul>
</blockquote>
<ul>
<li><p>2、同上…</p>
</li>
<li><p>3、如果如果子View 的layout_xxxx是确定的值（200dp），同上，写多少就是多少，改变不了的（记住，只有设置的确切的值，那么无论怎么测量，大小都是不变的，都是你写的那个值）</p>
</li>
</ul>
<p>到此为止，你是否对MeasureSpec 和三种模式、还有WRAP_CONTENT和MATCH_PARENT有一定的了解了，如果还有任何问题，欢迎在我简书（用户名：Kelin）评论里留言。</p>
<h2 id="2、View的测量过程主要是在onMeasure-方法"><a href="#2、View的测量过程主要是在onMeasure-方法" class="headerlink" title="2、View的测量过程主要是在onMeasure()方法"></a>2、View的测量过程主要是在onMeasure()方法</h2><p>打开View的源码，找到measure方法，这个方法代码不少，但是测量工作都是在onMeasure()做的，measure方法是final的所以这个方法也不可重写，如果想自定义View的测量，你应该去重写onMeasure()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">measure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">  onMeasure(widthMeasureSpec,heightMeasureSpec);</span><br><span class="line">  .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3、View的onMeasure-的默认实现"><a href="#3、View的onMeasure-的默认实现" class="headerlink" title="3、View的onMeasure 的默认实现"></a>3、View的onMeasure 的默认实现</h2><p>打开View.java 的源码来看下onMeasure的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;    </span><br><span class="line">  setMeasuredDimension(</span><br><span class="line">  getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),            </span><br><span class="line">  getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>View的onMeasure方法默认实现很简单，就是调用setMeasuredDimension()，setMeasuredDimension()可以简单理解就是给mMeasuredWidth和mMeasuredHeight设值，如果这两个值一旦设置了，那么意味着对于这个View的测量结束了，这个View的宽高已经有测量的结果出来了。如果我们想设定某个View的高宽，完全可以直接通过setMeasuredDimension（100，200）来设置死它的高宽（不建议），但是setMeasuredDimension方法必须在onMeasure方法中调用，不然会抛异常。我们来看下对于View来说它的默认高宽是怎么获取的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取的是android:minHeight属性的值或者View背景图片的大小值</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getSuggestedMinimumWidth</span><span class="params">()</span> </span>&#123; </span><br><span class="line">   <span class="keyword">return</span> (mBackground == <span class="keyword">null</span>) ? mMinWidth : max(mMinWidth, mBackground.getMinimumWidth()); </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">//@param size参数一般表示设置了android:minHeight属性或者该View背景图片的大小值  </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;    </span><br><span class="line">   <span class="keyword">int</span> result = size;    </span><br><span class="line">   <span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);    </span><br><span class="line">   <span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);    </span><br><span class="line">   <span class="keyword">switch</span> (specMode) &#123;    </span><br><span class="line">   <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:        <span class="comment">//表示该View的大小父视图未定，设置为默认值 </span></span><br><span class="line">     result = size;  </span><br><span class="line">     <span class="keyword">break</span>;    </span><br><span class="line">   <span class="keyword">case</span> MeasureSpec.AT_MOST:    </span><br><span class="line">   <span class="keyword">case</span> MeasureSpec.EXACTLY:        </span><br><span class="line">     result = specSize;  </span><br><span class="line">     <span class="keyword">break</span>;   </span><br><span class="line"> &#125;    </span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getDefaultSize的第一个参数size等于getSuggestedMinimumXXXX返回的的值（建议的最小宽度和高度），而建议的最小宽度和高度都是由View的Background尺寸与通过设置View的minXXX属性共同决定的，这个size可以理解为View的默认长度，而第二个参数measureSpec，是父View传给自己的MeasureSpec,这个measureSpec是通过测量计算出来的，具体的计算测量过程前面在讲解MeasureSpec已经讲得比较清楚了（是有父View的MeasureSpec和子View自己的LayoutParams 共同决定的）只要这个测试的mode不是UNSPECIFIED（未确定的），那么默认的就会用这个测量的数值当做View的高度。</p>
<p>对于View默认是测量很简单，大部分情况就是拿计算出来的MeasureSpec的size 当做最终测量的大小。而对于其他的一些View的派生类，如TextView、Button、ImageView等，它们的onMeasure方法系统了都做了重写，不会这么简单直接拿 MeasureSpec 的size来当大小，而去会先去测量字符或者图片的高度等，然后拿到View本身content这个高度（字符高度等），如果MeasureSpec是AT_MOST，而且View本身content的高度不超出MeasureSpec的size，那么可以直接用View本身content的高度（字符高度等），而不是像View.java 直接用MeasureSpec的size做为View的大小。</p>
<h2 id="4、ViewGroup的Measure过程"><a href="#4、ViewGroup的Measure过程" class="headerlink" title="4、ViewGroup的Measure过程"></a>4、ViewGroup的Measure过程</h2><p>ViewGroup 类并没有实现onMeasure，我们知道测量过程其实都是在onMeasure方法里面做的，我们来看下FrameLayout 的onMeasure 方法,具体分析看注释哦。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//FrameLayout 的测量</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;  </span><br><span class="line">....</span><br><span class="line"><span class="keyword">int</span> maxHeight = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> maxWidth = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> childState = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;    </span><br><span class="line">   <span class="keyword">final</span> View child = getChildAt(i);    </span><br><span class="line">   <span class="keyword">if</span> (mMeasureAllChildren || child.getVisibility() != GONE) &#123;   </span><br><span class="line">    <span class="comment">// 遍历自己的子View，只要不是GONE的都会参与测量，measureChildWithMargins方法在最上面</span></span><br><span class="line">    <span class="comment">// 的源码已经讲过了，如果忘了回头去看看，基本思想就是父View把自己的MeasureSpec </span></span><br><span class="line">    <span class="comment">// 传给子View结合子View自己的LayoutParams 算出子View 的MeasureSpec，然后继续往下传，</span></span><br><span class="line">    <span class="comment">// 传递叶子节点，叶子节点没有子View，根据传下来的这个MeasureSpec测量自己就好了。</span></span><br><span class="line">     measureChildWithMargins(child, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec, <span class="number">0</span>);       </span><br><span class="line">     <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams(); </span><br><span class="line">     maxWidth = Math.max(maxWidth, child.getMeasuredWidth() +  lp.leftMargin + lp.rightMargin);        </span><br><span class="line">     maxHeight = Math.max(maxHeight, child.getMeasuredHeight() + lp.topMargin + lp.bottomMargin);  </span><br><span class="line">     ....</span><br><span class="line">     ....</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">.....</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>
<p>//所有的孩子测量之后，经过一系类的计算之后通过setMeasuredDimension设置自己的宽高，<br>//对于FrameLayout 可能用最大的字View的大小，对于LinearLayout，可能是高度的累加，<br>//具体测量的原理去看看源码。总的来说，父View是等所有的子View测量结束之后，再来测量自己。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),        </span><br><span class="line">resolveSizeAndState(maxHeight, heightMeasureSpec, childState &lt;&lt; MEASURED_HEIGHT_STATE_SHIFT));</span><br><span class="line">....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到目前为止，基本把Measure 主要原理都过了一遍，接下来我们会结合实例来讲解整个match的过程，首先看下面的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;LinearLayout  xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;    </span><br><span class="line">   android:id=&quot;@+id/linear&quot;</span><br><span class="line">   android:layout_width=&quot;match_parent&quot;    </span><br><span class="line">   android:layout_height=&quot;wrap_content&quot;    </span><br><span class="line">   android:layout_marginTop=&quot;50dp&quot;    </span><br><span class="line">   android:background=&quot;@android:color/holo_blue_dark&quot;    </span><br><span class="line">   android:paddingBottom=&quot;70dp&quot;    </span><br><span class="line">   android:orientation=&quot;vertical&quot;&gt;    </span><br><span class="line">   &lt;TextView        </span><br><span class="line">    android:id=&quot;@+id/text&quot;       </span><br><span class="line">    android:layout_width=&quot;match_parent&quot;     </span><br><span class="line">    android:layout_height=&quot;wrap_content&quot;  </span><br><span class="line">    android:background=&quot;@color/material_blue_grey_800&quot;       </span><br><span class="line">    android:text=&quot;TextView&quot;        </span><br><span class="line">    android:textColor=&quot;@android:color/white&quot;        </span><br><span class="line">    android:textSize=&quot;20sp&quot; /&gt;    </span><br><span class="line">   &lt;View       </span><br><span class="line">      android:id=&quot;@+id/view&quot;       </span><br><span class="line">     android:layout_width=&quot;match_parent&quot; </span><br><span class="line">     android:layout_height=&quot;150dp&quot;    </span><br><span class="line">     android:background=&quot;@android:color/holo_green_dark&quot; /&gt;</span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://upload-images.jianshu.io/upload_images/966283-4a11f92ac8c5e224.png" alt="image"><br>上面的代码对于出来的布局是下面的一张图</p>
<p>对于上面图可能有些不懂，这边做下说明:</p>
<blockquote>
<p>整个图是一个DecorView,DecorView可以理解成整个页面的根View,DecorView是一个FrameLayout,包含两个子View，一个id=statusBarBackground的View和一个是LineaLayout，id=statusBarBackground的View，我们可以先不管（我也不是特别懂这个View,应该就是statusBar的设置背景的一个控件，方便设置statusBar的背景)，而这个LinearLayout比较重要，它包含一个title和一个content，title很好理解其实就是TitleBar或者ActionBar,content 就更简单了，setContentView()方法你应该用过吧，android.R.id.content 你应该听过吧，没错就是它,content是一个FrameLayout，你写的页面布局通过setContentView加进来就成了content的直接子View。</p>
</blockquote>
<p>整个View的布局图如下：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/966283-4096801e91e2eccc.png" alt="image"><br>这张图在下面分析measure，会经常用到，主要用于了解递归的时候view 的measure顺序</p>
<blockquote>
<p>注:<br>1、 header的是个ViewStub,用来惰性加载ActionBar，为了便于分析整个测量过程，我把Theme设成NoActionBar，避免ActionBar 相关的measure干扰整个过程，这样可以忽略掉ActionBar 的测量，在调试代码更清晰。<br>2、包含Header(ActionBar）和id/content 的那个父View，我不知道叫什么名字好，我们姑且叫它ViewRoot（看上图）,它是垂直的LinearLayout，放着整个页面除statusBar 的之外所有的东西，叫它ViewRoot 应该还ok，一个代号而已。</p>
</blockquote>
<p>既然我们知道整个View的Root是DecorView，那么View的绘制是从哪里开始的呢，我们知道每个Activity 均会创建一个 PhoneWindow对象，是Activity和整个View系统交互的接口，每个Window都对应着一个View和一个ViewRootImpl，Window和View通过ViewRootImpl来建立联系,对于Activity来说，ViewRootImpl是连接WindowManager和DecorView的纽带,绘制的入口是由ViewRootImpl的performTraversals方法来发起Measure，Layout，Draw等流程的。</p>
<p>我们来看下ViewRootImpl的performTraversals 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123; </span><br><span class="line">...... </span><br><span class="line"><span class="keyword">int</span> childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width); </span><br><span class="line"><span class="keyword">int</span> childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height); </span><br><span class="line">...... </span><br><span class="line">mView.measure(childWidthMeasureSpec, childHeightMeasureSpec); </span><br><span class="line">......</span><br><span class="line">mView.layout(<span class="number">0</span>, <span class="number">0</span>, mView.getMeasuredWidth(), mView.getMeasuredHeight());</span><br><span class="line">...... </span><br><span class="line">mView.draw(canvas); </span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getRootMeasureSpec</span><span class="params">(<span class="keyword">int</span> windowSize, <span class="keyword">int</span> rootDimension)</span> </span>&#123; </span><br><span class="line">   <span class="keyword">int</span> measureSpec; </span><br><span class="line">   <span class="keyword">switch</span> (rootDimension) &#123; </span><br><span class="line">   <span class="keyword">case</span> ViewGroup.LayoutParams.MATCH_PARENT: </span><br><span class="line">   <span class="comment">// Window can't resize. Force root view to be windowSize.   </span></span><br><span class="line">   measureSpec = MeasureSpec.makeMeasureSpec(windowSize,MeasureSpec.EXACTLY);</span><br><span class="line">   <span class="keyword">break</span>; </span><br><span class="line">   ...... </span><br><span class="line">  &#125; </span><br><span class="line"> <span class="keyword">return</span> measureSpec; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>performTraversals 中我们看到的mView其实就是DecorView,View的绘制从DecorView开始， 在mView.measure()的时候调用getRootMeasureSpec获得两个MeasureSpec做为参数，getRootMeasureSpec的两个参数（mWidth, lp.width）mWith和mHeight 是屏幕的宽度和高度， lp是WindowManager.LayoutParams，它的lp.width和lp.height的默认值是MATCH_PARENT,所以通过getRootMeasureSpec 生成的测量规格MeasureSpec 的mode是MATCH_PARENT ，size是屏幕的高宽。<br>因为DecorView 是一个FrameLayout 那么接下来会进入FrameLayout 的measure方法，measure的两个参数就是刚才getRootMeasureSpec的生成的两个MeasureSpec，DecorView的测量开始了。<br>首先是DecorView 的 MeasureSpec ，根据上面的分析DecorView 的 MeasureSpec是Windows传过来的，我们画出DecorView 的MeasureSpec 图：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/966283-c330852c971b02a8.png" alt="image"></p>
<blockquote>
<p>注：<br>1、-1 代表的是EXACTLY，-2 是AT_MOST<br>2、由于屏幕的像素是1440x2560,所以DecorView 的MeasureSpec的size 对应于这两个值</p>
</blockquote>
<p>那么接下来在FrameLayout 的onMeasure()方法DecorView开始for循环测量自己的子View,测量完所有的子View再来测量自己，由下图可知，接下来要测量ViewRoot的大小<br><img src="https://upload-images.jianshu.io/upload_images/966283-4096801e91e2eccc.png" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//FrameLayout 的测量</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;  </span><br><span class="line">....</span><br><span class="line"><span class="keyword">int</span> maxHeight = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> maxWidth = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> childState = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;    </span><br><span class="line">   <span class="keyword">final</span> View child = getChildAt(i);    </span><br><span class="line">   <span class="keyword">if</span> (mMeasureAllChildren || child.getVisibility() != GONE) &#123;   </span><br><span class="line">    <span class="comment">// 遍历自己的子View，只要不是GONE的都会参与测量，measureChildWithMargins方法在最上面</span></span><br><span class="line">    <span class="comment">// 的源码已经讲过了，如果忘了回头去看看，基本思想就是父View把自己当MeasureSpec </span></span><br><span class="line">    <span class="comment">// 传给子View结合子View自己的LayoutParams 算出子View 的MeasureSpec，然后继续往下穿，</span></span><br><span class="line">    <span class="comment">// 传递叶子节点，叶子节点没有子View，只要负责测量自己就好了。</span></span><br><span class="line">     measureChildWithMargins(child, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec, <span class="number">0</span>);      </span><br><span class="line">     ....</span><br><span class="line">     ....</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DecorView 测量ViewRoot 的时候把自己的widthMeasureSpec和heightMeasureSpec传进去了，接下来你就要去看measureChildWithMargins的源码了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildWithMargins</span><span class="params">(View child, <span class="keyword">int</span> parentWidthMeasureSpec, <span class="keyword">int</span> widthUsed, <span class="keyword">int</span> parentHeightMeasureSpec, <span class="keyword">int</span> heightUsed)</span> </span>&#123; </span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();   </span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,            </span><br><span class="line">mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin + widthUsed, lp.width);    </span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,           </span><br><span class="line">mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin  + heightUsed, lp.height);  </span><br><span class="line"></span><br><span class="line">child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ViewRoot 是系统的View，它的LayoutParams默认都是match_parent,根据我们文章最开始MeasureSpec 的计算规则，ViewRoot 的MeasureSpec mode应该等于EXACTLY（DecorView MeasureSpec 的mode是EXACTLY，ViewRoot的layoutparams 是match_parent），size 也等于DecorView的size，所以ViewRoot的MeasureSpec图如下：<br><img src="https://upload-images.jianshu.io/upload_images/966283-ed0ffedcca47672a.png" alt="image"></p>
<p>算出ViewRoot的MeasureSpec 之后，开始调用ViewRoot.measure 方法去测量ViewRoot的大小，然而ViewRoot是一个LinearLayout ，ViewRoot.measure最终会执行的LinearLayout 的onMeasure 方法，LinearLayout 的onMeasure 方法又开始逐个测量它的子View，上面的measureChildWithMargins方法又会被调用，那么根据View的层级图，接下来测量的是header（ViewStub）,由于header的Gone，所以直接跳过不做测量工作，所以接下来轮到ViewRoot的第二个child content（android.R.id.content）,我们要算出这个content 的MeasureSpec，所以又要拿ViewRoot 的MeasureSpec 和 android.R.id.content的LayoutParams 做计算了，计算过程就是调用getChildMeasureSpec的方法，</p>
<p><img src="https://upload-images.jianshu.io/upload_images/966283-527eb25fd49d38ef.png" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildWithMargins</span><span class="params">(View child, <span class="keyword">int</span> parentWidthMeasureSpec, <span class="keyword">int</span> widthUsed, <span class="keyword">int</span> parentHeightMeasureSpec, <span class="keyword">int</span> heightUsed)</span> </span>&#123; </span><br><span class="line">   .....</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,           </span><br><span class="line">mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin  + heightUsed, lp.height);  </span><br><span class="line">   ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getChildMeasureSpec</span><span class="params">(<span class="keyword">int</span> spec, <span class="keyword">int</span> padding, <span class="keyword">int</span> childDimension)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(spec);  <span class="comment">//获得父View的mode  </span></span><br><span class="line">    <span class="keyword">int</span> specSize = MeasureSpec.getSize(spec);  <span class="comment">//获得父View的大小  </span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">int</span> size = Math.max(<span class="number">0</span>, specSize - padding); <span class="comment">//父View的大小-自己的Padding+子View的Margin，得到值才是子View可能的最大值。  </span></span><br><span class="line">     .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由上面的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int size = Math.max(0, specSize - padding);</span><br></pre></td></tr></table></figure>
<p>而<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">padding=mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin + heightUsed</span><br></pre></td></tr></table></figure></p>
<p>算出android.R.id.content 的MeasureSpec 的size<br>由于ViewRoot 的mPaddingBottom=100px(这个可能和状态栏的高度有关，我们测量的最后会发现id/statusBarBackground的View的高度刚好等于100px，ViewRoot 是系统的View的它的Padding 我们没法改变，所以计算出来Content（android.R.id.content） 的MeasureSpec 的高度少了100px ，它的宽高的mode 根据算出来也是EXACTLY（ViewRoot 是EXACTLY和android.R.id.content 是match_parent）。所以Content（android.R.id.content）的MeasureSpec 如下（高度少了100px）：<br><img src="https://upload-images.jianshu.io/upload_images/966283-5ce615a3684d7815.png" alt="image"><br>Paste_Image.png<br>Content（android.R.id.content） 是FrameLayout，递归调用开始准备计算id/linear的MeasureSpec，我们先给出结果：<br><img src="https://upload-images.jianshu.io/upload_images/966283-c7e86f4510ddf84a.png" alt="image"></p>
<blockquote>
<p>图中有两个要注意的地方：<br>1、id/linear的heightMeasureSpec 的mode=AT_MOST，因为id/linear 的LayoutParams 的layout_height=”wrap_content”<br>2、id/linear的heightMeasureSpec 的size 少了200px, 由上面的代码<br>padding=mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin + heightUsed;<br>int size = Math.max(0, specSize - padding);<br>由于id/linear 的 android:layout_marginTop=”50dp” 使得lp.topMargin=200px (本设备的density=4，px=4*pd)，在计算后id/linear的heightMeasureSpec 的size 少了200px。（布局代码前面已给出，可自行查看id/linear 控件xml中设置的属性）</p>
</blockquote>
<p>linear.measure接着往下算linear的子View的的MeasureSpec，看下View 层级图，往下走应该是id/text,接下来是计算id/text的MeasureSpec，直接看图，mode=AT_MOST ,size 少了280，别问我为什么 …specSize - padding.<br><img src="https://upload-images.jianshu.io/upload_images/966283-058c5a6ce57b3125.png" alt="image"></p>
<p>算出id/text 的MeasureSpec 后，接下来text.measure(childWidthMeasureSpec, childHeightMeasureSpec);准备测量id/text 的高宽，这时候已经到底了，id/text是TextView，已经没有子类了，这时候跳到TextView的onMeasure方法了。TextView 拿着刚才计算出来的heightMeasureSpec（mode=AT_MOST,size=1980）,这个就是对TextView的高度和宽度的约束，进到TextView 的onMeasure(widthMeasureSpec,heightMeasureSpec) 方法，在onMeasure 方法执行调试过程中，我们发现下面的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">int desired = getDesiredHeight(); desired = 107px</span><br><span class="line">if(heightMode == MeasureSpec.AT_MOST)&#123;</span><br><span class="line">    height = Math.min(desired,heightSize); height = 1980px</span><br><span class="line">   &#125;</span><br><span class="line">    setMeasuredDimension(width,height);</span><br></pre></td></tr></table></figure>
<p>TextView字符的高度（也就是TextView的content高度[wrap_content]）测出来=107px，107px 并没有超过1980px(允许的最大高度)，所以实际测量出来TextView的高度是107px。<br>最终算出id/text 的mMeasureWidth=1440px,mMeasureHeight=107px。</p>
<p>贴一下布局代码，免得你忘了具体布局。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;LinearLayout  xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;    </span><br><span class="line">   android:id=&quot;@+id/linear&quot;</span><br><span class="line">   android:layout_width=&quot;match_parent&quot;    </span><br><span class="line">   android:layout_height=&quot;wrap_content&quot;    </span><br><span class="line">   android:layout_marginTop=&quot;50dp&quot;    </span><br><span class="line">   android:background=&quot;@android:color/holo_blue_dark&quot;    </span><br><span class="line">   android:paddingBottom=&quot;70dp&quot;    </span><br><span class="line">   android:orientation=&quot;vertical&quot;&gt;    </span><br><span class="line">   &lt;TextView        </span><br><span class="line">    android:id=&quot;@+id/text&quot;       </span><br><span class="line">    android:layout_width=&quot;match_parent&quot;     </span><br><span class="line">    android:layout_height=&quot;wrap_content&quot;  </span><br><span class="line">    android:background=&quot;@color/material_blue_grey_800&quot;       </span><br><span class="line">    android:text=&quot;TextView&quot;        </span><br><span class="line">    android:textColor=&quot;@android:color/white&quot;        </span><br><span class="line">    android:textSize=&quot;20sp&quot; /&gt;    </span><br><span class="line">   &lt;View       </span><br><span class="line">      android:id=&quot;@+id/view&quot;       </span><br><span class="line">     android:layout_width=&quot;match_parent&quot; </span><br><span class="line">     android:layout_height=&quot;150dp&quot;    </span><br><span class="line">     android:background=&quot;@android:color/holo_green_dark&quot; /&gt;</span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure>
<p>TextView的高度已经测量出来了，接下来测量id/linear的第二个child（id/view），同样的原理测出id/view的MeasureSpec.</p>
<p><img src="https://upload-images.jianshu.io/upload_images/966283-55810a48922ac8fe.png" alt="image"><br>id/view的MeasureSpec 计算出来后，调用view.measure(childWidthMeasureSpec, childHeightMeasureSpec)的测量id/view的高宽，之前已经说过View measure的默认实现是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;    </span><br><span class="line">  setMeasuredDimension(</span><br><span class="line">  getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),            </span><br><span class="line">  getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终算出id/view的mMeasureWidth=1440px,mMeasureHeight=600px。</p>
<p>id/linear 的子View的高度都计算完毕了，接下来id/linear就通过所有子View的测量结果计算自己的高宽，id/linear是LinearLayout，所有它的高度计算简单理解就是子View的高度的累积+自己的Padding.<br><img src="https://upload-images.jianshu.io/upload_images/966283-b089fd286ca7fc05.png" alt="image"></p>
<p>最终算出id/linear的mMeasureWidth=1440px,mMeasureHeight=987px。</p>
<p>最终算出id/linear出来后，id/content 就要根据它唯一的子View id/linear 的测量结果和自己的之前算出的MeasureSpec一起来测量自己的结果，具体计算的逻辑去看FrameLayout onMeasure 函数的计算过程。以此类推，接下来测量ViewRoot,然后再测量id/statusBarBackground,虽然不知道id/statusBarBackground 是什么，但是调试的过程中，测出的它的高度=100px, 和 id/content 的paddingTop 刚好相等。在最后测量DecorView 的高宽，最终整个测量过程结束。所有的View的大小测量完毕。所有的getMeasureWidth 和 getMeasureWidth 都已经有值了。Measure 分析到此为止，如有不懂，评论留言（简书：kelin）</p>
<h1 id="layout过程"><a href="#layout过程" class="headerlink" title="layout过程"></a>layout过程</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mView.measure(childWidthMeasureSpec, childHeightMeasureSpec); </span><br><span class="line">......</span><br><span class="line">mView.layout(0, 0, mView.getMeasuredWidth(), mView.getMeasuredHeight());</span><br></pre></td></tr></table></figure>
<p>performTraversals 方法执行完mView.measure 计算出mMeasuredXXX后就开始执行layout 函数来确定View具体放在哪个位置，我们计算出来的View目前只知道view矩阵的大小，具体这个矩阵放在哪里，这就是layout 的工作了。layout的主要作用 ：根据子视图的大小以及布局参数将View树放到合适的位置上。</p>
<p>既然是通过mView.layout(0, 0, mView.getMeasuredWidth(), mView.getMeasuredHeight()); 那我们来看下layout 函数做了什么，mView肯定是个ViewGroup，不会是View,我们直接看下ViewGroup 的layout函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;    </span><br><span class="line">   <span class="keyword">if</span> (!mSuppressLayout &amp;&amp; (mTransition == <span class="keyword">null</span> || !mTransition.isChangingLayout())) &#123;        </span><br><span class="line">    <span class="keyword">if</span> (mTransition != <span class="keyword">null</span>) &#123;            </span><br><span class="line">       mTransition.layoutChange(<span class="keyword">this</span>);        </span><br><span class="line">    &#125;       </span><br><span class="line">    <span class="keyword">super</span>.layout(l, t, r, b);    </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;        </span><br><span class="line">    <span class="comment">// record the fact that we noop'd it; request layout when transition finishes        </span></span><br><span class="line">      mLayoutCalledWhileSuppressed = <span class="keyword">true</span>;    </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码可以看个大概，LayoutTransition是用于处理ViewGroup增加和删除子视图的动画效果，也就是说如果当前ViewGroup未添加LayoutTransition动画，或者LayoutTransition动画此刻并未运行，那么调用super.layout(l, t, r, b)，继而调用到ViewGroup中的onLayout，否则将mLayoutSuppressed设置为true，等待动画完成时再调用requestLayout()。<br>这个函数是final 不能重写，所以ViewGroup的子类都会调用这个函数，layout 的具体实现是在super.layout(l, t, r, b)里面做的，那么我接下来看一下View类的layout函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">       .....</span><br><span class="line">      <span class="comment">//设置View位于父视图的坐标轴</span></span><br><span class="line">       <span class="keyword">boolean</span> changed = setFrame(l, t, r, b); </span><br><span class="line">       <span class="comment">//判断View的位置是否发生过变化，看有必要进行重新layout吗</span></span><br><span class="line">       <span class="keyword">if</span> (changed || (mPrivateFlags &amp; LAYOUT_REQUIRED) == LAYOUT_REQUIRED) &#123;</span><br><span class="line">           <span class="keyword">if</span> (ViewDebug.TRACE_HIERARCHY) &#123;</span><br><span class="line">               ViewDebug.trace(<span class="keyword">this</span>, ViewDebug.HierarchyTraceType.ON_LAYOUT);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//调用onLayout(changed, l, t, r, b); 函数</span></span><br><span class="line">           onLayout(changed, l, t, r, b);</span><br><span class="line">           mPrivateFlags &amp;= ~LAYOUT_REQUIRED;</span><br><span class="line">       &#125;</span><br><span class="line">       mPrivateFlags &amp;= ~FORCE_LAYOUT;</span><br><span class="line">       .....</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>1、setFrame(l, t, r, b) 可以理解为给mLeft 、mTop、mRight、mBottom赋值，然后基本就能确定View自己在父视图的位置了，这几个值构成的矩形区域就是该View显示的位置，这里的具体位置都是相对与父视图的位置。</p>
<p>2、回调onLayout，对于View来说，onLayout只是一个空实现，一般情况下我们也不需要重载该函数,：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;  </span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>对于ViewGroup 来说，唯一的差别就是ViewGroup中多了关键字abstract的修饰，要求其子类必须重载onLayout函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@Override  </span><br><span class="line">protected abstract void onLayout(boolean changed,  </span><br><span class="line">        int l, int t, int r, int b);</span><br></pre></td></tr></table></figure>
<p>而重载onLayout的目的就是安排其children在父视图的具体位置，那么如何安排子View的具体位置呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int childCount = getChildCount() ; </span><br><span class="line">  for(int i=0 ;i&lt;childCount ;i++)&#123;</span><br><span class="line">       View child = getChildAt(i) ;</span><br><span class="line">       //整个layout()过程就是个递归过程</span><br><span class="line">       child.layout(l, t, r, b) ;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>代码很简单，就是遍历自己的孩子，然后调用 child.layout(l, t, r, b) ，给子view 通过setFrame(l, t, r, b) 确定位置，而重点是(l, t, r, b) 怎么计算出来的呢。还记得我们之前测量过程，测量出来的MeasuredWidth和MeasuredHeight吗？还记得你在xml 设置的Gravity吗？还有RelativeLayout 的其他参数吗，没错，就是这些参数和MeasuredHeight、MeasuredWidth 一起来确定子View在父视图的具体位置的。具体的计算过程大家可以看下最简单FrameLayout 的onLayout 函数的源码，每个不同的ViewGroup 的实现都不一样，这边不做具体分析了吧。</p>
<p>3、MeasuredWidth和MeasuredHeight这两个参数为layout过程提供了一个很重要的依据（如果不知道View的大小，你怎么固定四个点的位置呢），但是这两个参数也不是必须的，layout过程中的4个参数l, t, r, b完全可以由我们任意指定，而View的最终的布局位置和大小（mRight - mLeft=实际宽或者mBottom-mTop=实际高）完全由这4个参数决定，measure过程得到的mMeasuredWidth和mMeasuredHeight提供了视图大小测量的值，但我们完全可以不使用这两个值，所以measure过程并不是必须的。如果我们不使用这两个值，那么getMeasuredWidth() 和getWidth() 就很有可能不是同一个值，它们的计算是不一样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getMeasuredWidth</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> mMeasuredWidth &amp; MEASURED_SIZE_MASK;  </span><br><span class="line">    &#125;  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> mRight - mLeft;  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>layout 过程相对简单些，分析就到此为止。</p>
<h1 id="draw过程"><a href="#draw过程" class="headerlink" title="draw过程"></a>draw过程</h1><p>performTraversals 方法的下一步就是mView.draw(canvas); 因为View的draw 方法一般不去重写，官网文档也建议不要去重写draw 方法，所以下一步执行就是View.java的draw 方法，我们来看下源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Draw traversal performs several drawing steps which must be executed</span></span><br><span class="line"><span class="comment">         * in the appropriate order:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *      1. Draw the background</span></span><br><span class="line"><span class="comment">         *      2. If necessary, save the canvas' layers to prepare for fading</span></span><br><span class="line"><span class="comment">         *      3. Draw view's content</span></span><br><span class="line"><span class="comment">         *      4. Draw children</span></span><br><span class="line"><span class="comment">         *      5. If necessary, draw the fading edges and restore layers</span></span><br><span class="line"><span class="comment">         *      6. Draw decorations (scrollbars for instance)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 1, draw the background, if needed</span></span><br><span class="line">    ...</span><br><span class="line">        background.draw(canvas);</span><br><span class="line">    ...</span><br><span class="line">        <span class="comment">// skip step 2 &amp; 5 if possible (common case)</span></span><br><span class="line">    ...</span><br><span class="line">        <span class="comment">// Step 2, save the canvas' layers</span></span><br><span class="line">    ...</span><br><span class="line">        <span class="keyword">if</span> (solidColor == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> flags = Canvas.HAS_ALPHA_LAYER_SAVE_FLAG;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (drawTop) &#123;</span><br><span class="line">                canvas.saveLayer(left, top, right, top + length, <span class="keyword">null</span>, flags);</span><br><span class="line">            &#125;</span><br><span class="line">    ...</span><br><span class="line">        <span class="comment">// Step 3, draw the content</span></span><br><span class="line">        <span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 4, draw the children</span></span><br><span class="line">        dispatchDraw(canvas);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 5, draw the fade effect and restore layers</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (drawTop) &#123;</span><br><span class="line">            matrix.setScale(<span class="number">1</span>, fadeHeight * topFadeStrength);</span><br><span class="line">            matrix.postTranslate(left, top);</span><br><span class="line">            fade.setLocalMatrix(matrix);</span><br><span class="line">            canvas.drawRect(left, top, right, top + length, p);</span><br><span class="line">        &#125;</span><br><span class="line">    ...</span><br><span class="line">        <span class="comment">// Step 6, draw decorations (scrollbars)</span></span><br><span class="line">        onDrawScrollBars(canvas);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>注释写得比较清楚，一共分成6步，看到注释没有（ // skip step 2 &amp; 5 if possible (common case)）除了2 和 5之外 我们一步一步来看：<br>1、第一步：背景绘制<br>看注释即可，不是重点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private void drawBackground(Canvas canvas) &#123; </span><br><span class="line">     Drawable final Drawable background = mBackground; </span><br><span class="line">      ...... </span><br><span class="line">     //mRight - mLeft, mBottom - mTop layout确定的四个点来设置背景的绘制区域 </span><br><span class="line">     if (mBackgroundSizeChanged) &#123; </span><br><span class="line">        background.setBounds(0, 0, mRight - mLeft, mBottom - mTop);   </span><br><span class="line">        mBackgroundSizeChanged = false; rebuildOutline(); </span><br><span class="line">     &#125; </span><br><span class="line">     ...... </span><br><span class="line">     //调用Drawable的draw() 把背景图片画到画布上</span><br><span class="line">     background.draw(canvas); </span><br><span class="line">     ...... </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、第三步，对View的内容进行绘制。<br>onDraw(canvas) 方法是view用来draw 自己的，具体如何绘制，颜色线条什么样式就需要子View自己去实现，View.java 的onDraw(canvas) 是空实现，ViewGroup 也没有实现，每个View的内容是各不相同的，所以需要由子类去实现具体逻辑。</p>
<p>3、第4步 对当前View的所有子View进行绘制<br>dispatchDraw(canvas) 方法是用来绘制子View的，View.java 的dispatchDraw()方法是一个空方法,因为View没有子View,不需要实现dispatchDraw ()方法，ViewGroup就不一样了，它实现了dispatchDraw ()方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"> protected void dispatchDraw(Canvas canvas) &#123;</span><br><span class="line">       ...</span><br><span class="line">        if ((flags &amp; FLAG_USE_CHILD_DRAWING_ORDER) == 0) &#123;</span><br><span class="line">            for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">                final View child = children[i];</span><br><span class="line">                if ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || child.getAnimation() != null) &#123;</span><br><span class="line">                    more |= drawChild(canvas, child, drawingTime);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">                final View child = children[getChildDrawingOrder(count, i)];</span><br><span class="line">                if ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || child.getAnimation() != null) &#123;</span><br><span class="line">                    more |= drawChild(canvas, child, drawingTime);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>代码一眼看出，就是遍历子View然后drawChild(),drawChild()方法实际调用的是子View.draw()方法,ViewGroup类已经为我们实现绘制子View的默认过程，这个实现基本能满足大部分需求，所以ViewGroup类的子类（LinearLayout,FrameLayout）也基本没有去重写dispatchDraw方法，我们在实现自定义控件，除非比较特别，不然一般也不需要去重写它， drawChild()的核心过程就是为子视图分配合适的cavas剪切区，剪切区的大小正是由layout过程决定的，而剪切区的位置取决于滚动值以及子视图当前的动画。设置完剪切区后就会调用子视图的draw()函数进行具体的绘制了。</p>
<p>4、第6步 对View的滚动条进行绘制<br>不是重点，知道有这东西就行，onDrawScrollBars 的一句注释 ：Request the drawing of the horizontal and the vertical scrollbar. The scrollbars are painted only if they have been awakened first.</p>
<p>一张图看下整个draw的递归流程。</p>
<p>到此整个绘制过程基本讲述完毕了。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2017/10/12/view 绘制机制/" data-id="cjgzcn7q7000m6x0ca747nteq" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2017/10/12/view 绘制机制/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2017/10/12/view 绘制机制/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Linux 用户空间 内核空间" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/07/Linux 用户空间 内核空间/">linux用户控件、内和空间</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/07/Linux 用户空间 内核空间/">
            <time datetime="2017-09-07T12:30:15.000Z" itemprop="datePublished">2017-09-07</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Linux/">Linux</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/linux/">linux</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>用户空间就是用户进程所在的内存区域，相对的，系统空间就是操作系统占据的内存区域。</p>
<p>用户进程和系统进程的所有数据都在内存中。<br>  是谁来划分内存空间的呢？</p>
<p>  在电脑开机之前，内存就是一块原始的物理内存。什么也没有。开机加电，系统启动后，就对物理内存进行了划分。当然，这是系统的规定，物理内存条上并没有划分好的地址和空间范围。这些划分都是操作系统在逻辑上的划分。不同版本的操作系统划分的结果都是不一样的。<br>  为什么要划分用户空间和系统空间呢？当然是有必要的。操作系统的数据都是存放于系统空间的，用户进程的数据是存放于用户空间的。这是第一点，不同的身份，数据放置的位置必然不一样，否则大混战就会导致系统的数据和用户的数据混在一起，系统就不能很好的运行了。分开来存放，就让系统的数据和用户的数据互不干扰，保证系统的稳定性。分开存放，管理上很方便，而更重要的是，将用户的数据和系统的数据隔离开，就可以对两部分的数据的访问进行控制。这样就可以确保用户程序不能随便操作系统的数据，这样防止用户程序误操作或者是恶意破坏系统。</p>
<p>处于用户态的程序只能访问用户空间，而处于内核态的程序可以访问用户空间和内核空间。那么用户态和内核态有什么区别呢？</p>
<p>当一个任务（进程）执行系统调用而陷入内核代码中执行时，我们就称进程处于内核运行态（或简称为内核态）。此时处理器处于特权级最高的（0级）内核代码中执行。当进程处于内核态时，执行的内核代码会使用当前进程的内核栈。每个进程都有自己的内核栈。当进程在执行用户自己的代码时，则称其处于用户运行态（用户态）。即此时处理器在特权级最低的（3级）用户代码中运行。</p>
<p>内核态与用户态是操作系统的两种运行级别,Intel x86架构提供Ring0-Ring3四种级别的运行模式，Ring0级别最高，Ring3最低。Linux使用了Ring3级别运行用户态，Ring0作为 内核态，没有使用Ring1和Ring2。Ring3状态不能访问Ring0的地址空间，包括代码和数据。程序特权级别的不同，其所拥有的权力也不同。如下图所示。</p>
<p><img src="https://img-blog.csdn.net/20170610171008637?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzQyMjg1NzA=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="image"></p>
<p>用户态切换到内核态的3种方式</p>
<h4 id="a-系统调用"><a href="#a-系统调用" class="headerlink" title="a. 系统调用"></a>a. 系统调用</h4><blockquote>
<p>这是用户态进程主动要求切换到内核态的一种方式，用户态进程通过系统调用申请使用操作系统提供的服务程序完成工作，比如fork()实际上就是执行了一个创建新进程的系统调用。而系统调用的机制其核心还是使用了操作系统为用户特别开放的一个中断来实现，例如Linux的int 80h中断。</p>
</blockquote>
<h4 id="b-异常"><a href="#b-异常" class="headerlink" title="b. 异常"></a>b. 异常</h4><blockquote>
<p>当CPU在执行运行在用户态下的程序时，发生了某些事先不可知的异常，这时会触发由当前运行进程切换到处理此异常的内核相关程序中，也就转到了内核态，比如缺页异常。</p>
</blockquote>
<h4 id="c-外围设备的中断"><a href="#c-外围设备的中断" class="headerlink" title="c. 外围设备的中断"></a>c. 外围设备的中断</h4><blockquote>
<p>当外围设备完成用户请求的操作后，会向CPU发出相应的中断信号，这时CPU会暂停执行下一条即将要执行的指令转而去执行与中断信号对应的处理程序，如果先前执行的指令是用户态下的程序，那么这个转换的过程自然也就发生了由用户态到内核态的切换。比如硬盘读写操作完成，系统会切换到硬盘读写的中断处理程序中执行后续操作等。</p>
</blockquote>
<p>这3种方式是系统在运行时由用户态转到内核态的最主要方式，其中系统调用可以认为是用户进程主动发起的，异常和外围设备中断则是被动的。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2017/09/07/Linux 用户空间 内核空间/" data-id="cjgzcn7pt00066x0c13p8x843" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2017/09/07/Linux 用户空间 内核空间/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2017/09/07/Linux 用户空间 内核空间/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-webrtc 音频" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/08/16/webrtc 音频/">webrtc音频总结</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/08/16/webrtc 音频/">
            <time datetime="2017-08-16T13:10:30.000Z" itemprop="datePublished">2017-08-16</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/webrtc/">webrtc</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/webrtc/">webrtc</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>webrtc/modules/audio_device/android/audio_record_jni.cc</p>
<p>这个文件，是音频采集jni类文件。</p>
<p>Android Audio Record 和 JNI 通信接口包括：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// java 调用 c++ 接口</span><br><span class="line">nativeCacheDirectBufferAddress</span><br><span class="line">nativeDataIsRecorded</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// c++ 回调 java 接口</span><br><span class="line">initRecording</span><br><span class="line">startRecording</span><br><span class="line">stopRecording</span><br><span class="line">enableBuiltInAEC</span><br><span class="line">enableBuiltInNS</span><br></pre></td></tr></table></figure>
<p>nativeCacheDirectBufferAddress 和 nativeDataIsRecorded 只是为了高效的将 AudioRecord 采集到的音频数据传递给 native。</p>
<h1 id="WebRtcVoiceEngine"><a href="#WebRtcVoiceEngine" class="headerlink" title="WebRtcVoiceEngine"></a>WebRtcVoiceEngine</h1><p>WebRtcVoiceEngine 初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">WebRtcVoiceEngine::Init()&#123;</span><br><span class="line">    send_codecs_ = CollectCodecs(encoder_factory_-&gt;GetSupportedEncoders());</span><br><span class="line">    recv_codecs_ = CollectCodecs(decoder_factory_-&gt;GetSupportedDecoders());</span><br><span class="line"></span><br><span class="line">    adm_ = webrtc::AudioDeviceModule::Create(</span><br><span class="line">        webrtc::AudioDeviceModule::kPlatformDefaultAudio</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    webrtc::adm_helpers::Init(adm());</span><br><span class="line">    webrtc::apm_helpers::Init(apm());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可知，WebRtcVoiceEngine 里面的 adm_ 就是 AudioDeviceModule ，代码在 /modules/audio_device/audio_device_impl.cc</p>
<p>在 webrtcvoiceengine.h<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">// WebRtcVoiceEngine</span><br><span class="line"></span><br><span class="line">//public </span><br><span class="line">void Init();</span><br><span class="line">AudioState GetAudioState();</span><br><span class="line">VoiceMediaChannel* CreateChannel(Call call, MediaConfig config, AudioOptions options);</span><br><span class="line">AudioCodec send_codecs();</span><br><span class="line">AudioCodec recv_codecs();</span><br><span class="line">RtpCapabilities GetCapabilities();</span><br><span class="line"></span><br><span class="line">void RegisterChannel(WebRtcVoiceMediaChannel* channel);</span><br><span class="line">void UnregisterChannel(WebRtcVoiceMediaChannel* channel);</span><br><span class="line"></span><br><span class="line">bool StartAecDump();</span><br><span class="line">void StopAecDump();</span><br><span class="line"></span><br><span class="line">//private</span><br><span class="line">AudioDeviceModule adm_;</span><br><span class="line">AudioEncoderFactory encoder_factory_;</span><br><span class="line">AudioDecoderFactory decoder_factory_;</span><br><span class="line">AudioMixer audio_mixer_;</span><br><span class="line">AudioProcessing apm_;</span><br><span class="line">AudioState audio_state_;</span><br><span class="line">AudioCodec send_codecs_;</span><br><span class="line">AudioCodec recv_codecs_;</span><br><span class="line"></span><br><span class="line">WebRtcVoiceMediaChannel channels_;</span><br></pre></td></tr></table></figure></p>
<h2 id="audio-device"><a href="#audio-device" class="headerlink" title="audio_device"></a>audio_device</h2><p>//webrtc/modules/audio_device/</p>
<p>audio_device_impl.cc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">AudioDeviceModule::Create()&#123;</span><br><span class="line">    audioDevice(new AudioDeviceModuleImpl(audio_layer));</span><br><span class="line"></span><br><span class="line">    audioDevice-&gt;CheckPlatform();</span><br><span class="line">    audioDevice-&gt;CreatePlatformSpecificObjects();</span><br><span class="line">    audioDevice-&gt;AttachAudioBuffer();</span><br><span class="line"></span><br><span class="line">    return audioDevice;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">AudioDeviceModuleImpl::CreatePlatformSpecificObjects()&#123;</span><br><span class="line">    // WEBRTC_DUMMY_AUDIO_BUILD</span><br><span class="line">    audio_device_.reset(new AudioDeviceDummy());</span><br><span class="line">    // WEBRTC_DUMMY_FILE_DEVICES</span><br><span class="line">    audio_device_.reset(FileAudioFactory::CreateFileAudioDevice());</span><br><span class="line"></span><br><span class="line">    // WEBRTC_WINDOWS_CORE_AUDIO_BUILD</span><br><span class="line">    audio_device_.reset(new AudioDeviceWindowsCore());</span><br><span class="line"></span><br><span class="line">    // WEBRTC_ANDROID</span><br><span class="line">    audio_manager_android_.reset(new AudioManager());</span><br><span class="line">    if(audio_layer == kPlatformDefaultAudio)&#123;</span><br><span class="line">        audio_layer = kAndroidOpenSLESAudio;</span><br><span class="line">    &#125; else if(isLowLatencySupported)&#123;</span><br><span class="line">        audio_layer = kAndroidJavaInputAndroidOpenSLESOutputAudio;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        audio_layer = kAndroidJavaAudio;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(kAndroidJavaAudio)&#123;</span><br><span class="line">        audio_device_.reset(new AudioDeviceTemplate&lt;AudioRecordJni, AudioTrackJni&gt;())</span><br><span class="line">    &#125; else if(kAndroidOpenSLESAudio)&#123;</span><br><span class="line">        audio_device_.reset(new AudioDeviceTemplate&lt;OpenSLESRecorder, OpenSLESPlayer&gt;());</span><br><span class="line">    &#125; else if(kAndroidJavaInputAndOpenSLESOutputAudio)&#123;</span><br><span class="line">        audio_device_.reset(new AudioDeviceTemplate&lt;AudioRecordJni, OpenSLESPlayer&gt;())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // WEBRTC_LINUX</span><br><span class="line">    if(kLinuxPulseAudio || kPlatformDefaultAudio)&#123;</span><br><span class="line">        audio_device_.reset(new AudioDeviceLinuxPulse())</span><br><span class="line">    &#125; else if(kLinuxAlsaAudio)&#123;</span><br><span class="line">        audio_device_.reset(new AudioDeviceLinuxALSA())</span><br><span class="line">    &#125;</span><br><span class="line">    // WEBRTC_IOS</span><br><span class="line">    audio_device_.reset(new AudioDeviceIOS())</span><br><span class="line">    // WEBRTC_MAC</span><br><span class="line">    audio_device_.reset(new AudioDeviceMac())</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们以 Android 为例；使用 AudioDeviceTemplate 封装 音频输入（采集）、输出类型（渲染）；<br>目前使用 AudioRecordJni 和 AudioTrackJni。<br>如果直接使用 NDK 的openSLES 开发的化，使用的是 OpenSLESRecorder 和 OpenSLESPlayer。</p>
<p>audio_manager.h<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// JavaAudioManager</span><br><span class="line">bool Init()</span><br><span class="line">void Close()</span><br><span class="line">bool IsCommunicationModeEnabled()</span><br><span class="line">bool IsDeviceBlacklistedForOpenSLESUsage()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// private</span><br><span class="line">JNICALL CacheAudioParameters()</span><br><span class="line">void OnCacheAudioParameters()</span><br></pre></td></tr></table></figure></p>
<p>audio_record_jni.h<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">//JavaAudioRecord</span><br><span class="line">int InitRecording(int sample_reate, size_t channels);</span><br><span class="line">bool StartRecording();</span><br><span class="line">bool StopRecording();</span><br><span class="line">bool EnableBuiltInAEC(bool enable);</span><br><span class="line">bool EnableBuiltInNS(bool enable);</span><br><span class="line"></span><br><span class="line">// public</span><br><span class="line">int32_t Init();</span><br><span class="line">int32_t Terminate();</span><br><span class="line"></span><br><span class="line">int32_t InitRecording();</span><br><span class="line">bool RecordingIsInitialized();</span><br><span class="line"></span><br><span class="line">int32_t StartRecording();</span><br><span class="line">int32_t StopRecording();</span><br><span class="line">bool Recording();</span><br><span class="line"></span><br><span class="line">void AttachAudioBuffer();</span><br><span class="line">int32_t EnableBuiltInAEC(bool enable);</span><br><span class="line">int32_t EnableBuiltInAGC(bool enable);</span><br><span class="line">int32_t EnableBuiltInNS(bool enable);</span><br><span class="line"></span><br><span class="line">// private</span><br><span class="line">JNICALL CacheDirectBufferAddress()</span><br><span class="line">void OnCacheDirectBufferAddress(jobject byte_buffer)</span><br><span class="line"></span><br><span class="line">JNICALL DataIsRecorded();</span><br><span class="line">void OnDataIsRecorded(int length);</span><br></pre></td></tr></table></figure></p>
<p>audio_track_jni.h</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// JavaAudioTrack</span><br><span class="line">bool InitPlayout(int sample_rate, int channels);</span><br><span class="line">bool StartPlayout();</span><br><span class="line">bool StopPlayout();</span><br><span class="line">bool SetStreamVolume(int volume);</span><br><span class="line">int GetStreamMaxVolume();</span><br><span class="line">int GetStreamVolume();</span><br><span class="line"></span><br><span class="line">// public</span><br><span class="line">Init()</span><br><span class="line">Terminate()</span><br><span class="line">InitPlayout()</span><br><span class="line">PlayoutIsInitialized()</span><br><span class="line">StartPlayout()</span><br><span class="line">StopPlayout()</span><br><span class="line">Playing()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SpeakerVolumeIsAvailable(bool available);</span><br><span class="line">SetSpeakerVolume(volume);</span><br><span class="line">SpeakerVolume(volume);</span><br><span class="line">MaxSpeakerVolume(max_volume);</span><br><span class="line">MinSpeakerVolume(min_volume);</span><br><span class="line">AttachAudioBuffer(audioBuffer);</span><br><span class="line"></span><br><span class="line">// private</span><br><span class="line">JNICALL CacheDirectBufferAddress();</span><br><span class="line">void OnCacheDirectBufferAddress(jobject byte_buffer);</span><br><span class="line"></span><br><span class="line">JNICALL GetPlayoutData();</span><br><span class="line">void OnGetPlayoutData(size_t length);</span><br></pre></td></tr></table></figure>
<h3 id="AudioRecordJni"><a href="#AudioRecordJni" class="headerlink" title="AudioRecordJni"></a>AudioRecordJni</h3><h4 id="音频采集初始化"><a href="#音频采集初始化" class="headerlink" title="音频采集初始化"></a>音频采集初始化</h4><p>AudioRecordJni 初始化时，在构造方法中初始化 JavaAudioRecord。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">j_audio-record_.reset(</span><br><span class="line">    new JavaAudioRecord()</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>然后在 webrtcvoiceengine 中 AddSendStream 后，SetSend() 配置媒体通道发送。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//media/engine/webrtcvoiceengine.cc</span><br><span class="line">WebRtcVoiceMediaChannel::SetSend(bool send)&#123;</span><br><span class="line">    ...</span><br><span class="line">    if(send)&#123;</span><br><span class="line">        engine()-&gt;ApplyOptions(options_);</span><br><span class="line">        if(!engine()-&gt;adm()-&gt;RecordingIsInitialized() </span><br><span class="line">        &amp;&amp; !engine()-&gt;adm()-&gt;Recording())&#123;</span><br><span class="line"></span><br><span class="line">            engine()-&gt;adm()-&gt;InitRecording();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里面会初始化 AudioRecord。</p>
<p>InitRecording() 方法实现，在 Android 中实在 audio_record_jni.cc 的 JavaAudioRecord::InitRecording() ，最终通过 JNI 回调 Java 层的 InitRecording() 方法。</p>
<h4 id="音频采集"><a href="#音频采集" class="headerlink" title="音频采集"></a>音频采集</h4><p>初始化完成后，就要开始采集音频数据。</p>
<p>/audio/audio_send_stream.cc<br>音频发送流里面 AudioSendStream::Start() 方法启动音频流发送；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AudioSendSstream::Start()&#123;</span><br><span class="line">    channel_proxy_-&gt;StartSend();</span><br><span class="line">    audio_state()-&gt;AddSendingStream(this, encoder_sample_rate_hz_, encoder_num_channels_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用 /audio/audio_state.cc 的 AudioState::AddSendingStream() 方法；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">AudioState::AddSendingStream()&#123;</span><br><span class="line">    auto* adm = config_.audio_device_module.get();</span><br><span class="line">    ...</span><br><span class="line">    amd-&gt;StartRecording();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="音频开关"><a href="#音频开关" class="headerlink" title="音频开关"></a>音频开关</h4><p>另外，PeerConnection 提供了 音频采集开关。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//org.webrtc.PeerConnection.java</span><br><span class="line">public void setAudioRecording(boolean recording)&#123;</span><br><span class="line">    nativeSetAudioRecording();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的JNI方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//JNI/pc/peerconnection.cc</span><br><span class="line">void JNI_PeerConnection_SetAudioRecording()&#123;</span><br><span class="line">    ExtractNativePC(jni,j_pc)-&gt;SetAudioRecording(recording);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其实JNI方法也是调用 webrtc 的 peerconnection</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//webrtc/pc/peerconnection.cc</span><br><span class="line">PeerConnection::SetAudioRecording(bool recording)&#123;</span><br><span class="line">    auto audio_state = </span><br><span class="line">        factory_-&gt;channel_manager()-&gt;media_engine()-&gt;GetAudioState();</span><br><span class="line">    // AudioState</span><br><span class="line">    audio_state-&gt;SetRecording(recording);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由上代码可知， 通过 WebRtcVoiceEngine 的 GetAudioState() 方法获取 audio_state。<br>然后通过 audio_state 设置音频采集开关。</p>
<p>在 AudioState::SetRecording() 方法调用具体设备模块开始或停止音频采集。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//webrtc/audio/audio_state.cc</span><br><span class="line">AudioState::SetRecording(bool enabled)&#123;</span><br><span class="line">    ...</span><br><span class="line">    if(enabled)&#123;</span><br><span class="line">        config_.audio_device_module-&gt;StartRecording();</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        config_.audio_device_module-&gt;StopRecording();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="音频采集具体实现"><a href="#音频采集具体实现" class="headerlink" title="音频采集具体实现"></a>音频采集具体实现</h4><p>这里我们只以Android为例。</p>
<p>如果使用 opensles ndk 采集音频，采集的具体实现在 opensles_recorder.cc 文件的 StartRecording() 方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// modules/audio_device/android/opensles_recorder.cc</span><br><span class="line">int OpenSLESRecorder::StartRecording()&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种方法的具体实现我们暂时不深入。</p>
<p>我们讨论 java 实现方案。</p>
<p>java 实现的jni类，audio_record_jni.cc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//modules/audio_device/android/audio_record_jni.cc</span><br><span class="line">AudioRecordJni::StartRecording()&#123;</span><br><span class="line">    ...</span><br><span class="line">    j_audio_record_-&gt;StartRecording()</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>j_audio_record_-&gt;StartRecording() 调用的就是 AudioRecordJni::JavaAudioRecord::StartRecording() 方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AudioRecordJni::JavaAudioRecord::StartRecording()&#123;</span><br><span class="line">    return audio_record_-&gt;CallBooleanMethod(start_recording_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CallBooleanMethod 就是jni回调java 实现的封装，最终实现回调 WebRtcAudioRecord.java 中的 StartRecording() 方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//org.webrtc.voiceengine.WebRtcAudioRecord.java </span><br><span class="line">boolean startRecording()&#123;</span><br><span class="line">    audioRecord.startRecording();</span><br><span class="line">    audioThread = new AudioRecordThread(&quot;AudioRecordJavaThread&quot;);</span><br><span class="line">    audioThread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="音频采集线程"><a href="#音频采集线程" class="headerlink" title="音频采集线程"></a>音频采集线程</h4><p>音频采集线 AudioRecordThread；我们只跟踪 run() 方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run()&#123;</span><br><span class="line">    ...</span><br><span class="line">    while(keepAlive)&#123;</span><br><span class="line">        int bytesRead = audioRecord.read(byteBuffer, byteBuffer.capacity());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        // 通知 native 音频数据</span><br><span class="line">        nativeDataIsRecorded(bytesRead, nativeAudioRecord);</span><br><span class="line"></span><br><span class="line">        // 应用音频采集回调</span><br><span class="line">        byte[] data = Arrays.copyOf(byteBuffer.array(), byteBuffer.capacity());</span><br><span class="line">        audioSamplesReadyCallback.onWebRtcAudioRecordSamplesReady(</span><br><span class="line">            new AudioSamples(audioRecord, data)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2017/08/16/webrtc 音频/" data-id="cjgzcn7q8000n6x0c2hyb5ils" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2017/08/16/webrtc 音频/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2017/08/16/webrtc 音频/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-MK语法规范" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/05/07/MK语法规范/">MK语法规范</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/05/07/MK语法规范/">
            <time datetime="2017-05-07T12:11:15.000Z" itemprop="datePublished">2017-05-07</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/AOSP/">AOSP</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/mk/">mk</a>, <a class="tag-link" href="/tags/编译/">编译</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="Android-mk文件语法规范及使用模板"><a href="#Android-mk文件语法规范及使用模板" class="headerlink" title="Android.mk文件语法规范及使用模板"></a>Android.mk文件语法规范及使用模板</h1><hr>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction:"></a>Introduction:</h2><p>Android.mk编译文件是用来向Android NDK描述你的C,C++源代码文件的， 这篇文档描述了它的语法。在阅读下面的内容之前，假定你已经阅读了docs/OVERVIEW.TXT文件，了解了它们的用途。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述:"></a>概述:</h2><p>一个 Android.mk file用来向编译系统描述你的源代码。具体来说：-该文件是GNU Makefile的一小部分，会被编译系统解析一次或更多次的build系统。因此，您应尽量减少您声明的变量，不要认为某些变量在解析过程中不会被定义。-这个文件的语法允许把你的源代码组织成模块，一个模块属下列类型之一：  静态库  、共享库</p>
<p>只有共享库将被安装/复制到您的应用软件包。虽然静态库能被用于生成共享库。</p>
<p>你可以在每一个Android.mk file中定义一个或多个模块，你也可以在几个模块中使用同一个源代码文件。</p>
<hr>
<p>-编译系统为你处理许多细节问题。例如，你不需要在你的Android.mk中列出头文件和依赖文件。NDK编译系统将会为你自动处理这些问题。这也意味着，在升级NDK后，你应该得到新的toolchain/platform支持，而且不需要改变你的Android.mk文件。</p>
<p>注意，这个语法同公开发布的Android平台的开源代码很接近，然而编译系统实现他们的方式却是不同的，这是故意这样设计的，可以让程序开发人员重用外部库的源代码更容易。</p>
<h3 id="简单的例子"><a href="#简单的例子" class="headerlink" title="简单的例子:"></a>简单的例子:</h3><hr>
<p>在描述语法细节之前，咱们来看一个简单的”hello world”的例子，比如，下面的文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sources/helloworld/helloworld.c</span><br><span class="line"></span><br><span class="line">sources/helloworld/Android.mk</span><br></pre></td></tr></table></figure>
<p>‘helloworld.c’是一个JNI共享库，实现返回”hello world”字符串的原生方法。</p>
<p>相应的Android.mk文件会象下面这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">---------- cut here ------------------</span><br><span class="line"></span><br><span class="line">LOCAL_PATH := $(call my-dir)</span><br><span class="line"></span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line"></span><br><span class="line">LOCAL_MODULE:= helloworld</span><br><span class="line"></span><br><span class="line">LOCAL_SRC_FILES := helloworld.c</span><br><span class="line"></span><br><span class="line">include $(BUILD_SHARED_LIBRARY)</span><br><span class="line"></span><br><span class="line">---------- cut here ------------------</span><br></pre></td></tr></table></figure>
<p>好，我们来解释一下这几行代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := $(call my-dir)</span><br></pre></td></tr></table></figure>
<p>一个Android.mk file首先必须定义好LOCAL_PATH变量。它用于在开发树中查找源文件。在这个例子中，宏函数’my-dir’, 由编译系统提供，用于返回当前路径（即包含Android.mk file文件的目录）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include $( CLEAR_VARS)</span><br></pre></td></tr></table></figure>
<p>CLEAR_VARS由编译系统提供，指定让GNU MAKEFILE为你清除许多LOCAL_XXX变量（例如 LOCAL_MODULE, LOCAL_SRC_FILES, LOCAL_STATIC_LIBRARIES, 等等…),</p>
<p>除LOCAL_PATH 。这是必要的，因为所有的编译控制文件都在同一个GNU MAKE执行环境中，所有的变量都是全局的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_MODULE := helloworld</span><br></pre></td></tr></table></figure>
<p>LOCAL_MODULE变量必须定义，以标识你在Android.mk文件中描述的每个模块。名称必须是唯一的，而且不包含任何空格。注意编译系统会自动产生合适的前缀和后缀，换句话说，一个被命名为’foo’的共享库模块，将会生成’libfoo.so’文件。</p>
<p>重要注意事项</p>
<p>如果你把库命名为‘libhelloworld’，编译系统将不会添加任何的lib前缀，也会生成libhelloworld.so，这是为了支持来源于Android平台的源代码的Android.mk文件，如果你确实需要这么做的话。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_SRC_FILES := helloworld.c</span><br></pre></td></tr></table></figure>
<p>LOCAL_SRC_FILES变量必须包含将要编译打包进模块中的C或C++源代码文件。注意，你不用在这里列出头文件和包含文件，因为编译系统将会自动为你找出依赖型的文件；仅仅列出直接传递给编译器的源代码文件就好。【注意，默认的C++源码文件的扩展名是’.cpp’. 指定一个不同的扩展名也是可能的，只要定义LOCAL_DEFAULT_CPP_EXTENSION变量，不要忘记开始的小圆点（也就是定义为‘.cxx’,而不是‘cxx’）（当然这一步我们一般不会去改它）】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include $(BUILD_SHARED_LIBRARY)</span><br></pre></td></tr></table></figure>
<p>BUILD_SHARED_LIBRARY是编译系统提供的变量，指向一个GNU Makefile脚本（应该就是在build/core目录下的shared_library.mk），负责收集自从上次调用’include $(CLEAR_VARS)’以来，定义在LOCAL_XXX变量中的所有信息，并且决定编译什么，如何正确地去做。并根据其规则生成静态库。同理对于静态库。</p>
<hr>
<p>在sources/samples目录下有更复杂一点的例子，写有注释的Android.mk文件，你可以看看。</p>
<p>参考:</p>
<p>这是一份你应该在Android.mk中依赖或定义的变量列表，您可以定义其他变量为自己使用，</p>
<p>但是NDK编译系统保留下列变量名：</p>
<p>-以LOCAL_开头的名字（例如 LOCAL_MODULE）</p>
<p>-以PRIVATE_, NDK_ or APP_开头的名字（内部使用）</p>
<p>-小写名字（内部使用，例如’my-dir’）</p>
<p>如果您为了方便在Android.mk中定义自己的变量，我们建议使用MY_前缀，一个小例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">---------- cut here ------------------</span><br><span class="line"></span><br><span class="line">MY_SOURCES := foo.c</span><br><span class="line"></span><br><span class="line">ifneq ($(MY_CONFIG_BAR),)</span><br><span class="line"></span><br><span class="line">MY_SOURCES += bar.c</span><br><span class="line"></span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">LOCAL_SRC_FILES += $(MY_SOURCES)</span><br><span class="line"></span><br><span class="line">---------- cut here ------------------</span><br></pre></td></tr></table></figure>
<hr>
<p>这些GNU Make 变量在你的Android.mk文件解析之前，就由编译系统定义好了。</p>
<p>注意在某些情况下，NDK可能分析Android.mk几次，每一次某些变量的定义会有不同。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CLEAR_VARS</span><br></pre></td></tr></table></figure>
<p>指向一个编译脚本，几乎所有未定义的LOCAL_XXX变量都在”Module-description”节中列出。</p>
<p>你必须在开始一个新模块之前包含这个脚本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include $(CLEAR_VARS)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BUILD_SHARED_LIBRARY</span><br></pre></td></tr></table></figure>
<p>指向编译脚本，收集所有的你在LOCAL_XXX变量中提供的信息，并且决定如何把你列出的源代码文件编译成一个共享库。注意，你必须至少在包含这个文件之前定义LOCAL_MODULE和LOCAL_SRC_FILES，使用例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include $(BUILD_SHARED_LIBRARY)</span><br></pre></td></tr></table></figure>
<p>注意这将生成一个名为lib$(LOCAL_MODULE).so的文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BUILD_STATIC_LIBRARY</span><br></pre></td></tr></table></figure>
<p>一个BUILD_SHARED_LIBRARY变量用于编译一个静态库。静态库不会复制到你的project/packages中，诞生能够用于编译共享库，（看下面描述的LOCAL_STATIC_LIBRARIES and LOCAL_STATIC_WHOLE_LIBRARIES）</p>
<p>使用例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include $(BUILD_STATIC_LIBRARY)</span><br></pre></td></tr></table></figure>
<p>注意，这将会生成一个名为lib$(LOCAL_MODULE).a的文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TARGET_ARCH</span><br></pre></td></tr></table></figure>
<p>目标CPU平台的名字，如同在android开放源码中指定的那样。如果是’arm’，表示要生成ARM兼容的指令，与CPU架构的修订版无关。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TARGET_PLATFORM</span><br></pre></td></tr></table></figure>
<p>Android.mk解析的时候，目标Android平台的名字.详情可参考/development/ndk/docs/stable-apis.txt.</p>
<pre><code>android-3      -&gt; Official Android 1.5 system images

android-4      -&gt; Official Android 1.6 system images

android-5      -&gt; Official Android 2.0 system images
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TARGET_ARCH_ABI</span><br></pre></td></tr></table></figure>
<p>暂时只支持两个value，armeabi和armeabi-v7a。在现在的版本中一般把这两个值简单的定义为arm，通过android 平台内部对它重定义来获得更好的匹配。</p>
<p>其他的ＡＢＩ将在以后的ＮＤＫ版本中介绍，它们会有不同的名字。注意所有基于ＡＲＭ的ＡＢＩ都会把’TARGET_ARCH’定义成‘ａｒｍ’，但是会有不同的‘TARGET_ARCH_ABI’</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TARGET_ABI</span><br></pre></td></tr></table></figure>
<p>　　目标平台和ABI的组合，它事实上被定义成$(TARGET_PLATFORM)-$(TARGET_ARCH_ABI) 在你想要在真实的设备中针对一个特别的目标系统进行测试时，会有用。在默认的情况下，它会是’android-3-arm’。</p>
<p>/<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<p>下面是GNU Make　‘功能’宏，必须通过使用’$(call <function>)’来求值，他们返回文本化的信息。</function></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my-dir</span><br></pre></td></tr></table></figure>
<p>返回当前Android.mk所在的目录路径，相对于ＮＤＫ编译系统的顶层。这是有用的，在Android.mk文件的开头如此定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := $(call my-dir)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">all-subdir-makefiles</span><br></pre></td></tr></table></figure>
<p>　　　返回一个位于当前’my-dir’路径的子目录列表。例如，看下面的目录层次：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sources/foo/Android.mk</span><br><span class="line"></span><br><span class="line">sources/foo/lib1/Android.mk</span><br><span class="line"></span><br><span class="line">sources/foo/lib2/Android.mk</span><br></pre></td></tr></table></figure>
<p>如果sources/foo/Android.mk包含一行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include $(call all-subdir-makefiles)</span><br></pre></td></tr></table></figure>
<p>那么它就会自动包含sources/foo/lib1/Android.mk 和sources/foo/lib2/Android.mk</p>
<p>这项功能用于向编译系统提供深层次嵌套的代码目录层次。注意，在默认情况下，ＮＤＫ将会只搜索在sources/*/Android.mk中的文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this-makefile</span><br></pre></td></tr></table></figure>
<p>返回当前Makefile的路径（即这个函数调用的地方）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">parent-makefile</span><br></pre></td></tr></table></figure>
<p>　　返回调用树中父Makefile路径。即包含当前Makefile的Makefile路径。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grand-parent-makefile</span><br></pre></td></tr></table></figure>
<p>猜猜看…</p>
<p>/<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<h3 id="模块描述变量"><a href="#模块描述变量" class="headerlink" title="模块描述变量:"></a>模块描述变量:</h3><p>下面的变量用于向编译系统描述你的模块。你应该定义在’include $(CLEAR_VARS)’和’include $(BUILD_XXXXX)’之间定义。正如前面描写的那样，$(CLEAR_VARS是一个脚本，清除所有这些变量，除非在描述中显式注明。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH</span><br></pre></td></tr></table></figure>
<p>　　这个变量用于给出当前文件的路径。你必须在Android.mk的开头定义，可以这样使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := $(call my-dir)</span><br></pre></td></tr></table></figure>
<p>这个变量不会被$(CLEAR_VARS)清除，因此每个Android.mk只需要定义一次（即使你在一个文件中定义了几个模块的情况下）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_MODULE</span><br></pre></td></tr></table></figure>
<p>这是你模块的名字，它必须是唯一的，而且不能包含空格。你必须在包含任一的$(BUILD_XXXX)脚本之前定义它。模块的名字决定了生成文件的名字，例如，如果一个一个共享库模块的名字是<foo>，那么生成文件的名字就是lib<foo>.so。但是，在你的NDK生成文件中（或者Android.mk或者Application.mk），你应该只涉及(引用)有正常名字的其他模块。</foo></foo></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_SRC_FILES</span><br></pre></td></tr></table></figure>
<p>这是要编译的源代码文件列表。只要列出要传递给编译器的文件，因为编译系统自动为你计算依赖。</p>
<p>注意源代码文件名称都是相对于LOCAL_PATH的，你可以使用路径部分，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_SRC_FILES := foo.c \</span><br></pre></td></tr></table></figure>
<p>toto/bar.c<br>注意：在生成文件中都要使用UNIX风格的斜杠(/).windows风格的反斜杠不会被正确的处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_CPP_EXTENSION</span><br></pre></td></tr></table></figure>
<p>这是一个可选变量，用来指定C++代码文件的扩展名，默认是’.cpp’,但是你可以改变它，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_CPP_EXTENSION := .cxx</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_C_INCLUDES</span><br></pre></td></tr></table></figure>
<p>路径的可选配置，是从根目录开始的，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">all sources (C, C++ and Assembly). For example:</span><br><span class="line"></span><br><span class="line">        LOCAL_C_INCLUDES := sources/foo</span><br><span class="line"></span><br><span class="line">    Or even:</span><br><span class="line"></span><br><span class="line">        LOCAL_C_INCLUDES := $(LOCAL_PATH)/../foo</span><br><span class="line"></span><br><span class="line">       需要在任何包含LOCAL_CFLAGS / LOCAL_CPPFLAGS标志之前。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_CFLAGS</span><br></pre></td></tr></table></figure>
<p>可选的编译器选项，在编译C代码文件的时候使用。</p>
<p>这可能是有用的，指定一个附加的包含路径（相对于NDK的顶层目录），宏定义，或者编译选项。</p>
<p>　重要信息：不要在Android.mk中改变optimization/debugging级别，只要在Application.mk中指定合适的信息，就会自动地为你处理这个问题，在调试期间，会让ＮＤＫ自动生成有用的数据文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_CXXFLAGS</span><br><span class="line"></span><br><span class="line">Same as LOCAL_CFLAGS for C++ source files</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_CPPFLAGS</span><br></pre></td></tr></table></figure>
<p>与LOCAL_CFLAGS相同，但是对C 和　C++ source files都适用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_STATIC_LIBRARIES</span><br></pre></td></tr></table></figure>
<p>应该链接到这个模块的静态库列表（使用BUILD_STATIC_LIBRARY生成），这仅仅对共享库模块才有意义。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_SHARED_LIBRARIES</span><br></pre></td></tr></table></figure>
<p>这个模块在运行时要依赖的共享库模块列表，在链接时需要，在生成文件时嵌入的相应的信息。注意：这不会附加列出的模块到编译图，也就是，你仍然需要在Application.mk中把它们添加到程序要求的模块中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_LDLIBS</span><br></pre></td></tr></table></figure>
<p>编译你的模块要使用的附加的链接器选项。这对于使用”-l”前缀传递指定库的名字是有用的。例如，下面将告诉链接器生成的模块要在加载时刻链接到/system/lib/libz.so</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_LDLIBS := -lz</span><br></pre></td></tr></table></figure>
<p>看docs/STABLE-APIS.TXT获取你使用NDK发行版能链接到的开放的系统库列表。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_ALLOW_UNDEFINED_SYMBOLS</span><br></pre></td></tr></table></figure>
<p>　　默认情况下，在试图编译一个共享库时，任何未定义的引用将导致一个“未定义的符号”错误。这对于在你的源代码文件中捕捉错误会有很大的帮助。</p>
<p>然而，如果你因为某些原因，需要不启动这项检查，把这个变量设为‘ｔｒｕｅ’。注意相应的共享库可能在运行时加载失败。（这个一般尽量不要去设为true）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_ARM_MODE</span><br></pre></td></tr></table></figure>
<p>默认情况下，arm目标二进制会以thumb的形式生成（16位），你可以通过设置这个变量为arm如果你希望你的module是以32位指令的形式。</p>
<pre><code>&apos;arm&apos; (32-bit instructions) mode. E.g.:

  LOCAL_ARM_MODE := arm
</code></pre><p>注意你同样可以在编译的时候告诉系统编译特定的类型，比如</p>
<pre><code>LOCAL_SRC_FILES := foo.c bar.c.arm
</code></pre><p>这样就告诉系统总是将bar.c以arm的模式编译，</p>
<h3 id="Android-mk使用模板"><a href="#Android-mk使用模板" class="headerlink" title="Android.mk使用模板"></a>Android.mk使用模板</h3><p>在一个Android.mk中可以生成多个可执行程序、动态库和静态库。</p>
<h4 id="1，编译应用程序的模板："><a href="#1，编译应用程序的模板：" class="headerlink" title="1，编译应用程序的模板："></a>1，编译应用程序的模板：</h4><pre><code>#Test Exe

LOCAL_PATH := $(call my-dir)

#include $(CLEAR_VARS)

LOCAL_SRC_FILES:= main.c

LOCAL_MODULE:= test_exe

#LOCAL_C_INCLUDES :=

#LOCAL_STATIC_LIBRARIES :=

#LOCAL_SHARED_LIBRARIES :=

include $(BUILD_EXECUTABLE)
</code></pre><p>（菜鸟级别解释：:=是赋值的意思，$是引用某变量的值）LOCAL_SRC_FILES中加入源文件路径，LOCAL_C_INCLUDES 中加入所需要包含的头文件路径，LOCAL_STATIC_LIBRARIES加入所需要链接的静态库（<em>.a）的名称，LOCAL_SHARED_LIBRARIES中加入所需要链接的动态库（</em>.so）的名称，LOCAL_MODULE表示模块最终的名称，BUILD_EXECUTABLE表示以一个可执行程序的方式进行编译。</p>
<h4 id="2，编译静态库的模板："><a href="#2，编译静态库的模板：" class="headerlink" title="2，编译静态库的模板："></a>2，编译静态库的模板：</h4><pre><code>#Test Static Lib

LOCAL_PATH := $(call my-dir)

include $(CLEAR_VARS)

LOCAL_SRC_FILES:= \

          helloworld.c

LOCAL_MODULE:= libtest_static

#LOCAL_C_INCLUDES :=

#LOCAL_STATIC_LIBRARIES :=

#LOCAL_SHARED_LIBRARIES :=

include $(BUILD_STATIC_LIBRARY)
</code></pre><p>一般的和上面相似，BUILD_STATIC_LIBRARY表示编译一个静态库。</p>
<h4 id="3，编译动态库的模板："><a href="#3，编译动态库的模板：" class="headerlink" title="3，编译动态库的模板："></a>3，编译动态库的模板：</h4><pre><code>#Test Shared Lib

LOCAL_PATH := $(call my-dir)

include $(CLEAR_VARS)

LOCAL_SRC_FILES:= \

          helloworld.c

LOCAL_MODULE:= libtest_shared

TARGET_PRELINK_MODULES := false

#LOCAL_C_INCLUDES :=

#LOCAL_STATIC_LIBRARIES :=

#LOCAL_SHARED_LIBRARIES :=

 include $(BUILD_SHARED_LIBRARY)
</code></pre><p>一般的和上面相似，BUILD_SHARED_LIBRARY表示编译一个共享库。</p>
<p>以上三者的生成结果分别在如下，generic依具体target会变：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">out/target/product/generic/obj/EXECUTABLE</span><br><span class="line"></span><br><span class="line">out/target/product/generic/obj/STATIC_LIBRARY</span><br><span class="line"></span><br><span class="line">out/target/product/generic/obj/SHARED_LIBRARY</span><br></pre></td></tr></table></figure>
<p>每个模块的目标文件夹分别为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">可执行程序：XXX_intermediates</span><br><span class="line"></span><br><span class="line">静态库：      XXX_static_intermediates</span><br><span class="line"></span><br><span class="line">动态库：      XXX_shared_intermediates</span><br></pre></td></tr></table></figure>
<p>另外，在Android.mk文件中，还可以指定最后的目标安装路径，用LOCAL_MODULE_PATH和LOCAL_UNSTRIPPED_PATH来指定。不同的文件系统路径用以下的宏进行选择：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TARGET_ROOT_OUT：表示根文件系统。</span><br><span class="line"></span><br><span class="line">TARGET_OUT：表示system文件系统。</span><br><span class="line"></span><br><span class="line">TARGET_OUT_DATA：表示data文件系统。</span><br></pre></td></tr></table></figure>
<p>用法如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_MODULE_PATH:=$(TARGET_ROOT_OUT)</span><br></pre></td></tr></table></figure>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2017/05/07/MK语法规范/" data-id="cjgzcn7pw00076x0cp2rwe2e0" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2017/05/07/MK语法规范/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://yoursite.com/2017/05/07/MK语法规范/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <nav id="page-nav">
        <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
</section>
            
                
<aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">recent</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/05/10/AnimatedVectorDrawable 总结/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/CoolUI/">CoolUI</a></p>
                            <p class="item-title"><a href="/2018/05/10/AnimatedVectorDrawable 总结/" class="title">AnimatedVectorDrawable总结</a></p>
                            <p class="item-date"><time datetime="2018-05-09T16:51:50.000Z" itemprop="datePublished">2018-05-10</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/04/12/Rxjava2操作符/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
                            <p class="item-title"><a href="/2018/04/12/Rxjava2操作符/" class="title">Rxjava2操作符</a></p>
                            <p class="item-date"><time datetime="2018-04-12T12:20:50.000Z" itemprop="datePublished">2018-04-12</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/03/16/Socket未释放导致的句柄泄露/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/bug记录/">bug记录</a></p>
                            <p class="item-title"><a href="/2018/03/16/Socket未释放导致的句柄泄露/" class="title">socket未释放导致句柄泄露</a></p>
                            <p class="item-date"><time datetime="2018-03-16T11:40:50.000Z" itemprop="datePublished">2018-03-16</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/03/13/线程阻塞和中断的四种方式/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/java基础/">java基础</a></p>
                            <p class="item-title"><a href="/2018/03/13/线程阻塞和中断的四种方式/" class="title">线程阻塞和中断的四种方式</a></p>
                            <p class="item-date"><time datetime="2018-03-13T12:46:25.000Z" itemprop="datePublished">2018-03-13</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/11/mac搭建PyQt5环境/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/python/">python</a></p>
                            <p class="item-title"><a href="/2017/12/11/mac搭建PyQt5环境/" class="title">mac搭建Pyqt5环境</a></p>
                            <p class="item-date"><time datetime="2017-12-11T12:30:50.000Z" itemprop="datePublished">2017-12-11</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">categories</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AOSP/">AOSP</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CoolUI/">CoolUI</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MQTT/">MQTT</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/bug记录/">bug记录</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java基础/">java基础</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/webrtc/">webrtc</a><span class="category-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tags</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AnimatedVectorDrawable/">AnimatedVectorDrawable</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Binder/">Binder</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SEAndroid/">SEAndroid</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/">android</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aosp/">aosp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bugs/">bugs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux命令/">linux命令</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mk/">mk</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mqtt/">mqtt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qt/">qt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rxjava2/">rxjava2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webrtc/">webrtc</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/句柄animation/">句柄animation</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/句柄泄露/">句柄泄露</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程/">多线程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开源框架/">开源框架</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/抓包/">抓包</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编译/">编译</a><span class="tag-list-count">3</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/AnimatedVectorDrawable/" style="font-size: 10px;">AnimatedVectorDrawable</a> <a href="/tags/Binder/" style="font-size: 10px;">Binder</a> <a href="/tags/SEAndroid/" style="font-size: 10px;">SEAndroid</a> <a href="/tags/android/" style="font-size: 20px;">android</a> <a href="/tags/aosp/" style="font-size: 10px;">aosp</a> <a href="/tags/bugs/" style="font-size: 10px;">bugs</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/linux命令/" style="font-size: 10px;">linux命令</a> <a href="/tags/mk/" style="font-size: 10px;">mk</a> <a href="/tags/mqtt/" style="font-size: 10px;">mqtt</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/qt/" style="font-size: 10px;">qt</a> <a href="/tags/rxjava2/" style="font-size: 10px;">rxjava2</a> <a href="/tags/webrtc/" style="font-size: 10px;">webrtc</a> <a href="/tags/句柄animation/" style="font-size: 10px;">句柄animation</a> <a href="/tags/句柄泄露/" style="font-size: 10px;">句柄泄露</a> <a href="/tags/多线程/" style="font-size: 10px;">多线程</a> <a href="/tags/开源框架/" style="font-size: 10px;">开源框架</a> <a href="/tags/抓包/" style="font-size: 10px;">抓包</a> <a href="/tags/编译/" style="font-size: 15px;">编译</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="https://github.com/QuincyJiang">github</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2018 QuincyJiang<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_config = function () {
        
        this.page.identifier = '';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'https-quincyjiang-github-io' + '.disqus.com/count.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>