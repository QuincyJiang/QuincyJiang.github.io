<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    
    <title>QuincyJiang</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="website">
<meta property="og:title" content="QuincyJiang">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="QuincyJiang">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="QuincyJiang">
    

    

    
        <link rel="icon" href="/css/images/avatar.png" />
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">QuincyJiang</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/avatar.png" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile" class="profile-fixed">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/avatar.png" />
            <h2 id="name">QuincyJiang</h2>
            <h3 id="title">Coder &amp; FilmPlayer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Guangzhou, China</span>
            <a id="follow" target="_blank" href="https://github.com/QuincyJiang">FOLLOW</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                15
                <span>posts</span>
            </div>
            <div class="article-info-block">
                21
                <span>tags</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="https://github.com/QuincyJiang" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://weibo.com/2425393311/" target="_blank" title="weibo" class=tooltip>
                            <i class="fa fa-weibo"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="http://aquencyua11.lofter.com/" target="_blank" title="photo" class=tooltip>
                            <i class="fa fa-photo"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-Binder 进程间通讯机制" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/04/11/Binder 进程间通讯机制/">Binder通讯机制</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/04/11/Binder 进程间通讯机制/">
            <time datetime="2017-04-11T11:20:50.000Z" itemprop="datePublished">2017-04-11</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Binder/">Binder</a>, <a class="tag-link" href="/tags/android/">android</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="什么是Binder？"><a href="#什么是Binder？" class="headerlink" title="什么是Binder？"></a>什么是Binder？</h1><p>Binder是Android系统中进程间通讯（IPC）的一种方式，也是Android系统中最重要的特性之一。Android中的四大组件Activity，Service，Broadcast，ContentProvider，不同的App等都运行在不同的进程中，它是这些进程间通讯的桥梁。正如其名“粘合剂”一样，它把系统中各个组件粘合到了一起，是各个组件的桥梁。</p>
<p>理解Binder对于理解整个Android系统有着非常重要的作用，如果对Binder不了解，就很难对Android系统机制有更深入的理解。</p>
<h1 id="1-Binder架构"><a href="#1-Binder架构" class="headerlink" title="1. Binder架构"></a>1. Binder架构</h1><p><img src="https://img-blog.csdn.net/20170411180827946?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZnJlZWtpdGV5dQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="image"></p>
<ul>
<li>Binder 通信采用 C/S 架构，从组件视角来说，包含 Client、 Server、 ServiceManager 以及 Binder 驱动，其中 ServiceManager 用于管理系统中的各种服务。</li>
<li>Binder 在 framework 层进行了封装，通过 JNI 技术调用 Native（C/C++）层的 Binder 架构。</li>
<li><p>Binder 在 Native 层以 ioctl 的方式与 Binder 驱动通讯。</p>
<h1 id="2-Binder机制"><a href="#2-Binder机制" class="headerlink" title="2.Binder机制"></a>2.Binder机制</h1><p><img src="https://img-blog.csdn.net/20170411180950468?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZnJlZWtpdGV5dQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="image"></p>
</li>
<li><p>首先需要注册服务端，只有注册了服务端，客户端才有通讯的目标，服务端通过 ServiceManager 注册服务，注册的过程就是向 Binder 驱动的全局链表 binder_procs 中插入服务端的信息（binder_proc 结构体，每个 binder_proc 结构体中都有 todo 任务队列），然后向 ServiceManager 的 svcinfo 列表中缓存一下注册的服务。</p>
</li>
<li><p>有了服务端，客户端就可以跟服务端通讯了，通讯之前需要先获取到服务，拿到服务的代理，也可以理解为引用。比如下面的代码：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1//获取WindowManager服务引用</span><br><span class="line">2 WindowManager wm = (WindowManager)getSystemService(getApplication().WINDOW_SERVICE);</span><br></pre></td></tr></table></figure>
<p>获取服务端的方式就是通过 ServiceManager 向 svcinfo 列表中查询一下返回服务端的代理，svcinfo 列表就是所有已注册服务的通讯录，保存了所有注册的服务信息。</p>
<ul>
<li>有了服务端的引用我们就可以向服务端发送请求了，通过 BinderProxy 将我们的请求参数发送给 ServiceManager，通过共享内存的方式使用内核方法 copy_from_user() 将我们的参数先拷贝到内核空间，这时我们的客户端进入等待状态，然后 Binder 驱动向服务端的 todo 队列里面插入一条事务，执行完之后把执行结果通过 copy_to_user() 将内核的结果拷贝到用户空间（这里只是执行了拷贝命令，并没有拷贝数据，binder只进行一次拷贝），唤醒等待的客户端并把结果响应回来，这样就完成了一次通讯。</li>
</ul>
<p>怎么样是不是很简单，以上就是 Binder 机制的主要通讯方式，下面我们来看看具体实现。</p>
<h1 id="3-Binder驱动"><a href="#3-Binder驱动" class="headerlink" title="3.Binder驱动"></a>3.Binder驱动</h1><p>我们先来了解下<strong>用户空间</strong>与<strong>内核空间</strong>是怎么交互的。</p>
<p><img src="https://img-blog.csdn.net/20170411181004953?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZnJlZWtpdGV5dQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="image"></p>
<p>先了解一些概念</p>
<h3 id="用户空间-内核空间"><a href="#用户空间-内核空间" class="headerlink" title="用户空间/内核空间"></a>用户空间/内核空间</h3><p>详细解释可以参考 Kernel Space Definition； 简单理解如下：</p>
<p>Kernel space 是 Linux 内核的运行空间，User space 是用户程序的运行空间。 为了安全，它们是隔离的，即使用户的程序崩溃了，内核也不受影响。</p>
<p>Kernel space 可以执行任意命令，调用系统的一切资源； User space 只能执行简单的运算，不能直接调用系统资源，必须通过系统接口（又称 system call），才能向内核发出指令。</p>
<h3 id="系统调用-内核态-用户态"><a href="#系统调用-内核态-用户态" class="headerlink" title="系统调用/内核态/用户态"></a>系统调用/内核态/用户态</h3><p>虽然从逻辑上抽离出用户空间和内核空间；但是不可避免的的是，总有那么一些用户空间需要访问内核的资源；比如应用程序访问文件，网络是很常见的事情，怎么办呢？</p>
<blockquote>
<p>Kernel space can be accessed by user processes only through the use of system calls.</p>
</blockquote>
<p>用户空间访问内核空间的唯一方式就是系统调用；通过这个统一入口接口，所有的资源访问都是在内核的控制下执行，以免导致对用户程序对系统资源的越权访问，从而保障了系统的安全和稳定。用户软件良莠不齐，要是它们乱搞把系统玩坏了怎么办？因此对于某些特权操作必须交给安全可靠的内核来执行。</p>
<p>当一个任务（进程）执行系统调用而陷入内核代码中执行时，我们就称进程处于内核运行态（或简称为内核态）此时处理器处于特权级最高的（0级）内核代码中执行。当进程在执行用户自己的代码时，则称其处于用户运行态（用户态）。即此时处理器在特权级最低的（3级）用户代码中运行。处理器在特权等级高的时候才能执行那些特权CPU指令。</p>
<h3 id="内核模块-驱动"><a href="#内核模块-驱动" class="headerlink" title="内核模块/驱动"></a>内核模块/驱动</h3><p>通过系统调用，用户空间可以访问内核空间，那么如果一个用户空间想与另外一个用户空间进行通信怎么办呢？很自然想到的是让操作系统内核添加支持；传统的 Linux 通信机制，比如 Socket，管道等都是内核支持的；但是 Binder 并不是 Linux 内核的一部分，它是怎么做到访问内核空间的呢？ Linux 的动态可加载内核模块（Loadable Kernel Module，LKM）机制解决了这个问题；模块是具有独立功能的程序，它可以被单独编译，但不能独立运行。它在运行时被链接到内核作为内核的一部分在内核空间运行。这样，Android系统可以通过添加一个内核模块运行在内核空间，用户进程之间的通过这个模块作为桥梁，就可以完成通信了。</p>
<p>在 Android 系统中，这个运行在内核空间的，负责各个用户进程通过 Binder 通信的内核模块叫做 Binder 驱动;</p>
<blockquote>
<p>驱动程序一般指的是设备驱动程序（Device Driver），是一种可以使计算机和设备通信的特殊程序。相当于硬件的接口，操作系统只有通过这个接口，才能控制硬件设备的工作；</p>
</blockquote>
<p>驱动就是操作硬件的接口，为了支持Binder通信过程，Binder 使用了一种“硬件”，因此这个模块被称之为驱动。</p>
<p>熟悉了上面这些概念，我们再来看下上面的图，用户空间中 binder_open(), binder_mmap(), binder_ioctl() 这些方法通过 system call 来调用内核空间 Binder 驱动中的方法。内核空间与用户空间共享内存通过 copy_from_user(), copy_to_user() 内核方法来完成用户空间与内核空间内存的数据传输。 Binder驱动中有一个全局的 binder_procs 链表保存了服务端的进程信息。</p>
<h1 id="4-Binder-进程与线程"><a href="#4-Binder-进程与线程" class="headerlink" title="4. Binder 进程与线程"></a>4. Binder 进程与线程</h1><p><img src="https://img-blog.csdn.net/20170411181022355?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZnJlZWtpdGV5dQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="image"></p>
<p>对于底层Binder驱动，通过 binder_procs 链表记录所有创建的 binder_proc 结构体，binder 驱动层的每一个 binder_proc 结构体都与用户空间的一个用于 binder 通信的进程一一对应，且每个进程有且只有一个 ProcessState 对象，这是通过单例模式来保证的。在每个进程中可以有很多个线程，每个线程对应一个 IPCThreadState 对象，IPCThreadState 对象也是单例模式，即一个线程对应一个 IPCThreadState 对象，在 Binder 驱动层也有与之相对应的结构，那就是 Binder_thread 结构体。在 binder_proc 结构体中通过成员变量 rb_root threads，来记录当前进程内所有的 binder_thread。</p>
<p>Binder 线程池：每个 Server 进程在启动时创建一个 binder 线程池，并向其中注册一个 Binder 线程；之后 Server 进程也可以向 binder 线程池注册新的线程，或者 Binder 驱动在探测到没有空闲 binder 线程时主动向 Server 进程注册新的的 binder 线程。对于一个 Server 进程有一个最大 Binder 线程数限制，默认为16个 binder 线程，例如 Android 的 system_server 进程就存在16个线程。对于所有 Client 端进程的 binder 请求都是交由 Server 端进程的 binder 线程来处理的。</p>
<h1 id="5-ServiceManager-启动"><a href="#5-ServiceManager-启动" class="headerlink" title="5. ServiceManager 启动"></a>5. ServiceManager 启动</h1><p>了解了 Binder 驱动，怎么与 Binder 驱动进行通讯呢？那就是通过 ServiceManager，好多文章称 ServiceManager 是 Binder 驱动的守护进程，大管家，其实 ServiceManager 的作用很简单就是提供了查询服务和注册服务的功能。下面我们来看一下 ServiceManager 启动的过程。<br><img src="https://img-blog.csdn.net/20170411181034027?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZnJlZWtpdGV5dQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="image"></p>
<ul>
<li>ServiceManager 分为 framework 层和 native 层，framework 层只是对 native 层进行了封装方便调用，图上展示的是 native 层的 ServiceManager 启动过程。</li>
</ul>
<ul>
<li><p>ServiceManager 的启动是系统在开机时，init 进程解析 init.rc 文件调用 service_manager.c 中的 main() 方法入口启动的。 native 层有一个 binder.c 封装了一些与 Binder 驱动交互的方法。</p>
</li>
<li><p>ServiceManager 的启动分为三步，首先打开驱动创建全局链表 binder_procs，然后将自己当前进程信息保存到 binder_procs 链表，最后开启 loop 不断的处理共享内存中的数据，并处理 BR_xxx 命令（ioctl 的命令，BR 可以理解为 binder reply 驱动处理完的响应）。</p>
</li>
</ul>
<h1 id="6-ServiceManager-注册服务"><a href="#6-ServiceManager-注册服务" class="headerlink" title="6. ServiceManager 注册服务"></a>6. ServiceManager 注册服务</h1><p><img src="https://img-blog.csdn.net/20170411181047406?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZnJlZWtpdGV5dQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="image"></p>
<ul>
<li><p>注册 MediaPlayerService 服务端，我们通过 ServiceManager 的 addService() 方法来注册服务。</p>
</li>
<li><p>首先 ServiceManager 向 Binder 驱动发送 BC_TRANSACTION 命令（ioctl 的命令，BC 可以理解为 binder client 客户端发过来的请求命令）携带 ADD_SERVICE_TRANSACTION 命令，同时注册服务的线程进入等待状态 waitForResponse()。 Binder 驱动收到请求命令向 ServiceManager 的 todo 队列里面添加一条注册服务的事务。事务的任务就是创建服务端进程 binder_node 信息并插入到 binder_procs 链表中。</p>
</li>
<li><p>事务处理完之后发送 BR_TRANSACTION 命令，ServiceManager 收到命令后向 svcinfo 列表中添加已经注册的服务。最后发送 BR_REPLY 命令唤醒等待的线程，通知注册成功。</p>
</li>
</ul>
<h1 id="7-ServiceManager-获取服务"><a href="#7-ServiceManager-获取服务" class="headerlink" title="7. ServiceManager 获取服务"></a>7. ServiceManager 获取服务</h1><p><img src="https://img-blog.csdn.net/20170411181102125?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZnJlZWtpdGV5dQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="image"></p>
<ul>
<li><p>获取服务的过程与注册类似，相反的过程。通过 ServiceManager 的 getService() 方法来注册服务。</p>
</li>
<li><p>首先 ServiceManager 向 Binder 驱动发送 BC_TRANSACTION 命令携带 CHECK_SERVICE_TRANSACTION 命令，同时获取服务的线程进入等待状态 waitForResponse()。</p>
</li>
<li><p>Binder 驱动收到请求命令向 ServiceManager 的发送 BC_TRANSACTION 查询已注册的服务，查询到直接响应 BR_REPLY 唤醒等待的线程。若查询不到将与 binder_procs 链表中的服务进行一次通讯再响应。</p>
</li>
<li><h1 id="8-进行一次完整通讯"><a href="#8-进行一次完整通讯" class="headerlink" title="8. 进行一次完整通讯"></a>8. 进行一次完整通讯</h1><p><img src="https://img-blog.csdn.net/20170411180851093?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZnJlZWtpdGV5dQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="image"></p>
</li>
<li><p>我们在使用 Binder 时基本都是调用 framework 层封装好的方法，AIDL 就是 framework 层提供的傻瓜式是使用方式。假设服务已经注册完，我们来看看客户端怎么执行服务端的方法。</p>
</li>
<li><p>首先我们通过 ServiceManager 获取到服务端的 BinderProxy 代理对象，通过调用 BinderProxy 将参数，方法标识（例如：TRANSACTION_test，AIDL中自动生成）传给 ServiceManager，同时客户端线程进入等待状态。</p>
</li>
<li><p>ServiceManager 将用户空间的参数等请求数据复制到内核空间，并向服务端插入一条执行执行方法的事务。事务执行完通知 ServiceManager 将执行结果从内核空间复制到用户空间，并唤醒等待的线程，响应结果，通讯结束。</p>
</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>好了，这里只是从实现逻辑上简单介绍了下 Binder 机制的工作原理，想要深入理解 Binder 机制，还得自己下功夫，看源码，尽管这个过程很痛苦。一遍看不懂就再来一遍，说实话本人理解能力比较差，跟着博客思路看了不下十遍。努力总会有收获，好好欣赏 native 层各方法之间花式跳转的魅力吧。最后你将发现新世界的大门在向你敞开。</p>
<p>网上资料很多，个人觉得比较好的如下： </p>
<ol>
<li><a href="http://blog.csdn.net/universus/article/details/6211589" target="_blank" rel="noopener">Bander设计与实现</a> </li>
<li><a href="http://blog.csdn.net/luoshengyang/article/details/6618363" target="_blank" rel="noopener">老罗的 Android进程间通信（IPC）机制Binder简要介绍和学习计划 系列 </a></li>
<li>Innost的 <a href="http://blog.csdn.net/innost/article/details/47208049" target="_blank" rel="noopener">深入理解Binder</a> 系列 </li>
<li>Gityuan的 <a href="http://gityuan.com/2015/10/31/binder-prepare" target="_blank" rel="noopener">Binder系列</a> (基于 Android 6.0)<br>5.<a href="http://weishu.me/2016/01/12/binder-index-for-newer" target="_blank" rel="noopener"> Binder学习指南</a></li>
</ol>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2017/04/11/Binder 进程间通讯机制/" data-id="cjh0pyi8k00044e0cq0liav2a" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2017/04/11/Binder 进程间通讯机制/#comments" class="article-comment-link">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-编译系统环境初始化过程" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/04/05/编译系统环境初始化过程/">编译系统环境初始化过程</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/04/05/编译系统环境初始化过程/">
            <time datetime="2017-04-05T07:10:25.000Z" itemprop="datePublished">2017-04-05</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/AOSP/">AOSP</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/aosp/">aosp</a>, <a class="tag-link" href="/tags/编译/">编译</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>对Android编译环境进行初始化很简单，分为两步。</p>
<h4 id="第一步是打开一个终端，并且将build-envsetup-sh加载到该终端中："><a href="#第一步是打开一个终端，并且将build-envsetup-sh加载到该终端中：" class="headerlink" title="第一步是打开一个终端，并且将build/envsetup.sh加载到该终端中："></a>第一步是打开一个终端，并且将build/envsetup.sh加载到该终端中：</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ . ./build/envsetup.sh   </span><br><span class="line">including device/asus/grouper/vendorsetup.sh  </span><br><span class="line">including device/asus/tilapia/vendorsetup.sh  </span><br><span class="line">including device/generic/armv7-a-neon/vendorsetup.sh  </span><br><span class="line">including device/generic/armv7-a/vendorsetup.sh  </span><br><span class="line">including device/generic/mips/vendorsetup.sh  </span><br><span class="line">including device/generic/x86/vendorsetup.sh  </span><br><span class="line">including device/lge/mako/vendorsetup.sh  </span><br><span class="line">including device/samsung/maguro/vendorsetup.sh  </span><br><span class="line">including device/samsung/manta/vendorsetup.sh  </span><br><span class="line">including device/samsung/toroplus/vendorsetup.sh  </span><br><span class="line">including device/samsung/toro/vendorsetup.sh  </span><br><span class="line">including device/ti/panda/vendorsetup.sh  </span><br><span class="line">including sdk/bash_completion/adb.bash  </span><br><span class="line">      从命令的输出可以知道，文件build/envsetup.sh在加载的过程中，又会在device目录中寻找那些名称为vendorsetup.sh的文件，并且也将它们加载到当前终端来。另外，在sdk/bash_completion目录下的adb.bash文件也会加载到当前终端来，它是用来实现adb命令的bash completion功能的。也就是说，加载了该文件之后，我们在运行adb相关的命令的时候，通过按tab键就可以帮助我们自动完成命令的输入。关于bash completion的知识，可以参考官方文档： http://www.gnu.org/s/bash/manual/bash.html<span class="comment">#Programmable-Completion。</span></span><br></pre></td></tr></table></figure>
<h4 id="第二步是执行命令lunch，如下所示："><a href="#第二步是执行命令lunch，如下所示：" class="headerlink" title="第二步是执行命令lunch，如下所示："></a>第二步是执行命令lunch，如下所示：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ lunch</span><br><span class="line"> </span><br><span class="line">You<span class="string">'re building on Linux  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">Lunch menu... pick a combo:  </span></span><br><span class="line"><span class="string">     1. full-eng  </span></span><br><span class="line"><span class="string">     2. full_x86-eng  </span></span><br><span class="line"><span class="string">     3. vbox_x86-eng  </span></span><br><span class="line"><span class="string">     4. full_mips-eng  </span></span><br><span class="line"><span class="string">     5. full_grouper-userdebug  </span></span><br><span class="line"><span class="string">     6. full_tilapia-userdebug  </span></span><br><span class="line"><span class="string">     7. mini_armv7a_neon-userdebug  </span></span><br><span class="line"><span class="string">     8. mini_armv7a-userdebug  </span></span><br><span class="line"><span class="string">     9. mini_mips-userdebug  </span></span><br><span class="line"><span class="string">     10. mini_x86-userdebug  </span></span><br><span class="line"><span class="string">     11. full_mako-userdebug  </span></span><br><span class="line"><span class="string">     12. full_maguro-userdebug  </span></span><br><span class="line"><span class="string">     13. full_manta-userdebug  </span></span><br><span class="line"><span class="string">     14. full_toroplus-userdebug  </span></span><br><span class="line"><span class="string">     15. full_toro-userdebug  </span></span><br><span class="line"><span class="string">     16. full_panda-userdebug  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">Which would you like? [full-eng]</span></span><br></pre></td></tr></table></figure>
<p>我们看到lunch命令输出了一个Lunch菜单，该菜单列出了当前Android源码支持的所有设备型号及其编译类型。例如，第一项“full-eng”表示的设备“full”即为模拟器，并且编译类型为“eng”即为工程机。<br>当我们选定了一个Lunch菜单项序号(1-16)之后，按回车键，就可以完成Android编译环境的初始化过程。例如，我们选择1，可以看到以下输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[html] view plain copy</span><br><span class="line">Which would you like? [full-eng] <span class="number">1</span>  </span><br><span class="line">  </span><br><span class="line">============================================  </span><br><span class="line">PLATFORM_VERSION_CODENAME=REL  </span><br><span class="line">PLATFORM_VERSION=<span class="number">4.2</span>  </span><br><span class="line">TARGET_PRODUCT=full  </span><br><span class="line">TARGET_BUILD_VARIANT=eng  </span><br><span class="line">TARGET_BUILD_TYPE=release  </span><br><span class="line">TARGET_BUILD_APPS=  </span><br><span class="line">TARGET_ARCH=arm  </span><br><span class="line">TARGET_ARCH_VARIANT=armv7-a  </span><br><span class="line">HOST_ARCH=x86  </span><br><span class="line">HOST_OS=linux  </span><br><span class="line">HOST_OS_EXTRA=Linux-<span class="number">3.8</span>.0-<span class="number">31</span>-generic-x86_64-with-Ubuntu-<span class="number">13.04</span>-raring  </span><br><span class="line">HOST_BUILD_TYPE=release  </span><br><span class="line">BUILD_ID=JOP40C  </span><br><span class="line">OUT_DIR=out  </span><br><span class="line">============================================</span><br></pre></td></tr></table></figure>
<p>我们可以看到，lunch命令帮我们设置好了很多环境变量。通过设置这些环境变量，就配置好了Android编译环境。<br>通过图1我们就可以直观地看到Android编译环境初始化完成后，我们所获得的东西：</p>
<p><img src="https://img-blog.csdn.net/20140208122926593?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvTHVvc2hlbmd5YW5n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="image"></p>
<p>图1 Android编译环境初始化完成之后</p>
<p>总体来说，Android编译环境初始化完成之后，获得了以下三样东西：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. 将vendor和device目录下的vendorsetup.sh文件加载到了当前终端；</span><br><span class="line"></span><br><span class="line">2. 新增了lunch、m、mm和mmm等命令；</span><br><span class="line"></span><br><span class="line">3. 通过执行lunch命令设置好了TARGET_PRODUCT、TARGET_BUILD_VARIANT、TARGET_BUILD_TYPE和TARGET_BUILD_APPS等环境变量。</span><br></pre></td></tr></table></figure>
<p>接下来我们就主要分析build/envsetup.sh文件的加载过程以及lunch命令的执行过程。</p>
<h4 id="一-文件build-envsetup-sh的加载过程"><a href="#一-文件build-envsetup-sh的加载过程" class="headerlink" title="一. 文件build/envsetup.sh的加载过程"></a>一. 文件build/envsetup.sh的加载过程</h4><p>文件build/envsetup.sh是一个bash shell脚本，从它里面定义的函数hmm可以知道，它提供了lunch、m、mm和mmm等命令供我们初始化编译环境或者编译Android源码。</p>
<p>函数hmm的实现如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line">function hmm() &#123;  </span><br><span class="line">cat &lt;&lt;EOF  </span><br><span class="line">Invoke &quot;. build/envsetup.sh&quot; from your shell to add the following functions to your environment:  </span><br><span class="line">- lunch:   lunch &lt;product_name&gt;-&lt;build_variant&gt;  </span><br><span class="line">- tapas:   tapas [&lt;App1&gt; &lt;App2&gt; ...] [arm|x86|mips] [eng|userdebug|user]  </span><br><span class="line">- croot:   Changes directory to the top of the tree.  </span><br><span class="line">- m:       Makes from the top of the tree.  </span><br><span class="line">- mm:      Builds all of the modules in the current directory.  </span><br><span class="line">- mmm:     Builds all of the modules in the supplied directories.  </span><br><span class="line">- cgrep:   Greps on all local C/C++ files.  </span><br><span class="line">- jgrep:   Greps on all local Java files.  </span><br><span class="line">- resgrep: Greps on all local res/*.xml files.  </span><br><span class="line">- godir:   Go to the directory containing a file.  </span><br><span class="line">  </span><br><span class="line">Look at the source to view more functions. The complete list is:  </span><br><span class="line">EOF  </span><br><span class="line">    T=$(gettop)  </span><br><span class="line">    local A  </span><br><span class="line">    A=&quot;&quot;  </span><br><span class="line">    for i in `cat $T/build/envsetup.sh | sed -n &quot;/^function /s/function [a−z]∗.*/\1/p&quot; | sort`; do  </span><br><span class="line">      A=&quot;$A $i&quot;  </span><br><span class="line">    done  </span><br><span class="line">    echo $A  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在当前终端中执行hmm命令即可以看到函数hmm的完整输出。<br>函数hmm主要完成三个工作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. 调用另外一个函数gettop获得Android源码的根目录T。 </span><br><span class="line"></span><br><span class="line">2. 通过cat命令显示一个Here Document，说明$T/build/envsetup.sh文件加载到当前终端后所提供的主要命令。</span><br><span class="line"></span><br><span class="line">3. 通过sed命令解析$T/build/envsetup.sh文件，并且获得在里面定义的所有函数的名称，这些函数名称就是$T/build/envsetup.sh文件加载到当前终端后提供的所有命令。</span><br><span class="line"></span><br><span class="line">       注意，sed命令是一个强大的文本分析工具，它以行为单位为执行文本替换、删除、新增和选取等操作。函数hmm通过执行以下的sed命令来获得在$T/build/envsetup.sh文件定义的函数的名称：</span><br></pre></td></tr></table></figure>
<p>[plain] view plain copy<br>sed -n “/^function /s/function [a−z]∗.*/\1/p”<br>       它表示对所有以“function ”开头的行，如果紧接在“function ”后面的字符串仅由字母a-z和下横线(_)组成，那么就将这个字符串提取出来。这正好就对应于shell脚本里面函数的定义。<br>       文件build/envsetup.sh除了定义一堆函数之外，还有一个重要的代码段，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line"># Execute the contents of any vendorsetup.sh files we can find.  </span><br><span class="line">for f in `/bin/ls vendor/*/vendorsetup.sh vendor/*/*/vendorsetup.sh device/*/*/vendorsetup.sh 2&gt; /dev/null`  </span><br><span class="line">do  </span><br><span class="line">    echo &quot;including $f&quot;  </span><br><span class="line">    . $f  </span><br><span class="line">done  </span><br><span class="line">unset f</span><br></pre></td></tr></table></figure>
<p>这个for循环遍历vendor目录下的一级子目录和二级子目录以及device目录下的二级子目录中的vendorsetup.sh文件，并且通过source命令(.)将它们加载当前终端来。vendor和device相应子目录下的vendorsetup.sh文件的实现很简单，它们主要就是添加相应的设备型号及其编译类型支持到Lunch菜单中去。</p>
<p>例如，device/samsung/maguro目录下的vendorsetup.sh文件的实现如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line">add_lunch_combo full_maguro-userdebug</span><br></pre></td></tr></table></figure>
<p> 它调用函数add_lunch_combo添加一个名称为“full_maguro-userdebug”的菜单项到Lunch菜单去。<br>函数add_lunch_combo定义在build/envsetup.sh文件中，它的实现如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line">function add_lunch_combo()  </span><br><span class="line">&#123;  </span><br><span class="line">    local new_combo=$1  </span><br><span class="line">    local c  </span><br><span class="line">    for c in $&#123;LUNCH_MENU_CHOICES[@]&#125; ; do  </span><br><span class="line">        if [ &quot;$new_combo&quot; = &quot;$c&quot; ] ; then  </span><br><span class="line">            return  </span><br><span class="line">        fi  </span><br><span class="line">    done  </span><br><span class="line">    LUNCH_MENU_CHOICES=($&#123;LUNCH_MENU_CHOICES[@]&#125; $new_combo)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>传递给函数add_lunch_combo的参数保存在位置参数$1中，接着又保存在一个本地变量new_combo中，用来表示一个要即将要添加的Lunch菜单项。函数首先是在数组LUNCH_MENU_CHOICES中检查要添加的菜单项是否已经存在。只有在不存在的情况下，才会将它添加到数组LUNCH_MENU_CHOICES中去。注意，${LUNCH_MENU_CHOICES[@]}表示数组LUNCH_MENU_CHOICES的所有元素。<br>数组LUNCH_MENU_CHOICES是定义在文件build/envsetup.sh的一个全局变量，当文件build/envsetup.sh被加载的时候，这个数组会被初始化为化full-eng、full_x86-eng、vbox_x86-eng和full_mips-eng，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line"># add the default one here  </span><br><span class="line">add_lunch_combo full-eng  </span><br><span class="line">add_lunch_combo full_x86-eng  </span><br><span class="line">add_lunch_combo vbox_x86-eng  </span><br><span class="line">add_lunch_combo full_mips-eng</span><br></pre></td></tr></table></figure>
<p>这样当文件build/envsetup.sh加载完成之后，数组LUNCH_MENU_CHOICES就包含了当前源码支持的所有设备型号及其编译类型，于是当接下来我们执行lunch命令的时候，就可以通过数组LUNCH_MENU_CHOICES看到一个完整的Lunch藤蔓。</p>
<h4 id="二-lunch命令的执行过程"><a href="#二-lunch命令的执行过程" class="headerlink" title="二. lunch命令的执行过程"></a>二. lunch命令的执行过程</h4><p>lunch命令实际上是定义在文件build/envsetup.sh的一个函数，它的实现如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line">function lunch()  </span><br><span class="line">&#123;  </span><br><span class="line">    local answer  </span><br><span class="line">  </span><br><span class="line">    if [ &quot;$1&quot; ] ; then  </span><br><span class="line">        answer=$1  </span><br><span class="line">    else  </span><br><span class="line">        print_lunch_menu  </span><br><span class="line">        echo -n &quot;Which would you like? [full-eng] &quot;  </span><br><span class="line">        read answer  </span><br><span class="line">    fi  </span><br><span class="line">  </span><br><span class="line">    local selection=  </span><br><span class="line">  </span><br><span class="line">    if [ -z &quot;$answer&quot; ]  </span><br><span class="line">    then  </span><br><span class="line">        selection=full-eng  </span><br><span class="line">    elif (echo -n $answer | grep -q -e &quot;^[0-9][0-9]*$&quot;)  </span><br><span class="line">    then  </span><br><span class="line">        if [ $answer -le $&#123;#LUNCH_MENU_CHOICES[@]&#125; ]  </span><br><span class="line">        then  </span><br><span class="line">            selection=$&#123;LUNCH_MENU_CHOICES[$(($answer-1))]&#125;  </span><br><span class="line">        fi  </span><br><span class="line">    elif (echo -n $answer | grep -q -e &quot;^[^\-][^\-]*-[^\-][^\-]*$&quot;)  </span><br><span class="line">    then  </span><br><span class="line">        selection=$answer  </span><br><span class="line">    fi  </span><br><span class="line">  </span><br><span class="line">    if [ -z &quot;$selection&quot; ]  </span><br><span class="line">    then  </span><br><span class="line">        echo  </span><br><span class="line">        echo &quot;Invalid lunch combo: $answer&quot;  </span><br><span class="line">        return 1  </span><br><span class="line">    fi  </span><br><span class="line">  </span><br><span class="line">    export TARGET_BUILD_APPS=  </span><br><span class="line">  </span><br><span class="line">    local product=$(echo -n $selection | sed -e &quot;s/-.*$//&quot;)  </span><br><span class="line">    check_product $product  </span><br><span class="line">    if [ $? -ne 0 ]  </span><br><span class="line">    then  </span><br><span class="line">        echo  </span><br><span class="line">        echo &quot;** Don&apos;t have a product spec for: &apos;$product&apos;&quot;  </span><br><span class="line">        echo &quot;** Do you have the right repo manifest?&quot;  </span><br><span class="line">        product=  </span><br><span class="line">    fi  </span><br><span class="line">  </span><br><span class="line">    local variant=$(echo -n $selection | sed -e &quot;s/^[^\-]*-//&quot;)  </span><br><span class="line">    check_variant $variant  </span><br><span class="line">    if [ $? -ne 0 ]  </span><br><span class="line">    then  </span><br><span class="line">        echo  </span><br><span class="line">        echo &quot;** Invalid variant: &apos;$variant&apos;&quot;  </span><br><span class="line">        echo &quot;** Must be one of $&#123;VARIANT_CHOICES[@]&#125;&quot;  </span><br><span class="line">        variant=  </span><br><span class="line">    fi  </span><br><span class="line">  </span><br><span class="line">    if [ -z &quot;$product&quot; -o -z &quot;$variant&quot; ]  </span><br><span class="line">    then  </span><br><span class="line">        echo  </span><br><span class="line">        return 1  </span><br><span class="line">    fi  </span><br><span class="line">  </span><br><span class="line">    export TARGET_PRODUCT=$product  </span><br><span class="line">    export TARGET_BUILD_VARIANT=$variant  </span><br><span class="line">    export TARGET_BUILD_TYPE=release  </span><br><span class="line">  </span><br><span class="line">    echo  </span><br><span class="line">  </span><br><span class="line">    set_stuff_for_environment  </span><br><span class="line">    printconfig  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数lunch的执行逻辑如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. 检查是否带有参数，即位置参数$1是否等于空。如果不等于空的话，就表明带有参数，并且该参数是用来指定要编译的设备型号及其编译类型的。如果等于空的话，那么就调用另外一个函数print_lunch_menu来显示Lunch菜单项，并且通过调用read函数来等待用户输入。无论通过何种方式，最终变量answer的值就保存了用户所指定的备型号及其编译类型。</span><br><span class="line"></span><br><span class="line">        2. 对变量answer的值的合法性进行检查。如果等于空的话，就将它设置为默认值“full-eng”。如果不等于空的话，就分为三种情况考虑。第一种情况是值为数字，那么就需要确保该数字的大小不能超过Lunch菜单项的个数。在这种情况下，会将输入的数字索引到数组LUNCH_MENU_CHOICES中去，以便获得一个用来表示设备型号及其编译类型的文本。第二种情况是非数字文本，那么就需要确保该文本符合&lt;product&gt;-&lt;variant&gt;的形式，其中&lt;product&gt;表示设备型号，而&lt;variant&gt;表示编译类型 。第三种情况是除了前面两种情况之外的所有情况，这是非法的。经过合法性检查后，变量selection代表了用户所指定的备型号及其编译类型，如果它的值是非法的，即它的值等于空，那么函数lunch就不往下执行了。</span><br><span class="line"></span><br><span class="line">        3. 接下来是解析变量selection的值，也就是通过sed命令将它的&lt;product&gt;和&lt;variant&gt;值提取出来，并且分别保存在变量product和variant中。提取出来的product和variant值有可能是不合法的，因此需要进一步通过调用函数check_product和check_variant来检查。一旦检查失败，也就是函数check_product和check_variant的返回值$?等于非0，那么函数lunch就不往下执行了。</span><br><span class="line"></span><br><span class="line">        4. 通过以上合法性检查之后，就将变量product和variant的值保存在环境变量TARGET_PRODUCT和TARGET_BUILD_VARIANT中。此外，另外一个环境变量TARGET_BUILD_TYPE的值会被设置为&quot;release&quot;，表示此次编译是一个release版本的编译。另外，前面还有一个环境变量TARGET_BUILD_APPS，它的值被函数lunch设置为空，用来表示此次编译是对整个系统进行编译。如果环境变量TARGET_BUILD_APPS的值不等于空，那么就表示此次编译是只对某些APP模块进行编译，而这些APP模块就是由环境变量TARGET_BUILD_APPS来指定的。</span><br><span class="line"></span><br><span class="line">        5. 调用函数set_stuff_for_environment来配置环境，例如设置Java SDK路径和交叉编译工具路径等。</span><br><span class="line"></span><br><span class="line">        6. 调用函数printfconfig来显示已经配置好的编译环境参数。</span><br></pre></td></tr></table></figure>
<p>在上述执行过程中，函数check_product、check_variant和printconfig是比较关键的，因此接下来我们就继续分析它们的实现。</p>
<p> 函数check_product定义在文件build/envsetup.sh中，它的实现如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line"># check to see if the supplied product is one we can build  </span><br><span class="line">function check_product()  </span><br><span class="line">&#123;  </span><br><span class="line">    T=$(gettop)  </span><br><span class="line">    if [ ! &quot;$T&quot; ]; then  </span><br><span class="line">        echo &quot;Couldn&apos;t locate the top of the tree.  Try setting TOP.&quot; &gt;&amp;2  </span><br><span class="line">        return  </span><br><span class="line">    fi  </span><br><span class="line">    CALLED_FROM_SETUP=true BUILD_SYSTEM=build/core \  </span><br><span class="line">        TARGET_PRODUCT=$1 \  </span><br><span class="line">        TARGET_BUILD_VARIANT= \  </span><br><span class="line">        TARGET_BUILD_TYPE= \  </span><br><span class="line">        TARGET_BUILD_APPS= \  </span><br><span class="line">        get_build_var TARGET_DEVICE &gt; /dev/null  </span><br><span class="line">    # hide successful answers, but allow the errors to show  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数gettop用来返回Android源代码工程的根目录。函数check_product需要在Android源代码工程根目录或者子目录下调用。否则的话，函数check_product就出错返回。<br>        接下来函数check_product设置几个环境变量，其中最重要的是前面三个CALLED_FROM_SETUP、BUILD_SYSTEM和TARGET_PRODUCT。环境变量CALLED_FROM_SETUP的值等于true表示接下来执行的make命令是用来初始化Android编译环境的。环境变量BUILD_SYSTEM用来指定Android编译系统的核心目录，它的值被设置为build/core。环境变量TARGET_PRODUCT用来表示要检查的产品名称（也就是我们前面说的设备型号），它的值被设置为$1，即函数check_product的调用参数。</p>
<p>最后函数check_product调用函数get_build_var来检查由环境变量TARGET_PRODUCT指定的产品名称是否合法，注意，它的调用参数为TARGET_DEVICE。</p>
<p>函数get_build_var定义在文件build/envsetup.sh中，它的实现如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line"># Get the exact value of a build variable.  </span><br><span class="line">function get_build_var()  </span><br><span class="line">&#123;  </span><br><span class="line">    T=$(gettop)  </span><br><span class="line">    if [ ! &quot;$T&quot; ]; then  </span><br><span class="line">        echo &quot;Couldn&apos;t locate the top of the tree.  Try setting TOP.&quot; &gt;&amp;2  </span><br><span class="line">        return  </span><br><span class="line">    fi  </span><br><span class="line">    CALLED_FROM_SETUP=true BUILD_SYSTEM=build/core \  </span><br><span class="line">      make --no-print-directory -C &quot;$T&quot; -f build/core/config.mk dumpvar-$1  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就可以看到，函数get_build_var实际上就是通过make命令在Android源代码工程根目录中执行build/core/config.mk文件，并且将make目标设置为dumpvar-$1，也就是dumpvar-TARGET_DEVICE。<br>        文件build/core/config.mk的内容比较多，这里我们只关注与产品名称合法性检查相关的逻辑，这些逻辑也基本上涵盖了Android编译系统初始化的逻辑，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line">......  </span><br><span class="line">  </span><br><span class="line"># ---------------------------------------------------------------  </span><br><span class="line"># Define most of the global variables.  These are the ones that  </span><br><span class="line"># are specific to the user&apos;s build configuration.  </span><br><span class="line">include $(BUILD_SYSTEM)/envsetup.mk  </span><br><span class="line">  </span><br><span class="line"># Boards may be defined under $(SRC_TARGET_DIR)/board/$(TARGET_DEVICE)  </span><br><span class="line"># or under vendor/*/$(TARGET_DEVICE).  Search in both places, but  </span><br><span class="line"># make sure only one exists.  </span><br><span class="line"># Real boards should always be associated with an OEM vendor.  </span><br><span class="line">board_config_mk := \  </span><br><span class="line">    $(strip $(wildcard \  </span><br><span class="line">        $(SRC_TARGET_DIR)/board/$(TARGET_DEVICE)/BoardConfig.mk \  </span><br><span class="line">        device/*/$(TARGET_DEVICE)/BoardConfig.mk \  </span><br><span class="line">        vendor/*/$(TARGET_DEVICE)/BoardConfig.mk \  </span><br><span class="line">    ))  </span><br><span class="line">ifeq ($(board_config_mk),)  </span><br><span class="line">  $(error No config file found for TARGET_DEVICE $(TARGET_DEVICE))  </span><br><span class="line">endif  </span><br><span class="line">ifneq ($(words $(board_config_mk)),1)  </span><br><span class="line">  $(error Multiple board config files for TARGET_DEVICE $(TARGET_DEVICE): $(board_config_mk))  </span><br><span class="line">endif  </span><br><span class="line">include $(board_config_mk)  </span><br><span class="line">  </span><br><span class="line">......</span><br><span class="line">include $(BUILD_SYSTEM)/dumpvar.mk</span><br></pre></td></tr></table></figure>
<p>上述代码主要就是将envsetup.mk、BoardConfig,mk和dumpvar.mk三个Makefile片段文件加载进来。其中，envsetup.mk文件位于$(BUILD_SYSTEM)目录中，也就是build/core目录中，BoardConfig.mk文件的位置主要就是由环境变量TARGET_DEVICE来确定，它是用来描述目标产品的硬件模块信息的，例如CPU体系结构。环境变量TARGET_DEVICE用来描述目标设备，它的值是在envsetup.mk文件加载的过程中确定的。一旦目标设备确定后，就可以在$(SRC_TARGET_DIR)/board/$(TARGET_DEVICE)、device/<em>/$(TARGET_DEVICE)和vendor/</em>/$(TARGET_DEVICE)目录中找到对应的BoradConfig.mk文件。注意，变量SRC_TARGET_DIR的值等于build/target。最后，dumpvar.mk文件也是位于build/core目录中，它用来打印已经配置好的编译环境信息。<br>        接下来我们就通过进入到build/core/envsetup.mk文件来分析变量TARGET_DEVICE的值是如何确定的：</p>
<p>[plain] view plain copy</p>
<h1 id="Read-the-product-specs-so-we-an-get-TARGET-DEVICE-and-other"><a href="#Read-the-product-specs-so-we-an-get-TARGET-DEVICE-and-other" class="headerlink" title="Read the product specs so we an get TARGET_DEVICE and other"></a>Read the product specs so we an get TARGET_DEVICE and other</h1><h1 id="variables-that-we-need-in-order-to-locate-the-output-files"><a href="#variables-that-we-need-in-order-to-locate-the-output-files" class="headerlink" title="variables that we need in order to locate the output files."></a>variables that we need in order to locate the output files.</h1><p>include $(BUILD_SYSTEM)/product_config.mk<br>       它通过加载另外一个文件build/core/product_config.mk文件来确定变量TARGET_DEVICE以及其它与目标产品相关的变量的值。<br>       文件build/core/product_config.mk的内容很多，这里我们只关注变量TARGET_DEVICE设置相关的逻辑，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line">......  </span><br><span class="line">  </span><br><span class="line">ifneq ($(strip $(TARGET_BUILD_APPS)),)  </span><br><span class="line"># An unbundled app build needs only the core product makefiles.  </span><br><span class="line">all_product_configs := $(call get-product-makefiles,\  </span><br><span class="line">    $(SRC_TARGET_DIR)/product/AndroidProducts.mk)  </span><br><span class="line">else  </span><br><span class="line"># Read in all of the product definitions specified by the AndroidProducts.mk  </span><br><span class="line"># files in the tree.  </span><br><span class="line">all_product_configs := $(get-all-product-makefiles)  </span><br><span class="line">endif  </span><br><span class="line">  </span><br><span class="line"># all_product_configs consists items like:  </span><br><span class="line"># &lt;product_name&gt;:&lt;path_to_the_product_makefile&gt;  </span><br><span class="line"># or just &lt;path_to_the_product_makefile&gt; in case the product name is the  </span><br><span class="line"># same as the base filename of the product config makefile.  </span><br><span class="line">current_product_makefile :=  </span><br><span class="line">all_product_makefiles :=  </span><br><span class="line">$(foreach f, $(all_product_configs),\  </span><br><span class="line">    $(eval _cpm_words := $(subst :,$(space),$(f)))\  </span><br><span class="line">    $(eval _cpm_word1 := $(word 1,$(_cpm_words)))\  </span><br><span class="line">    $(eval _cpm_word2 := $(word 2,$(_cpm_words)))\  </span><br><span class="line">    $(if $(_cpm_word2),\  </span><br><span class="line">        $(eval all_product_makefiles += $(_cpm_word2))\  </span><br><span class="line">        $(if $(filter $(TARGET_PRODUCT),$(_cpm_word1)),\  </span><br><span class="line">            $(eval current_product_makefile += $(_cpm_word2)),),\  </span><br><span class="line">        $(eval all_product_makefiles += $(f))\  </span><br><span class="line">        $(if $(filter $(TARGET_PRODUCT),$(basename $(notdir $(f)))),\  </span><br><span class="line">            $(eval current_product_makefile += $(f)),)))  </span><br><span class="line">_cpm_words :=  </span><br><span class="line">_cpm_word1 :=  </span><br><span class="line">_cpm_word2 :=  </span><br><span class="line">current_product_makefile := $(strip $(current_product_makefile))  </span><br><span class="line">all_product_makefiles := $(strip $(all_product_makefiles))  </span><br><span class="line">  </span><br><span class="line">ifneq (,$(filter product-graph dump-products, $(MAKECMDGOALS)))  </span><br><span class="line"># Import all product makefiles.  </span><br><span class="line">$(call import-products, $(all_product_makefiles))  </span><br><span class="line">else  </span><br><span class="line"># Import just the current product.  </span><br><span class="line">ifndef current_product_makefile  </span><br><span class="line">$(error Cannot locate config makefile for product &quot;$(TARGET_PRODUCT)&quot;)  </span><br><span class="line">endif  </span><br><span class="line">ifneq (1,$(words $(current_product_makefile)))  </span><br><span class="line">$(error Product &quot;$(TARGET_PRODUCT)&quot; ambiguous: matches $(current_product_makefile))  </span><br><span class="line">endif  </span><br><span class="line">$(call import-products, $(current_product_makefile))  </span><br><span class="line">endif  # Import all or just the current product makefile  </span><br><span class="line">  </span><br><span class="line">......  </span><br><span class="line">  </span><br><span class="line"># Convert a short name like &quot;sooner&quot; into the path to the product  </span><br><span class="line"># file defining that product.  </span><br><span class="line">#  </span><br><span class="line">INTERNAL_PRODUCT := $(call resolve-short-product-name, $(TARGET_PRODUCT))  </span><br><span class="line">ifneq ($(current_product_makefile),$(INTERNAL_PRODUCT))  </span><br><span class="line">$(error PRODUCT_NAME inconsistent in $(current_product_makefile) and $(INTERNAL_PRODUCT))  </span><br><span class="line">endif  </span><br><span class="line">current_product_makefile :=  </span><br><span class="line">all_product_makefiles :=  </span><br><span class="line">all_product_configs :=  </span><br><span class="line">  </span><br><span class="line"># Find the device that this product maps to.  </span><br><span class="line">TARGET_DEVICE := $(PRODUCTS.$(INTERNAL_PRODUCT).PRODUCT_DEVICE)  </span><br><span class="line">  </span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>上述代码的执行逻辑如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. 检查环境变量TARGET_BUILD_APPS的值是否等于空。如果不等于空，那么就说明此次编译不是针对整个系统，因此只要将核心的产品相关的Makefile文件加载进来就行了，否则的话，就要将所有与产品相关的Makefile文件加载进来的。核心产品Makefile文件在$(SRC_TARGET_DIR)/product/AndroidProducts.mk文件中指定，也就是在build/target/product/AndroidProducts.mk文件，通过调用函数get-product-makefiles可以获得。所有与产品相关的Makefile文件可以通过另外一个函数get-all-product-makefiles获得。无论如何，最终获得的产品Makefie文件列表保存在变量all_product_configs中。</span><br><span class="line"></span><br><span class="line">       2. 遍历变量all_product_configs所描述的产品Makefile列表，并且在这些Makefile文件中，找到名称与环境变量TARGET_PRODUCT的值相同的文件，保存在另外一个变量current_product_makefile中，作为需要为当前指定的产品所加载的Makefile文件列表。在这个过程当中，上一步找到的所有的产品Makefile文件也会保存在变量all_product_makefiles中。注意，环境变量TARGET_PRODUCT的值是在我们执行lunch命令的时候设置并且传递进来的。</span><br><span class="line"></span><br><span class="line">       3.  如果指定的make目标等于product-graph或者dump-products，那么就将所有的产品相关的Makefile文件加载进来，否则的话，只加载与目标产品相关的Makefile文件。从前面的分析可以知道，此时的make目标为dumpvar-TARGET_DEVICE，因此接下来只会加载与目标产品，即$(TARGET_PRODUCT)，相关的Makefile文件，这是通过调用另外一个函数import-products实现的。</span><br><span class="line"></span><br><span class="line">       4. 调用函数resolve-short-product-name解析环境变量TARGET_PRODUCT的值，将它变成一个Makefile文件路径。并且保存在变量INTERNAL_PRODUCT中。这里要求变量INTERNAL_PRODUCT和current_product_makefile的值相等，否则的话，就说明用户指定了一个非法的产品名称。</span><br><span class="line"></span><br><span class="line">       5. 找到一个名称为PRODUCTS.$(INTERNAL_PRODUCT).PRODUCT_DEVICE的变量，并且将它的值保存另外一个变量TARGET_DEVICE中。变量PRODUCTS.$(INTERNAL_PRODUCT).PRODUCT_DEVICE是在加载产品Makefile文件的过程中定义的，用来描述当前指定的产品的名称。</span><br></pre></td></tr></table></figure>
<p>上述过程主要涉及到了get-all-product-makefiles、import-products和resolve-short-product-name三个关键函数，理解它们的执行过程对理解Android编译系统的初始化过程很有帮助，接下来我们分别分析它们的实现。</p>
<p>函数get-all-product-makefiles定义在文件build/core/product.mk中，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line">#  </span><br><span class="line"># Returns the sorted concatenation of all PRODUCT_MAKEFILES  </span><br><span class="line"># variables set in all AndroidProducts.mk files.  </span><br><span class="line"># $(call ) isn&apos;t necessary.  </span><br><span class="line">#  </span><br><span class="line">define get-all-product-makefiles  </span><br><span class="line">$(call get-product-makefiles,$(_find-android-products-files))  </span><br><span class="line">endef</span><br></pre></td></tr></table></figure>
<p>它首先是调用函数_find-android-products-files来找到Android源代码目录中定义的所有AndroidProducts.mk文件，然后再调用函数get-product-makefiles获得在这里AndroidProducts.mk文件里面定义的产品Makefile文件。<br>       函数_find-android-products-files也是定义在文件build/core/product.mk中，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line">#  </span><br><span class="line"># Returns the list of all AndroidProducts.mk files.  </span><br><span class="line"># $(call ) isn&apos;t necessary.  </span><br><span class="line">#  </span><br><span class="line">define _find-android-products-files  </span><br><span class="line">$(shell test -d device &amp;&amp; find device -maxdepth 6 -name AndroidProducts.mk) \  </span><br><span class="line">  $(shell test -d vendor &amp;&amp; find vendor -maxdepth 6 -name AndroidProducts.mk) \  </span><br><span class="line">  $(SRC_TARGET_DIR)/product/AndroidProducts.mk  </span><br><span class="line">endef  </span><br><span class="line">      从这里就可以看出，Android源代码目录中定义的所有AndroidProducts.mk文件位于device、vendor或者build/target/product目录或者相应的子目录（最深是6层）中。</span><br><span class="line">      函数get-product-makefiles也是定义在文件build/core/product.mk中，如下所示：</span><br><span class="line"></span><br><span class="line">[plain] view plain copy</span><br><span class="line">#  </span><br><span class="line"># Returns the sorted concatenation of PRODUCT_MAKEFILES  </span><br><span class="line"># variables set in the given AndroidProducts.mk files.  </span><br><span class="line"># $(1): the list of AndroidProducts.mk files.  </span><br><span class="line">#  </span><br><span class="line">define get-product-makefiles  </span><br><span class="line">$(sort \  </span><br><span class="line">  $(foreach f,$(1), \  </span><br><span class="line">    $(eval PRODUCT_MAKEFILES :=) \  </span><br><span class="line">    $(eval LOCAL_DIR := $(patsubst %/,%,$(dir $(f)))) \  </span><br><span class="line">    $(eval include $(f)) \  </span><br><span class="line">    $(PRODUCT_MAKEFILES) \  </span><br><span class="line">   ) \  </span><br><span class="line">  $(eval PRODUCT_MAKEFILES :=) \  </span><br><span class="line">  $(eval LOCAL_DIR :=) \  </span><br><span class="line"> )  </span><br><span class="line">endef</span><br></pre></td></tr></table></figure>
<p>这个函数实际上就是遍历参数$1所描述的AndroidProucts.mk文件列表，并且将定义在这些AndroidProucts.mk文件中的变量PRODUCT_MAKEFILES的值提取出来，形成一个列表返回给调用者。<br>       例如，在build/target/product/AndroidProducts.mk文件中，变量PRODUCT_MAKEFILES的值如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line"># Unbundled apps will be built with the most generic product config.  </span><br><span class="line">ifneq ($(TARGET_BUILD_APPS),)  </span><br><span class="line">PRODUCT_MAKEFILES := \  </span><br><span class="line">    $(LOCAL_DIR)/full.mk \  </span><br><span class="line">    $(LOCAL_DIR)/full_x86.mk \  </span><br><span class="line">    $(LOCAL_DIR)/full_mips.mk  </span><br><span class="line">else  </span><br><span class="line">PRODUCT_MAKEFILES := \  </span><br><span class="line">    $(LOCAL_DIR)/core.mk \  </span><br><span class="line">    $(LOCAL_DIR)/generic.mk \  </span><br><span class="line">    $(LOCAL_DIR)/generic_x86.mk \  </span><br><span class="line">    $(LOCAL_DIR)/generic_mips.mk \  </span><br><span class="line">    $(LOCAL_DIR)/full.mk \  </span><br><span class="line">    $(LOCAL_DIR)/full_x86.mk \  </span><br><span class="line">    $(LOCAL_DIR)/full_mips.mk \  </span><br><span class="line">    $(LOCAL_DIR)/vbox_x86.mk \  </span><br><span class="line">    $(LOCAL_DIR)/sdk.mk \  </span><br><span class="line">    $(LOCAL_DIR)/sdk_x86.mk \  </span><br><span class="line">    $(LOCAL_DIR)/sdk_mips.mk \  </span><br><span class="line">    $(LOCAL_DIR)/large_emu_hw.mk  </span><br><span class="line">endif</span><br></pre></td></tr></table></figure>
<p>里列出的每一个文件都对应于一个产品。<br>       我们再来看函数import-products的实现，它定义在文件build/core/product.mk中，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line">#  </span><br><span class="line"># $(1): product makefile list  </span><br><span class="line">#  </span><br><span class="line">#TODO: check to make sure that products have all the necessary vars defined  </span><br><span class="line">define import-products  </span><br><span class="line">$(call import-nodes,PRODUCTS,$(1),$(_product_var_list))  </span><br><span class="line">endef</span><br></pre></td></tr></table></figure>
<p>它调用另外一个函数import-nodes来加载由参数$1所指定的产品Makefile文件，并且指定了另外两个参数PRODUCTS和$(_product_var_list)。其中，变量_product_var_list也是定义在文件build/core/product.mk中，它的值如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line">_product_var_list := \  </span><br><span class="line">    PRODUCT_NAME \  </span><br><span class="line">    PRODUCT_MODEL \  </span><br><span class="line">    PRODUCT_LOCALES \  </span><br><span class="line">    PRODUCT_AAPT_CONFIG \  </span><br><span class="line">    PRODUCT_AAPT_PREF_CONFIG \  </span><br><span class="line">    PRODUCT_PACKAGES \  </span><br><span class="line">    PRODUCT_PACKAGES_DEBUG \  </span><br><span class="line">    PRODUCT_PACKAGES_ENG \  </span><br><span class="line">    PRODUCT_PACKAGES_TESTS \  </span><br><span class="line">    PRODUCT_DEVICE \  </span><br><span class="line">    PRODUCT_MANUFACTURER \  </span><br><span class="line">    PRODUCT_BRAND \  </span><br><span class="line">    PRODUCT_PROPERTY_OVERRIDES \  </span><br><span class="line">    PRODUCT_DEFAULT_PROPERTY_OVERRIDES \  </span><br><span class="line">    PRODUCT_CHARACTERISTICS \  </span><br><span class="line">    PRODUCT_COPY_FILES \  </span><br><span class="line">    PRODUCT_OTA_PUBLIC_KEYS \  </span><br><span class="line">    PRODUCT_EXTRA_RECOVERY_KEYS \  </span><br><span class="line">    PRODUCT_PACKAGE_OVERLAYS \  </span><br><span class="line">    DEVICE_PACKAGE_OVERLAYS \  </span><br><span class="line">    PRODUCT_TAGS \  </span><br><span class="line">    PRODUCT_SDK_ADDON_NAME \  </span><br><span class="line">    PRODUCT_SDK_ADDON_COPY_FILES \  </span><br><span class="line">    PRODUCT_SDK_ADDON_COPY_MODULES \  </span><br><span class="line">    PRODUCT_SDK_ADDON_DOC_MODULES \  </span><br><span class="line">    PRODUCT_DEFAULT_WIFI_CHANNELS \  </span><br><span class="line">    PRODUCT_DEFAULT_DEV_CERTIFICATE \  </span><br><span class="line">    PRODUCT_RESTRICT_VENDOR_FILES \  </span><br><span class="line">    PRODUCT_VENDOR_KERNEL_HEADERS \  </span><br><span class="line">    PRODUCT_FACTORY_RAMDISK_MODULES \  </span><br><span class="line">    PRODUCT_FACTORY_BUNDLE_MODULES</span><br></pre></td></tr></table></figure>
<p> 它描述的是在产品Makefile文件中定义在各种变量。<br>       函数import-nodes定义在文件build/core/node_fns.mk中，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line">#  </span><br><span class="line"># $(1): output list variable name, like &quot;PRODUCTS&quot; or &quot;DEVICES&quot;  </span><br><span class="line"># $(2): list of makefiles representing nodes to import  </span><br><span class="line"># $(3): list of node variable names  </span><br><span class="line">#  </span><br><span class="line">define import-nodes  </span><br><span class="line">$(if \  </span><br><span class="line">  $(foreach _in,$(2), \  </span><br><span class="line">    $(eval _node_import_context := _nic.$(1).[[$(_in)]]) \  </span><br><span class="line">    $(if $(_include_stack),$(eval $(error ASSERTION FAILED: _include_stack \  </span><br><span class="line">                should be empty here: $(_include_stack))),) \  </span><br><span class="line">    $(eval _include_stack := ) \  </span><br><span class="line">    $(call _import-nodes-inner,$(_node_import_context),$(_in),$(3)) \  </span><br><span class="line">    $(call move-var-list,$(_node_import_context).$(_in),$(1).$(_in),$(3)) \  </span><br><span class="line">    $(eval _node_import_context :=) \  </span><br><span class="line">    $(eval $(1) := $($(1)) $(_in)) \  </span><br><span class="line">    $(if $(_include_stack),$(eval $(error ASSERTION FAILED: _include_stack \  </span><br><span class="line">                should be empty here: $(_include_stack))),) \  </span><br><span class="line">   ) \  </span><br><span class="line">,)  </span><br><span class="line">endef</span><br></pre></td></tr></table></figure>
<p>这个函数主要是做了三件事情：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. 调用函数_import-nodes-inner将参数$2描述的每一个产品Makefile文件加载进来。</span><br><span class="line"></span><br><span class="line">       2. 调用函数move-var-list将定义在前面所加载的产品Makefile文件里面的由参数$3指定的变量的值分别拷贝到另外一组独立的变量中。</span><br><span class="line"></span><br><span class="line">       3. 将参数$2描述的每一个产品Makefile文件路径以空格分隔保存在参数$1所描述的变量中，也就是保存在变量PRODUCTS中。</span><br><span class="line"></span><br><span class="line">       上述第二件事情需要进一步解释一下。由于当前加载的每一个文件都会定义相同的变量，为了区分这些变量，我们需要在这些变量前面加一些前缀。例如，假设加载了build/target/product/full.mk这个产品Makefile文件，它里面定义了以下几个变量：</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line"># Overrides  </span><br><span class="line">PRODUCT_NAME := full  </span><br><span class="line">PRODUCT_DEVICE := generic  </span><br><span class="line">PRODUCT_BRAND := Android  </span><br><span class="line">PRODUCT_MODEL := Full Android on Emulator  </span><br><span class="line">       当调用了函数move-var-list对它进行解析后，就会得到以下的新变量：</span><br><span class="line">[plain] view plain copy</span><br><span class="line">PRODUCTS.build/target/product/full.mk.PRODUCT_NAME := full  </span><br><span class="line">PRODUCTS.build/target/product/full.mk.PRODUCT_DEVICE := generic  </span><br><span class="line">PRODUCTS.build/target/product/full.mk.PRODUCT_BRAND := Android  </span><br><span class="line">PRODUCTS.build/target/product/full.mk.PRODUCT_MODEL := Full Android on Emulator</span><br></pre></td></tr></table></figure>
<p>正是由于调用了函数move-var-list，我们在build/core/product_config.mk文件中可以通过PRODUCTS.$(INTERNAL_PRODUCT).PRODUCT_DEVICE来设置变量TARGET_DEVICE的值。<br>       回到build/core/config.mk文件中，接下来我们再看BoardConfig.mk文件的加载过程。前面提到，当前要加载的BoardConfig.mk文件由变量TARGET_DEVICE来确定。例如，假设我们在运行lunch命令时，输入的文本为full-eng，那么build/target/product/full.mk就会被加载，并且我们得到TARGET_DEVICE的值就为generic，接下来加载的BoradConfig.mk文件就会在build/target/board/generic目录中找到。</p>
<p>BoardConfig.mk文件定义的信息可以参考build/target/board/generic/BoardConfig.mk文件的内容，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line"># config.mk  </span><br><span class="line">#  </span><br><span class="line"># Product-specific compile-time definitions.  </span><br><span class="line">#  </span><br><span class="line">  </span><br><span class="line"># The generic product target doesn&apos;t have any hardware-specific pieces.  </span><br><span class="line">TARGET_NO_BOOTLOADER := true  </span><br><span class="line">TARGET_NO_KERNEL := true  </span><br><span class="line">TARGET_ARCH := arm  </span><br><span class="line">  </span><br><span class="line"># Note: we build the platform images for ARMv7-A _without_ NEON.  </span><br><span class="line">#  </span><br><span class="line"># Technically, the emulator supports ARMv7-A _and_ NEON instructions, but  </span><br><span class="line"># emulated NEON code paths typically ends up 2x slower than the normal C code  </span><br><span class="line"># it is supposed to replace (unlike on real devices where it is 2x to 3x  </span><br><span class="line"># faster).  </span><br><span class="line">#  </span><br><span class="line"># What this means is that the platform image will not use NEON code paths  </span><br><span class="line"># that are slower to emulate. On the other hand, it is possible to emulate  </span><br><span class="line"># application code generated with the NDK that uses NEON in the emulator.  </span><br><span class="line">#  </span><br><span class="line">TARGET_ARCH_VARIANT := armv7-a  </span><br><span class="line">TARGET_CPU_ABI := armeabi-v7a  </span><br><span class="line">TARGET_CPU_ABI2 := armeabi  </span><br><span class="line">ARCH_ARM_HAVE_TLS_REGISTER := true  </span><br><span class="line">  </span><br><span class="line">HAVE_HTC_AUDIO_DRIVER := true  </span><br><span class="line">BOARD_USES_GENERIC_AUDIO := true  </span><br><span class="line">  </span><br><span class="line"># no hardware camera  </span><br><span class="line">USE_CAMERA_STUB := true  </span><br><span class="line">  </span><br><span class="line"># Enable dex-preoptimization to speed up the first boot sequence  </span><br><span class="line"># of an SDK AVD. Note that this operation only works on Linux for now  </span><br><span class="line">ifeq ($(HOST_OS),linux)  </span><br><span class="line">  ifeq ($(WITH_DEXPREOPT),)  </span><br><span class="line">    WITH_DEXPREOPT := true  </span><br><span class="line">  endif  </span><br><span class="line">endif  </span><br><span class="line">  </span><br><span class="line"># Build OpenGLES emulation guest and host libraries  </span><br><span class="line">BUILD_EMULATOR_OPENGL := true  </span><br><span class="line">  </span><br><span class="line"># Build and enable the OpenGL ES View renderer. When running on the emulator,  </span><br><span class="line"># the GLES renderer disables itself if host GL acceleration isn&apos;t available.  </span><br><span class="line">USE_OPENGL_RENDERER := true</span><br></pre></td></tr></table></figure>
<p>它描述了产品的Boot Loader、Kernel、CPU体系结构、CPU ABI和Opengl加速等信息。<br>       再回到build/core/config.mk文件中，它最后加载build/core/dumpvar.mk文件。加载build/core/dumpvar.mk文件是为了生成make目标，以便可以对这些目标进行操作。例如，在我们这个情景中，我们要执行的make目标是dumpvar-TARGET_DEVICE，因此在加载build/core/dumpvar.mk文件的过程中，就会生成dumpvar-TARGET_DEVICE目标。</p>
<p>文件build/core/dumpvar.mk的内容也比较多，这里我们只关注生成make目标相关的逻辑：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line">......  </span><br><span class="line">  </span><br><span class="line"># The &quot;dumpvar&quot; stuff lets you say something like  </span><br><span class="line">#  </span><br><span class="line">#     CALLED_FROM_SETUP=true \  </span><br><span class="line">#       make -f config/envsetup.make dumpvar-TARGET_OUT  </span><br><span class="line"># or  </span><br><span class="line">#     CALLED_FROM_SETUP=true \  </span><br><span class="line">#       make -f config/envsetup.make dumpvar-abs-HOST_OUT_EXECUTABLES  </span><br><span class="line">#  </span><br><span class="line"># The plain (non-abs) version just dumps the value of the named variable.  </span><br><span class="line"># The &quot;abs&quot; version will treat the variable as a path, and dumps an  </span><br><span class="line"># absolute path to it.  </span><br><span class="line">#  </span><br><span class="line">dumpvar_goals := \  </span><br><span class="line">    $(strip $(patsubst dumpvar-%,%,$(filter dumpvar-%,$(MAKECMDGOALS))))  </span><br><span class="line">ifdef dumpvar_goals  </span><br><span class="line">  </span><br><span class="line">  ifneq ($(words $(dumpvar_goals)),1)  </span><br><span class="line">    $(error Only one &quot;dumpvar-&quot; goal allowed. Saw &quot;$(MAKECMDGOALS)&quot;)  </span><br><span class="line">  endif  </span><br><span class="line">  </span><br><span class="line">  # If the goal is of the form &quot;dumpvar-abs-VARNAME&quot;, then  </span><br><span class="line">  # treat VARNAME as a path and return the absolute path to it.  </span><br><span class="line">  absolute_dumpvar := $(strip $(filter abs-%,$(dumpvar_goals)))  </span><br><span class="line">  ifdef absolute_dumpvar  </span><br><span class="line">    dumpvar_goals := $(patsubst abs-%,%,$(dumpvar_goals))  </span><br><span class="line">    ifneq ($(filter /%,$($(dumpvar_goals))),)  </span><br><span class="line">      DUMPVAR_VALUE := $($(dumpvar_goals))  </span><br><span class="line">    else  </span><br><span class="line">      DUMPVAR_VALUE := $(PWD)/$($(dumpvar_goals))  </span><br><span class="line">    endif  </span><br><span class="line">    dumpvar_target := dumpvar-abs-$(dumpvar_goals)  </span><br><span class="line">  else  </span><br><span class="line">    DUMPVAR_VALUE := $($(dumpvar_goals))  </span><br><span class="line">    dumpvar_target := dumpvar-$(dumpvar_goals)  </span><br><span class="line">  endif  </span><br><span class="line">  </span><br><span class="line">.PHONY: $(dumpvar_target)  </span><br><span class="line">$(dumpvar_target):  </span><br><span class="line">    @echo $(DUMPVAR_VALUE)  </span><br><span class="line">  </span><br><span class="line">endif # dumpvar_goals  </span><br><span class="line">  </span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p> 我们在执行make命令时，指定的目示会经由MAKECMDGOALS变量传递到Makefile中，因此通过变量MAKECMDGOALS可以获得make目标。<br>      上述代码的逻辑很简单，例如，在我们这个情景中，指定的make目标为dumpvar-TARGET_DEVICE，那么就会得到变量DUMPVAR_VALUE的值为$(TARGET_DEVICE)。TARGET_DEVICE的值在前面已经被设置为“generic”，因此变量DUMPVAR_VALUE的值就等于“generic”。此外，变量dumpvar_target的被设置为“dumpvar-TARGET_DEVICE”。最后我们就可以得到以下的make规则：</p>
<p>[plain] view plain copy<br>.PHONY dumpvar-TARGET_DEVICE<br>dumpvar-TARGET_DEVICE:<br>    @echo generic<br>       至此，在build/envsetup.sh文件中定义的函数check_product就分析完成了。看完了之后，小伙伴们可能会问，前面不是说这个函数是用来检查用户输入的产品名称是否合法的吗？但是这里没看出哪一段代码给出了true或者false的答案啊。实际上，在前面分析的build/core/config.mk和build/core/product_config.mk等文件的加载过程中，如果发现输入的产品名称是非法的，也就是找不到相应的产品Makefile文件，那么就会通过调用error函数来产生一个错误，这时候函数check_product的返回值$?就会等于非0值。<br>       接下来我们还要继续分析在build/envsetup.sh文件中定义的函数check_variant的实现，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line">VARIANT_CHOICES=(user userdebug eng)  </span><br><span class="line">  </span><br><span class="line"># check to see if the supplied variant is valid  </span><br><span class="line">function check_variant()  </span><br><span class="line">&#123;  </span><br><span class="line">    for v in $&#123;VARIANT_CHOICES[@]&#125;  </span><br><span class="line">    do  </span><br><span class="line">        if [ &quot;$v&quot; = &quot;$1&quot; ]  </span><br><span class="line">        then  </span><br><span class="line">            return 0  </span><br><span class="line">        fi  </span><br><span class="line">    done  </span><br><span class="line">    return 1  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数的实现就简单多了。合法的编译类型定义在数组VARIANT_CHOICES中，并且它只有三个值user、userdebug和eng。其中，user表示发布版本，userdebug表示带调试信息的发布版本，而eng表标工程机版本。<br>       最后，我们再来分析在build/envsetup.sh文件中定义的函数printconfig的实现，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line">function printconfig()  </span><br><span class="line">&#123;  </span><br><span class="line">    T=$(gettop)  </span><br><span class="line">    if [ ! &quot;$T&quot; ]; then  </span><br><span class="line">        echo &quot;Couldn&apos;t locate the top of the tree.  Try setting TOP.&quot; &gt;&amp;2  </span><br><span class="line">        return  </span><br><span class="line">    fi  </span><br><span class="line">    get_build_var report_config  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 对比我们前面对函数check_product的分析，就会发现函数printconfig的实现与这很相似，都是通过调用get_build_var来获得相关的信息，但是这里传递给函数get_build_var的参数为report_config。<br>       我们跳过前面build/core/config.mk和build/core/envsetup.mk等文件对目标产品Makefile文件的加载，直接跳到build/core/dumpvar.mk文件来查看与report_config这个make目标相关的逻辑：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line">......  </span><br><span class="line">  </span><br><span class="line">dumpvar_goals := \  </span><br><span class="line">    $(strip $(patsubst dumpvar-%,%,$(filter dumpvar-%,$(MAKECMDGOALS))))  </span><br><span class="line">.....  </span><br><span class="line">  </span><br><span class="line">ifneq ($(dumpvar_goals),report_config)  </span><br><span class="line">PRINT_BUILD_CONFIG:=  </span><br><span class="line">endif  </span><br><span class="line">  </span><br><span class="line">......  </span><br><span class="line">  </span><br><span class="line">ifneq ($(PRINT_BUILD_CONFIG),)  </span><br><span class="line">HOST_OS_EXTRA:=$(shell python -c &quot;import platform; print(platform.platform())&quot;)  </span><br><span class="line">$(info ============================================)  </span><br><span class="line">$(info   PLATFORM_VERSION_CODENAME=$(PLATFORM_VERSION_CODENAME))  </span><br><span class="line">$(info   PLATFORM_VERSION=$(PLATFORM_VERSION))  </span><br><span class="line">$(info   TARGET_PRODUCT=$(TARGET_PRODUCT))  </span><br><span class="line">$(info   TARGET_BUILD_VARIANT=$(TARGET_BUILD_VARIANT))  </span><br><span class="line">$(info   TARGET_BUILD_TYPE=$(TARGET_BUILD_TYPE))  </span><br><span class="line">$(info   TARGET_BUILD_APPS=$(TARGET_BUILD_APPS))  </span><br><span class="line">$(info   TARGET_ARCH=$(TARGET_ARCH))  </span><br><span class="line">$(info   TARGET_ARCH_VARIANT=$(TARGET_ARCH_VARIANT))  </span><br><span class="line">$(info   HOST_ARCH=$(HOST_ARCH))  </span><br><span class="line">$(info   HOST_OS=$(HOST_OS))  </span><br><span class="line">$(info   HOST_OS_EXTRA=$(HOST_OS_EXTRA))  </span><br><span class="line">$(info   HOST_BUILD_TYPE=$(HOST_BUILD_TYPE))  </span><br><span class="line">$(info   BUILD_ID=$(BUILD_ID))  </span><br><span class="line">$(info   OUT_DIR=$(OUT_DIR))  </span><br><span class="line">$(info ============================================)  </span><br><span class="line">endif</span><br></pre></td></tr></table></figure>
<p>变量PRINT_BUILD_CONFIG定义在文件build/core/envsetup.mk中，默认值设置为true。当make目标为report-config的时候，变量PRINT_BUILD_CONFIG的值就会被设置为空。因此，接下来就会打印一系列用来描述编译环境配置的变量的值，也就是我们执行lunch命令后看到的输出。注意，这些环境配置相关的变量量都是在加载build/core/config.mk和build/core/envsetup.mk文件的过程中设置的，就类似于前面我们分析的TARGET_DEVICE变量的值的设置过程。<br>       至此，我们就分析完成Android编译系统环境的初始化过程了。从分析的过程可以知道，Android编译系统环境是由build/core/config.mk、build/core/envsetup.mk、build/core/product_config.mk、AndroidProducts.mk和BoardConfig.mk等文件来完成的。这些mk文件涉及到非常多的细节，而我们这里只提供了一个大体的骨架和脉络，希望能够起到抛砖引玉的作用。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2017/04/05/编译系统环境初始化过程/" data-id="cjh0pyi9600114e0cx485ko01" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2017/04/05/编译系统环境初始化过程/#comments" class="article-comment-link">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-添加SE安全策略" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/03/15/添加SE安全策略/">添加SE安全策略</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/03/15/添加SE安全策略/">
            <time datetime="2017-03-15T11:10:10.000Z" itemprop="datePublished">2017-03-15</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/AOSP/">AOSP</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/SEAndroid/">SEAndroid</a>, <a class="tag-link" href="/tags/编译/">编译</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="一、-问题复现"><a href="#一、-问题复现" class="headerlink" title="一、 问题复现"></a>一、 问题复现</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.service ro_isn /system/bin/isn.sh </span><br><span class="line">2.class late_start</span><br><span class="line">3.user root</span><br><span class="line">4.oneshot</span><br></pre></td></tr></table></figure>
<p>kernel log会打印以下log：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Warning!  Service ro_isn needs a SELinux domain defined; please fix!</span><br></pre></td></tr></table></figure>
<p>这是因为<strong>Service ro_isn</strong>没有在<strong>SELinux</strong>的监控之下，这种情况会提示你定义一个SELinux。<br>在这种情况下，你可以：<br>1.无视该条log，Service功能不受影响。各种权限不受限制。但是这样做会有风险。<br>2.为<strong>Service ro_isn</strong>定义一个<strong>SELinux</strong> <strong>domain</strong>，仅添加需要的权限，未允许的权限操作会被拒绝。具体方法请参照下节。</p>
<h2 id="二、解决方法"><a href="#二、解决方法" class="headerlink" title="二、解决方法"></a>二、解决方法</h2><h3 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">devices/qcom/sepolicy/common/</span><br></pre></td></tr></table></figure>
<p>目录下新增<strong>ro_isn.te</strong>文件，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type ro_isn, domain; </span><br><span class="line">type ro_isn_exec, exec_type, file_type;</span><br></pre></td></tr></table></figure>
<h2 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h2><p>在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">devices/qcom/sepolicy/Android.mk</span><br></pre></td></tr></table></figure></p>
<p>中添加<strong>ro_isn.te</strong>文件，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BOARD_SEPOLICY_UNION := \</span><br><span class="line">... \</span><br><span class="line">        hostapd.te \</span><br><span class="line">        ro_isn.te</span><br></pre></td></tr></table></figure>
<h2 id="3"><a href="#3" class="headerlink" title="3."></a>3.</h2><p>在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">devices/qcom/sepolicy/common/file_contexts</span><br></pre></td></tr></table></figure></p>
<p>中增加如下内容：</p>
<p>###################################</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># System files</span><br><span class="line">#</span><br><span class="line">...</span><br><span class="line">/system/vendor/bin/slim_ap_daemon</span><br><span class="line">u:object_r:location_exec:s0</span><br><span class="line">/system/bin/isn.sh</span><br><span class="line">u:object_r:ro_isn_exec:s0</span><br></pre></td></tr></table></figure>
<h2 id="4"><a href="#4" class="headerlink" title="4."></a>4.</h2><p>在<strong>init.rc</strong>中<strong>service ro_isn</strong>下添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">secure context by seclabel </span><br><span class="line">service ro_isn /system/bin/isn.sh </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">class late_start </span><br><span class="line">user root </span><br><span class="line">oneshot </span><br><span class="line">seclabel u:r:ro_isn:s0</span><br></pre></td></tr></table></figure></p>
<h2 id="5"><a href="#5" class="headerlink" title="5."></a>5.</h2><p>编译并烧录bootimage</p>
<h2 id="6"><a href="#6" class="headerlink" title="6."></a>6.</h2><p>如果编译不成功，失败原因如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Error while expanding policy</span><br><span class="line">libsepol.check_assertion_helper: neverallow on line 233 of external/sepolicy/domain.te (or line 5194 of policy.conf) violated by allow ro_isn system_file:file &#123; entrypoint &#125;;</span><br><span class="line">make: *** [out/target/product/msm8226/obj/ETC/sepolicy_intermediates/sepolicy] 错误 1</span><br></pre></td></tr></table></figure>
<p>这是因为系统在<strong>domain.te</strong>中定义了全局的<strong>neverallow策略</strong>，与<strong>ro_isn.te</strong>中<strong>allow</strong>的策略有冲突：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow ro_isn system_file:file &#123; entrypoint &#125;;</span><br><span class="line">neverallow domain &#123; file_type -exec_type &#125;:file entrypoint;</span><br></pre></td></tr></table></figure>
<p>请确定自己的service有必要需要这个权限。如无必要，请在自己的code中删除掉相关操作；如必要，可以在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">external/sepolicy/domain.te</span><br></pre></td></tr></table></figure></p>
<p>中冲突的<strong>neverallow</strong><br>语句中添加自己为例外：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">neverallow &#123;</span><br><span class="line">    domain</span><br><span class="line">    -ro_isn</span><br><span class="line">&#125; &#123; file_type -exec_type &#125;:file entrypoint;</span><br></pre></td></tr></table></figure>
<h2 id="7"><a href="#7" class="headerlink" title="7."></a>7.</h2><p>在<strong>service ro_isn</strong>运行时，搜索关于“<strong>ro_isn</strong>”的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">avc: denied log</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;6&gt;[ 13.547188](CPU:0-pid:320:logd.auditd) type=1400 audit(17468992.410:7): avc: denied &#123; entrypoint &#125; for pid=272 comm=&quot;init&quot; path=&quot;/system/bin/isn.sh </span><br><span class="line"></span><br><span class="line">&quot; dev=&quot;mmcblk0p38&quot; ino=631 scontext=u:r:ro_isn:s0 tcontext=u:object_r:system_file:s0 tclass=file</span><br></pre></td></tr></table></figure>
<h2 id="8"><a href="#8" class="headerlink" title="8."></a>8.</h2><p>按照如下规则在<strong>ro_isn.te</strong>添加权限<br><strong>SELinux</strong>规则语句一般如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow  A  B:C  D;</span><br></pre></td></tr></table></figure>
<p>可以从log中分别获取ABCD四个参数。<br>比如这行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">warning log：</span><br><span class="line">avc: denied &#123; entrypoint &#125; for pid=272 comm=&quot;init&quot; path=&quot;/system/bin/isn.sh </span><br><span class="line"></span><br><span class="line">&quot; dev=&quot;mmcblk0p38&quot; ino=631 scontext=u:r:ro_isn:s0 tcontext=u:object_r:system_file:s0 tclass=file</span><br><span class="line"></span><br><span class="line">avc:  denied  &#123; transition &#125; for  pid=320 comm=&quot;init&quot; path=&quot;/system/xbin/fcgiserver.sh </span><br><span class="line"></span><br><span class="line">&quot; dev=&quot;mmcblk0p21&quot; ino=7873 scontext=u:r:init:s0 tcontext=u:r:fcgiserver:s0 tclass=process permissive=1</span><br></pre></td></tr></table></figure></p>
<p>那么我们就得出最后的规则是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow qcomsysd  block_device:dir &#123; search &#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow ro_isn system_file:file &#123; entrypoint &#125;;</span><br></pre></td></tr></table></figure>
<p>重复步骤<strong>5-8</strong>,直到没有关于<strong>ro_isn</strong>的<strong>avc: denied log</strong></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2017/03/15/添加SE安全策略/" data-id="cjh0pyi93000t4e0cp15wra3z" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2017/03/15/添加SE安全策略/#comments" class="article-comment-link">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-抓包工具 - Fiddler（如何捕获Android数据包）" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2016/08/03/抓包工具 - Fiddler（如何捕获Android数据包）/">fiddler抓android数据包</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2016/08/03/抓包工具 - Fiddler（如何捕获Android数据包）/">
            <time datetime="2016-08-03T12:20:17.000Z" itemprop="datePublished">2016-08-03</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/android/">android</a>, <a class="tag-link" href="/tags/抓包/">抓包</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="抓包工具-Fiddler（如何捕获Android数据包）"><a href="#抓包工具-Fiddler（如何捕获Android数据包）" class="headerlink" title="抓包工具 - Fiddler（如何捕获Android数据包）"></a>抓包工具 - Fiddler（如何捕获Android数据包）</h2><p>移动设备访问网络原理</p>
<p>先看看移动设备是怎么去访问网络，如图所示，可以看到，移动端的数据包是从wifi出去的。<br><img src="http://i.imgur.com/88ZFpNh.png" alt=""><br>可以看得出，移动端的数据包，都是要走wifi出去，所以我们可以把自己的电脑开启热点，将手机连上电脑，Fiddler开启代理后，让这些数据通过Fiddler，Fiddler就可以抓到这些包，然后发给路由器（如图）：<br><img src="http://i.imgur.com/xpx7qof.png" alt=""></p>
<p>二、Fiddler抓取android数据包所需条件</p>
<p>　　1、电脑需要安装Fiddler</p>
<p>　　2、测试手机需要支持Wifi</p>
<p>　　3、测试手机与电脑需要同一网络</p>
<p>　　4、所测APP需支持代理</p>
<p>　　注：Iphone、Ipad、WinPhone等支持代理手机均适用</p>
<ol>
<li>打开Wifi热点，让手机连上（我这里用的360wifi，其实随意一个都行）<br><img src="http://i.imgur.com/lwCWyI7.png" alt=""></li>
<li>打开Fidder，点击菜单栏中的 [Tools] –&gt; [Fiddler Options]<br><img src="http://i.imgur.com/K87KQ8y.png" alt=""><br>Connections，设置代理端口：8888， 勾选 Allow remote computers to connect，即允许远程计算机连接Fiddler.<blockquote>
<p>注：8888为默认端口号，可修改，但需注意两点，一是本机空闲端口，二是手机代理设置时要与fiddler的端口一致。<br><img src="http://i.imgur.com/gwshRc7.png" alt=""></p>
</blockquote>
</li>
</ol>
<p>3、设置解密HTTPS的网络数据<br>　　Tools –&gt;  Options-&gt; Https，勾选”Decrypt HTTPS traffic”、”Ignore server certificate errors”，<br><img src="http://i.imgur.com/uEHa5dw.png" alt=""></p>
<p>4、查看本机的无线网卡IP<br>　　设置了上面的步骤后，就可以在 Fiddler看到自己本机无线网卡的IP了（要是没有的话，重启Fiddler，或者可以在cmd中ipconfig找到自己的网卡IP，注：一定要开启本机的wifi热点），</p>
<p><img src="http://i.imgur.com/JN06oW7.png" alt=""></p>
<p>也可以在CMD中查看本机网卡的IP，输入命令：ipconfig，<br><img src="http://i.imgur.com/vkKMXHN.png" alt=""></p>
<p>5、手机连接本机的Wifi，并设置代理<br>　　每个品牌的手机设置wifi的方式可能不一样，这里以华为手机为例，如图8所示，将手机连接至PC的wifi</p>
<p><img src="http://i.imgur.com/kkNUd7s.png" alt=""></p>
<p>勾选“显示高级选项”-&gt; 代理 选择“手动” -&gt;输入服务器主机名和服务器端口 -&gt;IP选择“DHCP”-&gt;连接，即完成手机端设置代理操作，如图9所示</p>
<blockquote>
<p>注：服务器主机名：Fiddler所在电脑IP（即开启wifi后，在fiddler或cmd中看到的无线网卡IP地址）<br>　　服务器端口： Fiddler使用的端口（即Options-Connections中设置的端口号）<br><img src="http://i.imgur.com/LxaVORC.png" alt=""></p>
</blockquote>
<p>6、手机下载安装Fiddler证书<br>　　连接上wifi后，手机打开浏览器输入代理IP+端口号（即是本机无线网卡IP，也是手机连接wifi时所设置的服务器主机名，这里的ip+端口号为192.168.191.1：8888），进入fiddler echo service页面，下载Fiddler的证书，如图10所示，点击FiddlerRoot certificate</p>
<p><img src="http://i.imgur.com/7OhLqhq.png" alt=""></p>
<p>下载完成后，进行安装证书</p>
<p><img src="http://i.imgur.com/DvxwP2J.png" alt=""></p>
<p>【注意】：如果打开浏览器碰到类似下面的报错，请打开Fiddler的证书解密模式（如上面的步骤3所示）：No root certificate was found. Have you enabled HTTPS traffic decryption in Fiddler yet?</p>
<p>设置完上面6个步骤后，即表明已设置完毕，此时用手机访问应用，就可以看到fiddler抓取到的数据包了.</p>
<p><img src="http://i.imgur.com/iSn6kTI.png" alt=""></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2016/08/03/抓包工具 - Fiddler（如何捕获Android数据包）/" data-id="cjh0pyi91000n4e0c6u48s79c" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2016/08/03/抓包工具 - Fiddler（如何捕获Android数据包）/#comments" class="article-comment-link">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Linux vi命令使用方法" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2016/07/04/Linux vi命令使用方法/">Linux vi用法</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2016/07/04/Linux vi命令使用方法/">
            <time datetime="2016-07-04T13:11:15.000Z" itemprop="datePublished">2016-07-04</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Linux/">Linux</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/linux命令/">linux命令</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>vi编辑器支持编辑模式和命令模式，编辑模式下可以完成文本的编辑功能，命令模式下可以完成对文件的操作命令，要正确使用vi编辑器就必须熟练掌握着两种模式的切换。默认情况下，打开vi编辑器后自动进入命令模式。从编辑模式切换到命令模式使用“esc”键，从命令模式切换到编辑模式使用“A”、“a”、“O”、“o”、“I”、“i”键。</p>
<p>vi编辑器提供了丰富的内置命令，有些内置命令使用键盘组合键即可完成，有些内置命令则需要以冒号“：”开头输入。常用内置命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Ctrl+u：向文件首翻半屏；</span><br><span class="line">Ctrl+d：向文件尾翻半屏；</span><br><span class="line">Ctrl+f：向文件尾翻一屏；</span><br><span class="line">Ctrl+b：向文件首翻一屏；</span><br><span class="line">Esc：从编辑模式切换到命令模式；</span><br><span class="line">ZZ：命令模式下保存当前文件所做的修改后退出vi；</span><br><span class="line">:行号：光标跳转到指定行的行首；</span><br><span class="line">:$：光标跳转到最后一行的行首；</span><br><span class="line">x或X：删除一个字符，x删除光标后的，而X删除光标前的；</span><br><span class="line">D：删除从当前光标到光标所在行尾的全部字符；</span><br><span class="line">dd：删除光标行正行内容；</span><br><span class="line">ndd：删除当前行及其后n-1行；</span><br><span class="line">nyy：将当前行及其下n行的内容保存到寄存器？中，其中？为一个字母，n为一个数字；</span><br><span class="line">p：粘贴文本操作，用于将缓存区的内容粘贴到当前光标所在位置的下方；</span><br><span class="line">P：粘贴文本操作，用于将缓存区的内容粘贴到当前光标所在位置的上方；</span><br><span class="line">/字符串：文本查找操作，用于从当前光标所在位置开始向文件尾部查找指定字符串的内容，查找的字符串会被加亮显示；</span><br><span class="line">？name：文本查找操作，用于从当前光标所在位置开始向文件头部查找指定字符串的内容，查找的字符串会被加亮显示；</span><br><span class="line">a，bs/F/T：替换文本操作，用于在第a行到第b行之间，将F字符串换成T字符串。其中，“s/”表示进行替换操作；</span><br><span class="line">a：在当前字符后添加文本；</span><br><span class="line">A：在行末添加文本；</span><br><span class="line">i：在当前字符前插入文本；</span><br><span class="line">I：在行首插入文本；</span><br><span class="line">o：在当前行后面插入一空行；</span><br><span class="line">O：在当前行前面插入一空行；</span><br><span class="line">:wq：在命令模式下，执行存盘退出操作；</span><br><span class="line">:w：在命令模式下，执行存盘操作；</span><br><span class="line">:w！：在命令模式下，执行强制存盘操作；</span><br><span class="line">:q：在命令模式下，执行退出vi操作；</span><br><span class="line">:q！：在命令模式下，执行强制退出vi操作；</span><br><span class="line">:e文件名：在命令模式下，打开并编辑指定名称的文件；</span><br><span class="line">:n：在命令模式下，如果同时打开多个文件，则继续编辑下一个文件；</span><br><span class="line">:f：在命令模式下，用于显示当前的文件名、光标所在行的行号以及显示比例；</span><br><span class="line">:set number：在命令模式下，用于在最左端显示行号；</span><br><span class="line">:set nonumber：在命令模式下，用于在最左端不显示行号；</span><br></pre></td></tr></table></figure>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2016/07/04/Linux vi命令使用方法/" data-id="cjh0pyi8g00014e0cy6d0n3kl" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://yoursite.com/2016/07/04/Linux vi命令使用方法/#comments" class="article-comment-link">Comments</a>
    

        </footer>
    </div>
    
</article>



    <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
    </nav>
</section>
            
                
<aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">recent</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/05/10/AnimatedVectorDrawable 总结/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/CoolUI/">CoolUI</a></p>
                            <p class="item-title"><a href="/2018/05/10/AnimatedVectorDrawable 总结/" class="title">AnimatedVectorDrawable总结</a></p>
                            <p class="item-date"><time datetime="2018-05-09T16:51:50.000Z" itemprop="datePublished">2018-05-10</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/04/12/Rxjava2操作符/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
                            <p class="item-title"><a href="/2018/04/12/Rxjava2操作符/" class="title">Rxjava2操作符</a></p>
                            <p class="item-date"><time datetime="2018-04-12T12:20:50.000Z" itemprop="datePublished">2018-04-12</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/03/16/Socket未释放导致的句柄泄露/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/bug记录/">bug记录</a></p>
                            <p class="item-title"><a href="/2018/03/16/Socket未释放导致的句柄泄露/" class="title">socket未释放导致句柄泄露</a></p>
                            <p class="item-date"><time datetime="2018-03-16T11:40:50.000Z" itemprop="datePublished">2018-03-16</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/03/13/线程阻塞和中断的四种方式/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/java基础/">java基础</a></p>
                            <p class="item-title"><a href="/2018/03/13/线程阻塞和中断的四种方式/" class="title">线程阻塞和中断的四种方式</a></p>
                            <p class="item-date"><time datetime="2018-03-13T12:46:25.000Z" itemprop="datePublished">2018-03-13</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/11/mac搭建PyQt5环境/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/python/">python</a></p>
                            <p class="item-title"><a href="/2017/12/11/mac搭建PyQt5环境/" class="title">mac搭建Pyqt5环境</a></p>
                            <p class="item-date"><time datetime="2017-12-11T12:30:50.000Z" itemprop="datePublished">2017-12-11</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">categories</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AOSP/">AOSP</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CoolUI/">CoolUI</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MQTT/">MQTT</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/bug记录/">bug记录</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java基础/">java基础</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/webrtc/">webrtc</a><span class="category-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tags</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AnimatedVectorDrawable/">AnimatedVectorDrawable</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Binder/">Binder</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SEAndroid/">SEAndroid</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/">android</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aosp/">aosp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bugs/">bugs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux命令/">linux命令</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mk/">mk</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mqtt/">mqtt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qt/">qt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rxjava2/">rxjava2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webrtc/">webrtc</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/句柄animation/">句柄animation</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/句柄泄露/">句柄泄露</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程/">多线程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开源框架/">开源框架</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/抓包/">抓包</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编译/">编译</a><span class="tag-list-count">3</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/AnimatedVectorDrawable/" style="font-size: 10px;">AnimatedVectorDrawable</a> <a href="/tags/Binder/" style="font-size: 10px;">Binder</a> <a href="/tags/SEAndroid/" style="font-size: 10px;">SEAndroid</a> <a href="/tags/android/" style="font-size: 20px;">android</a> <a href="/tags/aosp/" style="font-size: 10px;">aosp</a> <a href="/tags/bugs/" style="font-size: 10px;">bugs</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/linux命令/" style="font-size: 10px;">linux命令</a> <a href="/tags/mk/" style="font-size: 10px;">mk</a> <a href="/tags/mqtt/" style="font-size: 10px;">mqtt</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/qt/" style="font-size: 10px;">qt</a> <a href="/tags/rxjava2/" style="font-size: 10px;">rxjava2</a> <a href="/tags/webrtc/" style="font-size: 10px;">webrtc</a> <a href="/tags/句柄animation/" style="font-size: 10px;">句柄animation</a> <a href="/tags/句柄泄露/" style="font-size: 10px;">句柄泄露</a> <a href="/tags/多线程/" style="font-size: 10px;">多线程</a> <a href="/tags/开源框架/" style="font-size: 10px;">开源框架</a> <a href="/tags/抓包/" style="font-size: 10px;">抓包</a> <a href="/tags/编译/" style="font-size: 15px;">编译</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="https://github.com/QuincyJiang">github</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2018 QuincyJiang<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        
    
    
    <!-- 来必力City版安装代码 -->
    <script type="text/javascript">
     (function(d, s) {
         var j, e = d.getElementsByTagName(s)[0];

         if (typeof LivereTower === 'function') { return; }

         j = d.createElement(s);
         j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
         j.async = true;

         e.parentNode.insertBefore(j, e);
     })(document, 'script');
    </script>
  <noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
  <!-- City版安装代码已完成 -->





    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>